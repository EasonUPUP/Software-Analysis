<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - trace.lcov_info_final - tcc-0.9.27-cov/tccpp.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">tcc-0.9.27-cov</a> - tccpp.c<span style="font-size: 80%;"> (source / <a href="tccpp.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">trace.lcov_info_final</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1527</td>
            <td class="headerCovTableEntry">2201</td>
            <td class="headerCovTableEntryLo">69.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-09-17 07:41:43</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">67</td>
            <td class="headerCovTableEntry">84</td>
            <td class="headerCovTableEntryMed">79.8 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *  TCC - Tiny C Compiler
<span class="lineNum">       3 </span>            :  * 
<span class="lineNum">       4 </span>            :  *  Copyright (c) 2001-2004 Fabrice Bellard
<span class="lineNum">       5 </span>            :  *
<span class="lineNum">       6 </span>            :  * This library is free software; you can redistribute it and/or
<span class="lineNum">       7 </span>            :  * modify it under the terms of the GNU Lesser General Public
<span class="lineNum">       8 </span>            :  * License as published by the Free Software Foundation; either
<span class="lineNum">       9 </span>            :  * version 2 of the License, or (at your option) any later version.
<span class="lineNum">      10 </span>            :  *
<span class="lineNum">      11 </span>            :  * This library is distributed in the hope that it will be useful,
<span class="lineNum">      12 </span>            :  * but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      13 </span>            :  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
<span class="lineNum">      14 </span>            :  * Lesser General Public License for more details.
<span class="lineNum">      15 </span>            :  *
<span class="lineNum">      16 </span>            :  * You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      17 </span>            :  * License along with this library; if not, write to the Free Software
<span class="lineNum">      18 </span>            :  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
<span class="lineNum">      19 </span>            :  */
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : #include &quot;tcc.h&quot;
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : /********************************************************/
<span class="lineNum">      24 </span>            : /* global variables */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : ST_DATA int tok_flags;
<span class="lineNum">      27 </span>            : ST_DATA int parse_flags;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : ST_DATA struct BufferedFile *file;
<span class="lineNum">      30 </span>            : ST_DATA int ch, tok;
<span class="lineNum">      31 </span>            : ST_DATA CValue tokc;
<span class="lineNum">      32 </span>            : ST_DATA const int *macro_ptr;
<span class="lineNum">      33 </span>            : ST_DATA CString tokcstr; /* current parsed string, if any */
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : /* display benchmark infos */
<span class="lineNum">      36 </span>            : ST_DATA int total_lines;
<span class="lineNum">      37 </span>            : ST_DATA int total_bytes;
<span class="lineNum">      38 </span>            : ST_DATA int tok_ident;
<span class="lineNum">      39 </span>            : ST_DATA TokenSym **table_ident;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : /* ------------------------------------------------------------------------- */
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : static TokenSym *hash_ident[TOK_HASH_SIZE];
<span class="lineNum">      44 </span>            : static char token_buf[STRING_MAX_SIZE + 1];
<span class="lineNum">      45 </span>            : static CString cstr_buf;
<span class="lineNum">      46 </span>            : static CString macro_equal_buf;
<span class="lineNum">      47 </span>            : static TokenString tokstr_buf;
<span class="lineNum">      48 </span>            : static unsigned char isidnum_table[256 - CH_EOF];
<span class="lineNum">      49 </span>            : static int pp_debug_tok, pp_debug_symv;
<span class="lineNum">      50 </span>            : static int pp_once;
<span class="lineNum">      51 </span>            : static int pp_expr;
<span class="lineNum">      52 </span>            : static int pp_counter;
<span class="lineNum">      53 </span>            : static void tok_print(const char *msg, const int *str);
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : static struct TinyAlloc *toksym_alloc;
<span class="lineNum">      56 </span>            : static struct TinyAlloc *tokstr_alloc;
<span class="lineNum">      57 </span>            : static struct TinyAlloc *cstr_alloc;
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : static TokenString *macro_stack;
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : static const char tcc_keywords[] = 
<span class="lineNum">      62 </span>            : #define DEF(id, str) str &quot;\0&quot;
<span class="lineNum">      63 </span>            : #include &quot;tcctok.h&quot;
<span class="lineNum">      64 </span>            : #undef DEF
<span class="lineNum">      65 </span>            : ;
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            : /* WARNING: the content of this string encodes token numbers */
<span class="lineNum">      68 </span>            : static const unsigned char tok_two_chars[] =
<span class="lineNum">      69 </span>            : /* outdated -- gr
<span class="lineNum">      70 </span>            :     &quot;&lt;=\236&gt;=\235!=\225&amp;&amp;\240||\241++\244--\242==\224&lt;&lt;\1&gt;&gt;\2+=\253&quot;
<span class="lineNum">      71 </span>            :     &quot;-=\255*=\252/=\257%=\245&amp;=\246^=\336|=\374-&gt;\313..\250##\266&quot;;
<span class="lineNum">      72 </span>            : */{
<span class="lineNum">      73 </span>            :     '&lt;','=', TOK_LE,
<span class="lineNum">      74 </span>            :     '&gt;','=', TOK_GE,
<span class="lineNum">      75 </span>            :     '!','=', TOK_NE,
<span class="lineNum">      76 </span>            :     '&amp;','&amp;', TOK_LAND,
<span class="lineNum">      77 </span>            :     '|','|', TOK_LOR,
<span class="lineNum">      78 </span>            :     '+','+', TOK_INC,
<span class="lineNum">      79 </span>            :     '-','-', TOK_DEC,
<span class="lineNum">      80 </span>            :     '=','=', TOK_EQ,
<span class="lineNum">      81 </span>            :     '&lt;','&lt;', TOK_SHL,
<span class="lineNum">      82 </span>            :     '&gt;','&gt;', TOK_SAR,
<span class="lineNum">      83 </span>            :     '+','=', TOK_A_ADD,
<span class="lineNum">      84 </span>            :     '-','=', TOK_A_SUB,
<span class="lineNum">      85 </span>            :     '*','=', TOK_A_MUL,
<span class="lineNum">      86 </span>            :     '/','=', TOK_A_DIV,
<span class="lineNum">      87 </span>            :     '%','=', TOK_A_MOD,
<span class="lineNum">      88 </span>            :     '&amp;','=', TOK_A_AND,
<span class="lineNum">      89 </span>            :     '^','=', TOK_A_XOR,
<span class="lineNum">      90 </span>            :     '|','=', TOK_A_OR,
<span class="lineNum">      91 </span>            :     '-','&gt;', TOK_ARROW,
<span class="lineNum">      92 </span>            :     '.','.', TOK_TWODOTS,
<span class="lineNum">      93 </span>            :     '#','#', TOK_TWOSHARPS,
<span class="lineNum">      94 </span>            :     0
<span class="lineNum">      95 </span>            : };
<span class="lineNum">      96 </span>            : 
<a name="97"><span class="lineNum">      97 </span>            : static void next_nomacro_spc(void);</a>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">     201997 : ST_FUNC void skip(int c)</span>
<span class="lineNum">     100 </span>            : {
<span class="lineNum">     101 </span><span class="lineCov">     201997 :     if (tok != c)</span>
<span class="lineNum">     102 </span><span class="lineCov">        108 :         tcc_error(&quot;'%c' expected (got \&quot;%s\&quot;)&quot;, c, get_tok_str(tok, &amp;tokc));</span>
<span class="lineNum">     103 </span><span class="lineCov">     201889 :     next();</span>
<a name="104"><span class="lineNum">     104 </span><span class="lineCov">     201880 : }</span></a>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineCov">        160 : ST_FUNC void expect(const char *msg)</span>
<span class="lineNum">     107 </span>            : {
<span class="lineNum">     108 </span><span class="lineCov">        160 :     tcc_error(&quot;%s expected&quot;, msg);</span>
<span class="lineNum">     109 </span>            : }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            : /* ------------------------------------------------------------------------- */
<span class="lineNum">     112 </span>            : /* Custom allocator for tiny objects */
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span>            : #define USE_TAL
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            : #ifndef USE_TAL
<span class="lineNum">     117 </span>            : #define tal_free(al, p) tcc_free(p)
<span class="lineNum">     118 </span>            : #define tal_realloc(al, p, size) tcc_realloc(p, size)
<span class="lineNum">     119 </span>            : #define tal_new(a,b,c)
<span class="lineNum">     120 </span>            : #define tal_delete(a)
<span class="lineNum">     121 </span>            : #else
<span class="lineNum">     122 </span>            : #if !defined(MEM_DEBUG)
<span class="lineNum">     123 </span>            : #define tal_free(al, p) tal_free_impl(al, p)
<span class="lineNum">     124 </span>            : #define tal_realloc(al, p, size) tal_realloc_impl(&amp;al, p, size)
<span class="lineNum">     125 </span>            : #define TAL_DEBUG_PARAMS
<span class="lineNum">     126 </span>            : #else
<span class="lineNum">     127 </span>            : #define TAL_DEBUG 1
<span class="lineNum">     128 </span>            : //#define TAL_INFO 1 /* collect and dump allocators stats */
<span class="lineNum">     129 </span>            : #define tal_free(al, p) tal_free_impl(al, p, __FILE__, __LINE__)
<span class="lineNum">     130 </span>            : #define tal_realloc(al, p, size) tal_realloc_impl(&amp;al, p, size, __FILE__, __LINE__)
<span class="lineNum">     131 </span>            : #define TAL_DEBUG_PARAMS , const char *file, int line
<span class="lineNum">     132 </span>            : #define TAL_DEBUG_FILE_LEN 40
<span class="lineNum">     133 </span>            : #endif
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span>            : #define TOKSYM_TAL_SIZE     (768 * 1024) /* allocator for tiny TokenSym in table_ident */
<span class="lineNum">     136 </span>            : #define TOKSTR_TAL_SIZE     (768 * 1024) /* allocator for tiny TokenString instances */
<span class="lineNum">     137 </span>            : #define CSTR_TAL_SIZE       (256 * 1024) /* allocator for tiny CString instances */
<span class="lineNum">     138 </span>            : #define TOKSYM_TAL_LIMIT    256 /* prefer unique limits to distinguish allocators debug msgs */
<span class="lineNum">     139 </span>            : #define TOKSTR_TAL_LIMIT    128 /* 32 * sizeof(int) */
<span class="lineNum">     140 </span>            : #define CSTR_TAL_LIMIT      1024
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span>            : typedef struct TinyAlloc {
<span class="lineNum">     143 </span>            :     unsigned  limit;
<span class="lineNum">     144 </span>            :     unsigned  size;
<span class="lineNum">     145 </span>            :     uint8_t *buffer;
<span class="lineNum">     146 </span>            :     uint8_t *p;
<span class="lineNum">     147 </span>            :     unsigned  nb_allocs;
<span class="lineNum">     148 </span>            :     struct TinyAlloc *next, *top;
<span class="lineNum">     149 </span>            : #ifdef TAL_INFO
<span class="lineNum">     150 </span>            :     unsigned  nb_peak;
<span class="lineNum">     151 </span>            :     unsigned  nb_total;
<span class="lineNum">     152 </span>            :     unsigned  nb_missed;
<span class="lineNum">     153 </span>            :     uint8_t *peak_p;
<span class="lineNum">     154 </span>            : #endif
<span class="lineNum">     155 </span>            : } TinyAlloc;
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            : typedef struct tal_header_t {
<span class="lineNum">     158 </span>            :     unsigned  size;
<span class="lineNum">     159 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     160 </span>            :     int     line_num; /* negative line_num used for double free check */
<span class="lineNum">     161 </span>            :     char    file_name[TAL_DEBUG_FILE_LEN + 1];
<span class="lineNum">     162 </span>            : #endif
<span class="lineNum">     163 </span>            : } tal_header_t;
<span class="lineNum">     164 </span>            : 
<a name="165"><span class="lineNum">     165 </span>            : /* ------------------------------------------------------------------------- */</a>
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span><span class="lineCov">       5021 : static TinyAlloc *tal_new(TinyAlloc **pal, unsigned limit, unsigned size)</span>
<span class="lineNum">     168 </span>            : {
<span class="lineNum">     169 </span><span class="lineCov">       5021 :     TinyAlloc *al = tcc_mallocz(sizeof(TinyAlloc));</span>
<span class="lineNum">     170 </span><span class="lineCov">       5021 :     al-&gt;p = al-&gt;buffer = tcc_malloc(size);</span>
<span class="lineNum">     171 </span><span class="lineCov">       5021 :     al-&gt;limit = limit;</span>
<span class="lineNum">     172 </span><span class="lineCov">       5021 :     al-&gt;size = size;</span>
<span class="lineNum">     173 </span><span class="lineCov">       5021 :     if (pal) *pal = al;</span>
<span class="lineNum">     174 </span><span class="lineCov">       5021 :     return al;</span>
<a name="175"><span class="lineNum">     175 </span>            : }</a>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineCov">      10037 : static void tal_delete(TinyAlloc *al)</span>
<span class="lineNum">     178 </span>            : {
<span class="lineNum">     179 </span>            :     TinyAlloc *next;
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            : tail_call:
<span class="lineNum">     182 </span><span class="lineCov">      10037 :     if (!al)</span>
<span class="lineNum">     183 </span><span class="lineCov">      10032 :         return;</span>
<span class="lineNum">     184 </span>            : #ifdef TAL_INFO
<span class="lineNum">     185 </span>            :     fprintf(stderr, &quot;limit=%5d, size=%5g MB, nb_peak=%6d, nb_total=%8d, nb_missed=%6d, usage=%5.1f%%\n&quot;,
<span class="lineNum">     186 </span>            :             al-&gt;limit, al-&gt;size / 1024.0 / 1024.0, al-&gt;nb_peak, al-&gt;nb_total, al-&gt;nb_missed,
<span class="lineNum">     187 </span>            :             (al-&gt;peak_p - al-&gt;buffer) * 100.0 / al-&gt;size);
<span class="lineNum">     188 </span>            : #endif
<span class="lineNum">     189 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     190 </span>            :     if (al-&gt;nb_allocs &gt; 0) {
<span class="lineNum">     191 </span>            :         uint8_t *p;
<span class="lineNum">     192 </span>            :         fprintf(stderr, &quot;TAL_DEBUG: memory leak %d chunk(s) (limit= %d)\n&quot;,
<span class="lineNum">     193 </span>            :                 al-&gt;nb_allocs, al-&gt;limit);
<span class="lineNum">     194 </span>            :         p = al-&gt;buffer;
<span class="lineNum">     195 </span>            :         while (p &lt; al-&gt;p) {
<span class="lineNum">     196 </span>            :             tal_header_t *header = (tal_header_t *)p;
<span class="lineNum">     197 </span>            :             if (header-&gt;line_num &gt; 0) {
<span class="lineNum">     198 </span>            :                 fprintf(stderr, &quot;%s:%d: chunk of %d bytes leaked\n&quot;,
<span class="lineNum">     199 </span>            :                         header-&gt;file_name, header-&gt;line_num, header-&gt;size);
<span class="lineNum">     200 </span>            :             }
<span class="lineNum">     201 </span>            :             p += header-&gt;size + sizeof(tal_header_t);
<span class="lineNum">     202 </span>            :         }
<span class="lineNum">     203 </span>            : #if MEM_DEBUG-0 == 2
<span class="lineNum">     204 </span>            :         exit(2);
<span class="lineNum">     205 </span>            : #endif
<span class="lineNum">     206 </span>            :     }
<span class="lineNum">     207 </span>            : #endif
<span class="lineNum">     208 </span><span class="lineCov">       5021 :     next = al-&gt;next;</span>
<span class="lineNum">     209 </span><span class="lineCov">       5021 :     tcc_free(al-&gt;buffer);</span>
<span class="lineNum">     210 </span><span class="lineCov">       5021 :     tcc_free(al);</span>
<span class="lineNum">     211 </span><span class="lineCov">       5021 :     al = next;</span>
<span class="lineNum">     212 </span><span class="lineCov">       5021 :     goto tail_call;</span>
<a name="213"><span class="lineNum">     213 </span>            : }</a>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineCov">    2334038 : static void tal_free_impl(TinyAlloc *al, void *p TAL_DEBUG_PARAMS)</span>
<span class="lineNum">     216 </span>            : {
<span class="lineNum">     217 </span><span class="lineCov">    2334038 :     if (!p)</span>
<span class="lineNum">     218 </span><span class="lineCov">      52992 :         return;</span>
<span class="lineNum">     219 </span>            : tail_call:
<span class="lineNum">     220 </span><span class="lineCov">    2283396 :     if (al-&gt;buffer &lt;= (uint8_t *)p &amp;&amp; (uint8_t *)p &lt; al-&gt;buffer + al-&gt;size) {</span>
<span class="lineNum">     221 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     222 </span>            :         tal_header_t *header = (((tal_header_t *)p) - 1);
<span class="lineNum">     223 </span>            :         if (header-&gt;line_num &lt; 0) {
<span class="lineNum">     224 </span>            :             fprintf(stderr, &quot;%s:%d: TAL_DEBUG: double frees chunk from\n&quot;,
<span class="lineNum">     225 </span>            :                     file, line);
<span class="lineNum">     226 </span>            :             fprintf(stderr, &quot;%s:%d: %d bytes\n&quot;,
<span class="lineNum">     227 </span>            :                     header-&gt;file_name, (int)-header-&gt;line_num, (int)header-&gt;size);
<span class="lineNum">     228 </span>            :         } else
<span class="lineNum">     229 </span>            :             header-&gt;line_num = -header-&gt;line_num;
<span class="lineNum">     230 </span>            : #endif
<span class="lineNum">     231 </span><span class="lineCov">    2272424 :         al-&gt;nb_allocs--;</span>
<span class="lineNum">     232 </span><span class="lineCov">    4544848 :         if (!al-&gt;nb_allocs)</span>
<span class="lineNum">     233 </span><span class="lineCov">       5961 :             al-&gt;p = al-&gt;buffer;</span>
<span class="lineNum">     234 </span><span class="lineCov">      10972 :     } else if (al-&gt;next) {</span>
<span class="lineNum">     235 </span><span class="lineCov">       2350 :         al = al-&gt;next;</span>
<span class="lineNum">     236 </span><span class="lineCov">       2350 :         goto tail_call;</span>
<span class="lineNum">     237 </span>            :     }
<span class="lineNum">     238 </span>            :     else
<span class="lineNum">     239 </span><span class="lineCov">       8622 :         tcc_free(p);</span>
<a name="240"><span class="lineNum">     240 </span>            : }</a>
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineCov">    2360751 : static void *tal_realloc_impl(TinyAlloc **pal, void *p, unsigned size TAL_DEBUG_PARAMS)</span>
<span class="lineNum">     243 </span>            : {
<span class="lineNum">     244 </span>            :     tal_header_t *header;
<span class="lineNum">     245 </span>            :     void *ret;
<span class="lineNum">     246 </span>            :     int is_own;
<span class="lineNum">     247 </span><span class="lineCov">    2360751 :     unsigned adj_size = (size + 3) &amp; -4;</span>
<span class="lineNum">     248 </span><span class="lineCov">    2360751 :     TinyAlloc *al = *pal;</span>
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span>            : tail_call:
<span class="lineNum">     251 </span><span class="lineCov">    2360911 :     is_own = (al-&gt;buffer &lt;= (uint8_t *)p &amp;&amp; (uint8_t *)p &lt; al-&gt;buffer + al-&gt;size);</span>
<span class="lineNum">     252 </span><span class="lineCov">    2360911 :     if ((!p || is_own) &amp;&amp; size &lt;= al-&gt;limit) {</span>
<span class="lineNum">     253 </span><span class="lineCov">    2351879 :         if (al-&gt;p + adj_size + sizeof(tal_header_t) &lt; al-&gt;buffer + al-&gt;size) {</span>
<span class="lineNum">     254 </span><span class="lineCov">    2351869 :             header = (tal_header_t *)al-&gt;p;</span>
<span class="lineNum">     255 </span><span class="lineCov">    2351869 :             header-&gt;size = adj_size;</span>
<span class="lineNum">     256 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     257 </span>            :             { int ofs = strlen(file) - TAL_DEBUG_FILE_LEN;
<span class="lineNum">     258 </span>            :             strncpy(header-&gt;file_name, file + (ofs &gt; 0 ? ofs : 0), TAL_DEBUG_FILE_LEN);
<span class="lineNum">     259 </span>            :             header-&gt;file_name[TAL_DEBUG_FILE_LEN] = 0;
<span class="lineNum">     260 </span>            :             header-&gt;line_num = line; }
<span class="lineNum">     261 </span>            : #endif
<span class="lineNum">     262 </span><span class="lineCov">    2351869 :             ret = al-&gt;p + sizeof(tal_header_t);</span>
<span class="lineNum">     263 </span><span class="lineCov">    2351869 :             al-&gt;p += adj_size + sizeof(tal_header_t);</span>
<span class="lineNum">     264 </span><span class="lineCov">    2351869 :             if (is_own) {</span>
<span class="lineNum">     265 </span><span class="lineCov">      74616 :                 header = (((tal_header_t *)p) - 1);</span>
<span class="lineNum">     266 </span><span class="lineCov">      74616 :                 memcpy(ret, p, header-&gt;size);</span>
<span class="lineNum">     267 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     268 </span>            :                 header-&gt;line_num = -header-&gt;line_num;
<span class="lineNum">     269 </span>            : #endif
<span class="lineNum">     270 </span>            :             } else {
<span class="lineNum">     271 </span><span class="lineCov">    2277253 :                 al-&gt;nb_allocs++;</span>
<span class="lineNum">     272 </span>            :             }
<span class="lineNum">     273 </span>            : #ifdef TAL_INFO
<span class="lineNum">     274 </span>            :             if (al-&gt;nb_peak &lt; al-&gt;nb_allocs)
<span class="lineNum">     275 </span>            :                 al-&gt;nb_peak = al-&gt;nb_allocs;
<span class="lineNum">     276 </span>            :             if (al-&gt;peak_p &lt; al-&gt;p)
<span class="lineNum">     277 </span>            :                 al-&gt;peak_p = al-&gt;p;
<span class="lineNum">     278 </span>            :             al-&gt;nb_total++;
<span class="lineNum">     279 </span>            : #endif
<span class="lineNum">     280 </span><span class="lineCov">    2351869 :             return ret;</span>
<span class="lineNum">     281 </span><span class="lineCov">         10 :         } else if (is_own) {</span>
<span class="lineNum">     282 </span><span class="lineCov">          5 :             al-&gt;nb_allocs--;</span>
<span class="lineNum">     283 </span><span class="lineCov">          5 :             ret = tal_realloc(*pal, 0, size);</span>
<span class="lineNum">     284 </span><span class="lineCov">          5 :             header = (((tal_header_t *)p) - 1);</span>
<span class="lineNum">     285 </span><span class="lineCov">          5 :             memcpy(ret, p, header-&gt;size);</span>
<span class="lineNum">     286 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     287 </span>            :             header-&gt;line_num = -header-&gt;line_num;
<span class="lineNum">     288 </span>            : #endif
<span class="lineNum">     289 </span><span class="lineCov">          5 :             return ret;</span>
<span class="lineNum">     290 </span>            :         }
<span class="lineNum">     291 </span><span class="lineCov">          5 :         if (al-&gt;next) {</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :             al = al-&gt;next;</span>
<span class="lineNum">     293 </span>            :         } else {
<span class="lineNum">     294 </span><span class="lineCov">          5 :             TinyAlloc *bottom = al, *next = al-&gt;top ? al-&gt;top : al;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">          5 :             al = tal_new(pal, next-&gt;limit, next-&gt;size * 2);</span>
<span class="lineNum">     297 </span><span class="lineCov">          5 :             al-&gt;next = next;</span>
<span class="lineNum">     298 </span><span class="lineCov">          5 :             bottom-&gt;top = al;</span>
<span class="lineNum">     299 </span>            :         }
<span class="lineNum">     300 </span><span class="lineCov">          5 :         goto tail_call;</span>
<span class="lineNum">     301 </span>            :     }
<span class="lineNum">     302 </span><span class="lineCov">       9032 :     if (is_own) {</span>
<span class="lineNum">     303 </span><span class="lineCov">       4824 :         al-&gt;nb_allocs--;</span>
<span class="lineNum">     304 </span><span class="lineCov">       4824 :         ret = tcc_malloc(size);</span>
<span class="lineNum">     305 </span><span class="lineCov">       4824 :         header = (((tal_header_t *)p) - 1);</span>
<span class="lineNum">     306 </span><span class="lineCov">       4824 :         memcpy(ret, p, header-&gt;size);</span>
<span class="lineNum">     307 </span>            : #ifdef TAL_DEBUG
<span class="lineNum">     308 </span>            :         header-&gt;line_num = -header-&gt;line_num;
<span class="lineNum">     309 </span>            : #endif
<span class="lineNum">     310 </span><span class="lineCov">       4208 :     } else if (al-&gt;next) {</span>
<span class="lineNum">     311 </span><span class="lineCov">        155 :         al = al-&gt;next;</span>
<span class="lineNum">     312 </span><span class="lineCov">        155 :         goto tail_call;</span>
<span class="lineNum">     313 </span>            :     } else
<span class="lineNum">     314 </span><span class="lineCov">       4053 :         ret = tcc_realloc(p, size);</span>
<span class="lineNum">     315 </span>            : #ifdef TAL_INFO
<span class="lineNum">     316 </span>            :     al-&gt;nb_missed++;
<span class="lineNum">     317 </span>            : #endif
<span class="lineNum">     318 </span><span class="lineCov">       8877 :     return ret;</span>
<span class="lineNum">     319 </span>            : }
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span>            : #endif /* USE_TAL */
<span class="lineNum">     322 </span>            : 
<a name="323"><span class="lineNum">     323 </span>            : /* ------------------------------------------------------------------------- */</a>
<span class="lineNum">     324 </span>            : /* CString handling */
<span class="lineNum">     325 </span><span class="lineCov">      84907 : static void cstr_realloc(CString *cstr, int new_size)</span>
<span class="lineNum">     326 </span>            : {
<span class="lineNum">     327 </span>            :     int size;
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineCov">      84907 :     size = cstr-&gt;size_allocated;</span>
<span class="lineNum">     330 </span><span class="lineCov">      84907 :     if (size &lt; 8)</span>
<span class="lineNum">     331 </span><span class="lineCov">      35893 :         size = 8; /* no need to allocate a too small first string */</span>
<span class="lineNum">     332 </span><span class="lineCov">     243177 :     while (size &lt; new_size)</span>
<span class="lineNum">     333 </span><span class="lineCov">      73363 :         size = size * 2;</span>
<span class="lineNum">     334 </span><span class="lineCov">      84907 :     cstr-&gt;data = tal_realloc(cstr_alloc, cstr-&gt;data, size);</span>
<span class="lineNum">     335 </span><span class="lineCov">      84907 :     cstr-&gt;size_allocated = size;</span>
<span class="lineNum">     336 </span><span class="lineCov">      84907 : }</span>
<a name="337"><span class="lineNum">     337 </span>            : </a>
<span class="lineNum">     338 </span>            : /* add a byte */
<span class="lineNum">     339 </span><span class="lineCov">    1507074 : ST_INLN void cstr_ccat(CString *cstr, int ch)</span>
<span class="lineNum">     340 </span>            : {
<span class="lineNum">     341 </span>            :     int size;
<span class="lineNum">     342 </span><span class="lineCov">    1507074 :     size = cstr-&gt;size + 1;</span>
<span class="lineNum">     343 </span><span class="lineCov">    1507074 :     if (size &gt; cstr-&gt;size_allocated)</span>
<span class="lineNum">     344 </span><span class="lineCov">      70822 :         cstr_realloc(cstr, size);</span>
<span class="lineNum">     345 </span><span class="lineCov">    1507074 :     ((unsigned char *)cstr-&gt;data)[size - 1] = ch;</span>
<span class="lineNum">     346 </span><span class="lineCov">    1507074 :     cstr-&gt;size = size;</span>
<a name="347"><span class="lineNum">     347 </span><span class="lineCov">    1507074 : }</span></a>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineCov">      28011 : ST_FUNC void cstr_cat(CString *cstr, const char *str, int len)</span>
<span class="lineNum">     350 </span>            : {
<span class="lineNum">     351 </span>            :     int size;
<span class="lineNum">     352 </span><span class="lineCov">      28011 :     if (len &lt;= 0)</span>
<span class="lineNum">     353 </span><span class="lineCov">      17204 :         len = strlen(str) + 1 + len;</span>
<span class="lineNum">     354 </span><span class="lineCov">      28011 :     size = cstr-&gt;size + len;</span>
<span class="lineNum">     355 </span><span class="lineCov">      28011 :     if (size &gt; cstr-&gt;size_allocated)</span>
<span class="lineNum">     356 </span><span class="lineCov">      12413 :         cstr_realloc(cstr, size);</span>
<span class="lineNum">     357 </span><span class="lineCov">      28011 :     memmove(((unsigned char *)cstr-&gt;data) + cstr-&gt;size, str, len);</span>
<span class="lineNum">     358 </span><span class="lineCov">      28011 :     cstr-&gt;size = size;</span>
<span class="lineNum">     359 </span><span class="lineCov">      28011 : }</span>
<a name="360"><span class="lineNum">     360 </span>            : </a>
<span class="lineNum">     361 </span>            : /* add a wide char */
<span class="lineNum">     362 </span><span class="lineNoCov">          0 : ST_FUNC void cstr_wccat(CString *cstr, int ch)</span>
<span class="lineNum">     363 </span>            : {
<span class="lineNum">     364 </span>            :     int size;
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     size = cstr-&gt;size + sizeof(nwchar_t);</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     if (size &gt; cstr-&gt;size_allocated)</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         cstr_realloc(cstr, size);</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     *(nwchar_t *)(((unsigned char *)cstr-&gt;data) + size - sizeof(nwchar_t)) = ch;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     cstr-&gt;size = size;</span>
<a name="370"><span class="lineNum">     370 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineCov">      72798 : ST_FUNC void cstr_new(CString *cstr)</span>
<span class="lineNum">     373 </span>            : {
<span class="lineNum">     374 </span><span class="lineCov">      72798 :     memset(cstr, 0, sizeof(CString));</span>
<span class="lineNum">     375 </span><span class="lineCov">      72798 : }</span>
<a name="376"><span class="lineNum">     376 </span>            : </a>
<span class="lineNum">     377 </span>            : /* free string and reset it to NULL */
<span class="lineNum">     378 </span><span class="lineCov">      37235 : ST_FUNC void cstr_free(CString *cstr)</span>
<span class="lineNum">     379 </span>            : {
<span class="lineNum">     380 </span><span class="lineCov">      37235 :     tal_free(cstr_alloc, cstr-&gt;data);</span>
<span class="lineNum">     381 </span><span class="lineCov">      37235 :     cstr_new(cstr);</span>
<span class="lineNum">     382 </span><span class="lineCov">      37235 : }</span>
<a name="383"><span class="lineNum">     383 </span>            : </a>
<span class="lineNum">     384 </span>            : /* reset string to empty */
<span class="lineNum">     385 </span><span class="lineCov">     135608 : ST_FUNC void cstr_reset(CString *cstr)</span>
<span class="lineNum">     386 </span>            : {
<span class="lineNum">     387 </span><span class="lineCov">     135608 :     cstr-&gt;size = 0;</span>
<span class="lineNum">     388 </span><span class="lineCov">     135608 : }</span>
<a name="389"><span class="lineNum">     389 </span>            : </a>
<span class="lineNum">     390 </span>            : /* XXX: unicode ? */
<span class="lineNum">     391 </span><span class="lineNoCov">          0 : static void add_char(CString *cstr, int c)</span>
<span class="lineNum">     392 </span>            : {
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     if (c == '\'' || c == '\&quot;' || c == '\\') {</span>
<span class="lineNum">     394 </span>            :         /* XXX: could be more precise if char or string */
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         cstr_ccat(cstr, '\\');</span>
<span class="lineNum">     396 </span>            :     }
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     if (c &gt;= 32 &amp;&amp; c &lt;= 126) {</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         cstr_ccat(cstr, c);</span>
<span class="lineNum">     399 </span>            :     } else {
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         cstr_ccat(cstr, '\\');</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         if (c == '\n') {</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :             cstr_ccat(cstr, 'n');</span>
<span class="lineNum">     403 </span>            :         } else {
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :             cstr_ccat(cstr, '0' + ((c &gt;&gt; 6) &amp; 7));</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :             cstr_ccat(cstr, '0' + ((c &gt;&gt; 3) &amp; 7));</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :             cstr_ccat(cstr, '0' + (c &amp; 7));</span>
<span class="lineNum">     407 </span>            :         }
<span class="lineNum">     408 </span>            :     }
<span class="lineNum">     409 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     410 </span>            : 
<a name="411"><span class="lineNum">     411 </span>            : /* ------------------------------------------------------------------------- */</a>
<span class="lineNum">     412 </span>            : /* allocate a new token */
<span class="lineNum">     413 </span><span class="lineCov">    1917512 : static TokenSym *tok_alloc_new(TokenSym **pts, const char *str, int len)</span>
<span class="lineNum">     414 </span>            : {
<span class="lineNum">     415 </span>            :     TokenSym *ts, **ptable;
<span class="lineNum">     416 </span>            :     int i;
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">    1917512 :     if (tok_ident &gt;= SYM_FIRST_ANOM) </span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         tcc_error(&quot;memory full (symbols)&quot;);</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span>            :     /* expand token table if needed */
<span class="lineNum">     422 </span><span class="lineCov">    1917512 :     i = tok_ident - TOK_IDENT;</span>
<span class="lineNum">     423 </span><span class="lineCov">    1917512 :     if ((i % TOK_ALLOC_INCR) == 0) {</span>
<span class="lineNum">     424 </span><span class="lineCov">       4017 :         ptable = tcc_realloc(table_ident, (i + TOK_ALLOC_INCR) * sizeof(TokenSym *));</span>
<span class="lineNum">     425 </span><span class="lineCov">       4017 :         table_ident = ptable;</span>
<span class="lineNum">     426 </span>            :     }
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineCov">    1917512 :     ts = tal_realloc(toksym_alloc, 0, sizeof(TokenSym) + len);</span>
<span class="lineNum">     429 </span><span class="lineCov">    1917512 :     table_ident[i] = ts;</span>
<span class="lineNum">     430 </span><span class="lineCov">    1917512 :     ts-&gt;tok = tok_ident++;</span>
<span class="lineNum">     431 </span><span class="lineCov">    1917512 :     ts-&gt;sym_define = NULL;</span>
<span class="lineNum">     432 </span><span class="lineCov">    1917512 :     ts-&gt;sym_label = NULL;</span>
<span class="lineNum">     433 </span><span class="lineCov">    1917512 :     ts-&gt;sym_struct = NULL;</span>
<span class="lineNum">     434 </span><span class="lineCov">    1917512 :     ts-&gt;sym_identifier = NULL;</span>
<span class="lineNum">     435 </span><span class="lineCov">    1917512 :     ts-&gt;len = len;</span>
<span class="lineNum">     436 </span><span class="lineCov">    1917512 :     ts-&gt;hash_next = NULL;</span>
<span class="lineNum">     437 </span><span class="lineCov">    1917512 :     memcpy(ts-&gt;str, str, len);</span>
<span class="lineNum">     438 </span><span class="lineCov">    1917512 :     ts-&gt;str[len] = '\0';</span>
<span class="lineNum">     439 </span><span class="lineCov">    1917512 :     *pts = ts;</span>
<span class="lineNum">     440 </span><span class="lineCov">    1917512 :     return ts;</span>
<span class="lineNum">     441 </span>            : }
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            : #define TOK_HASH_INIT 1
<span class="lineNum">     444 </span>            : #define TOK_HASH_FUNC(h, c) ((h) + ((h) &lt;&lt; 5) + ((h) &gt;&gt; 27) + (c))
<span class="lineNum">     445 </span>            : 
<a name="446"><span class="lineNum">     446 </span>            : </a>
<span class="lineNum">     447 </span>            : /* find a token and add it if not found */
<span class="lineNum">     448 </span><span class="lineCov">    1668066 : ST_FUNC TokenSym *tok_alloc(const char *str, int len)</span>
<span class="lineNum">     449 </span>            : {
<span class="lineNum">     450 </span>            :     TokenSym *ts, **pts;
<span class="lineNum">     451 </span>            :     int i;
<span class="lineNum">     452 </span>            :     unsigned int h;
<span class="lineNum">     453 </span>            :     
<span class="lineNum">     454 </span><span class="lineCov">    1668066 :     h = TOK_HASH_INIT;</span>
<span class="lineNum">     455 </span><span class="lineCov">   11119025 :     for(i=0;i&lt;len;i++)</span>
<span class="lineNum">     456 </span><span class="lineCov">    9450959 :         h = TOK_HASH_FUNC(h, ((unsigned char *)str)[i]);</span>
<span class="lineNum">     457 </span><span class="lineCov">    1668066 :     h &amp;= (TOK_HASH_SIZE - 1);</span>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span><span class="lineCov">    1668066 :     pts = &amp;hash_ident[h];</span>
<span class="lineNum">     460 </span>            :     for(;;) {
<span class="lineNum">     461 </span><span class="lineCov">    1725248 :         ts = *pts;</span>
<span class="lineNum">     462 </span><span class="lineCov">    1725248 :         if (!ts)</span>
<span class="lineNum">     463 </span><span class="lineCov">    1657364 :             break;</span>
<span class="lineNum">     464 </span><span class="lineCov">      67884 :         if (ts-&gt;len == len &amp;&amp; !memcmp(ts-&gt;str, str, len))</span>
<span class="lineNum">     465 </span><span class="lineCov">      10702 :             return ts;</span>
<span class="lineNum">     466 </span><span class="lineCov">      57182 :         pts = &amp;(ts-&gt;hash_next);</span>
<span class="lineNum">     467 </span><span class="lineCov">      57182 :     }</span>
<span class="lineNum">     468 </span><span class="lineCov">    1657364 :     return tok_alloc_new(pts, str, len);</span>
<span class="lineNum">     469 </span>            : }
<span class="lineNum">     470 </span>            : 
<a name="471"><span class="lineNum">     471 </span>            : /* XXX: buffer overflow */</a>
<span class="lineNum">     472 </span>            : /* XXX: float tokens */
<span class="lineNum">     473 </span><span class="lineCov">      14899 : ST_FUNC const char *get_tok_str(int v, CValue *cv)</span>
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span>            :     char *p;
<span class="lineNum">     476 </span>            :     int i, len;
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineCov">      14899 :     cstr_reset(&amp;cstr_buf);</span>
<span class="lineNum">     479 </span><span class="lineCov">      14899 :     p = cstr_buf.data;</span>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineCov">      14899 :     switch(v) {</span>
<span class="lineNum">     482 </span>            :     case TOK_CINT:
<span class="lineNum">     483 </span>            :     case TOK_CUINT:
<span class="lineNum">     484 </span>            :     case TOK_CLONG:
<span class="lineNum">     485 </span>            :     case TOK_CULONG:
<span class="lineNum">     486 </span>            :     case TOK_CLLONG:
<span class="lineNum">     487 </span>            :     case TOK_CULLONG:
<span class="lineNum">     488 </span>            :         /* XXX: not quite exact, but only useful for testing  */
<span class="lineNum">     489 </span>            : #ifdef _WIN32
<span class="lineNum">     490 </span>            :         sprintf(p, &quot;%u&quot;, (unsigned)cv-&gt;i);
<span class="lineNum">     491 </span>            : #else
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :         sprintf(p, &quot;%llu&quot;, (unsigned long long)cv-&gt;i);</span>
<span class="lineNum">     493 </span>            : #endif
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     495 </span>            :     case TOK_LCHAR:
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, 'L');</span>
<span class="lineNum">     497 </span>            :     case TOK_CCHAR:
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\'');</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         add_char(&amp;cstr_buf, cv-&gt;i);</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\'');</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\0');</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     503 </span>            :     case TOK_PPNUM:
<span class="lineNum">     504 </span>            :     case TOK_PPSTR:
<span class="lineNum">     505 </span><span class="lineCov">       2154 :         return (char*)cv-&gt;str.data;</span>
<span class="lineNum">     506 </span>            :     case TOK_LSTR:
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, 'L');</span>
<span class="lineNum">     508 </span>            :     case TOK_STR:
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\&quot;');</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :         if (v == TOK_STR) {</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :             len = cv-&gt;str.size - 1;</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :             for(i=0;i&lt;len;i++)</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                 add_char(&amp;cstr_buf, ((unsigned char *)cv-&gt;str.data)[i]);</span>
<span class="lineNum">     514 </span>            :         } else {
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :             len = (cv-&gt;str.size / sizeof(nwchar_t)) - 1;</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :             for(i=0;i&lt;len;i++)</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                 add_char(&amp;cstr_buf, ((nwchar_t *)cv-&gt;str.data)[i]);</span>
<span class="lineNum">     518 </span>            :         }
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\&quot;');</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :         cstr_ccat(&amp;cstr_buf, '\0');</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :     case TOK_CFLOAT:
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr_buf, &quot;&lt;float&gt;&quot;, 0);</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     526 </span>            :     case TOK_CDOUBLE:
<span class="lineNum">     527 </span><span class="lineCov">          1 :         cstr_cat(&amp;cstr_buf, &quot;&lt;double&gt;&quot;, 0);</span>
<span class="lineNum">     528 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     529 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr_buf, &quot;&lt;long double&gt;&quot;, 0);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     532 </span>            :     case TOK_LINENUM:
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr_buf, &quot;&lt;linenumber&gt;&quot;, 0);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span>            :     /* above tokens have value, the ones below don't */
<span class="lineNum">     537 </span>            :     case TOK_LT:
<span class="lineNum">     538 </span><span class="lineCov">          2 :         v = '&lt;';</span>
<span class="lineNum">     539 </span><span class="lineCov">          2 :         goto addv;</span>
<span class="lineNum">     540 </span>            :     case TOK_GT:
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         v = '&gt;';</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         goto addv;</span>
<span class="lineNum">     543 </span>            :     case TOK_DOTS:
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         return strcpy(p, &quot;...&quot;);</span>
<span class="lineNum">     545 </span>            :     case TOK_A_SHL:
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         return strcpy(p, &quot;&lt;&lt;=&quot;);</span>
<span class="lineNum">     547 </span>            :     case TOK_A_SAR:
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :         return strcpy(p, &quot;&gt;&gt;=&quot;);</span>
<span class="lineNum">     549 </span>            :     case TOK_EOF:
<span class="lineNum">     550 </span><span class="lineCov">         71 :         return strcpy(p, &quot;&lt;eof&gt;&quot;);</span>
<span class="lineNum">     551 </span>            :     default:
<span class="lineNum">     552 </span><span class="lineCov">      12671 :         if (v &lt; TOK_IDENT) {</span>
<span class="lineNum">     553 </span>            :             /* search in two bytes table */
<span class="lineNum">     554 </span><span class="lineCov">         33 :             const unsigned char *q = tok_two_chars;</span>
<span class="lineNum">     555 </span><span class="lineCov">        655 :             while (*q) {</span>
<span class="lineNum">     556 </span><span class="lineCov">        597 :                 if (q[2] == v) {</span>
<span class="lineNum">     557 </span><span class="lineCov">          8 :                     *p++ = q[0];</span>
<span class="lineNum">     558 </span><span class="lineCov">          8 :                     *p++ = q[1];</span>
<span class="lineNum">     559 </span><span class="lineCov">          8 :                     *p = '\0';</span>
<span class="lineNum">     560 </span><span class="lineCov">          8 :                     return cstr_buf.data;</span>
<span class="lineNum">     561 </span>            :                 }
<span class="lineNum">     562 </span><span class="lineCov">        589 :                 q += 3;</span>
<span class="lineNum">     563 </span>            :             }
<span class="lineNum">     564 </span><span class="lineCov">         25 :         if (v &gt;= 127) {</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :             sprintf(cstr_buf.data, &quot;&lt;%02x&gt;&quot;, v);</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :             return cstr_buf.data;</span>
<span class="lineNum">     567 </span>            :         }
<span class="lineNum">     568 </span>            :         addv:
<span class="lineNum">     569 </span><span class="lineCov">         27 :             *p++ = v;</span>
<span class="lineNum">     570 </span><span class="lineCov">         27 :             *p = '\0';</span>
<span class="lineNum">     571 </span><span class="lineCov">      12638 :         } else if (v &lt; tok_ident) {</span>
<span class="lineNum">     572 </span><span class="lineCov">      11458 :             return table_ident[v - TOK_IDENT]-&gt;str;</span>
<span class="lineNum">     573 </span><span class="lineCov">       1180 :         } else if (v &gt;= SYM_FIRST_ANOM) {</span>
<span class="lineNum">     574 </span>            :             /* special name for anonymous symbol */
<span class="lineNum">     575 </span><span class="lineCov">       1180 :             sprintf(p, &quot;L.%u&quot;, v - SYM_FIRST_ANOM);</span>
<span class="lineNum">     576 </span>            :         } else {
<span class="lineNum">     577 </span>            :             /* should never happen */
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :             return NULL;</span>
<span class="lineNum">     579 </span>            :         }
<span class="lineNum">     580 </span><span class="lineCov">       1207 :         break;</span>
<span class="lineNum">     581 </span>            :     }
<span class="lineNum">     582 </span><span class="lineCov">       1208 :     return cstr_buf.data;</span>
<span class="lineNum">     583 </span>            : }
<span class="lineNum">     584 </span>            : 
<a name="585"><span class="lineNum">     585 </span>            : /* return the current character, handling end of block if necessary</a>
<span class="lineNum">     586 </span>            :    (but not stray) */
<span class="lineNum">     587 </span><span class="lineCov">     372517 : ST_FUNC int handle_eob(void)</span>
<span class="lineNum">     588 </span>            : {
<span class="lineNum">     589 </span><span class="lineCov">     372517 :     BufferedFile *bf = file;</span>
<span class="lineNum">     590 </span>            :     int len;
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span>            :     /* only tries to read if really end of buffer */
<span class="lineNum">     593 </span><span class="lineCov">     372517 :     if (bf-&gt;buf_ptr &gt;= bf-&gt;buf_end) {</span>
<span class="lineNum">     594 </span><span class="lineCov">      81093 :         if (bf-&gt;fd &gt;= 0) {</span>
<span class="lineNum">     595 </span>            : #if defined(PARSE_DEBUG)
<span class="lineNum">     596 </span>            :             len = 1;
<span class="lineNum">     597 </span>            : #else
<span class="lineNum">     598 </span><span class="lineCov">      20901 :             len = IO_BUF_SIZE;</span>
<span class="lineNum">     599 </span>            : #endif
<span class="lineNum">     600 </span><span class="lineCov">      20901 :             len = read(bf-&gt;fd, bf-&gt;buffer, len);</span>
<span class="lineNum">     601 </span><span class="lineCov">      20901 :             if (len &lt; 0)</span>
<span class="lineNum">     602 </span><span class="lineCov">          2 :                 len = 0;</span>
<span class="lineNum">     603 </span>            :         } else {
<span class="lineNum">     604 </span><span class="lineCov">      60192 :             len = 0;</span>
<span class="lineNum">     605 </span>            :         }
<span class="lineNum">     606 </span><span class="lineCov">      81093 :         total_bytes += len;</span>
<span class="lineNum">     607 </span><span class="lineCov">      81093 :         bf-&gt;buf_ptr = bf-&gt;buffer;</span>
<span class="lineNum">     608 </span><span class="lineCov">      81093 :         bf-&gt;buf_end = bf-&gt;buffer + len;</span>
<span class="lineNum">     609 </span><span class="lineCov">      81093 :         *bf-&gt;buf_end = CH_EOB;</span>
<span class="lineNum">     610 </span>            :     }
<span class="lineNum">     611 </span><span class="lineCov">     372517 :     if (bf-&gt;buf_ptr &lt; bf-&gt;buf_end) {</span>
<span class="lineNum">     612 </span><span class="lineCov">     303890 :         return bf-&gt;buf_ptr[0];</span>
<span class="lineNum">     613 </span>            :     } else {
<span class="lineNum">     614 </span><span class="lineCov">      68627 :         bf-&gt;buf_ptr = bf-&gt;buf_end;</span>
<span class="lineNum">     615 </span><span class="lineCov">      68627 :         return CH_EOF;</span>
<span class="lineNum">     616 </span>            :     }
<span class="lineNum">     617 </span>            : }
<a name="618"><span class="lineNum">     618 </span>            : </a>
<span class="lineNum">     619 </span>            : /* read next char from current input file and handle end of input buffer */
<span class="lineNum">     620 </span><span class="lineCov">     344045 : ST_INLN void inp(void)</span>
<span class="lineNum">     621 </span>            : {
<span class="lineNum">     622 </span><span class="lineCov">     344045 :     ch = *(++(file-&gt;buf_ptr));</span>
<span class="lineNum">     623 </span>            :     /* end of buffer/file handling */
<span class="lineNum">     624 </span><span class="lineCov">     344045 :     if (ch == CH_EOB)</span>
<span class="lineNum">     625 </span><span class="lineCov">        567 :         ch = handle_eob();</span>
<span class="lineNum">     626 </span><span class="lineCov">     344045 : }</span>
<a name="627"><span class="lineNum">     627 </span>            : </a>
<span class="lineNum">     628 </span>            : /* handle '\[\r]\n' */
<span class="lineNum">     629 </span><span class="lineCov">      33754 : static int handle_stray_noerror(void)</span>
<span class="lineNum">     630 </span>            : {
<span class="lineNum">     631 </span><span class="lineCov">     101260 :     while (ch == '\\') {</span>
<span class="lineNum">     632 </span><span class="lineCov">      33780 :         inp();</span>
<span class="lineNum">     633 </span><span class="lineCov">      33780 :         if (ch == '\n') {</span>
<span class="lineNum">     634 </span><span class="lineCov">      33677 :             file-&gt;line_num++;</span>
<span class="lineNum">     635 </span><span class="lineCov">      33677 :             inp();</span>
<span class="lineNum">     636 </span><span class="lineCov">        103 :         } else if (ch == '\r') {</span>
<span class="lineNum">     637 </span><span class="lineCov">         79 :             inp();</span>
<span class="lineNum">     638 </span><span class="lineCov">         79 :             if (ch != '\n')</span>
<span class="lineNum">     639 </span><span class="lineCov">          4 :                 goto fail;</span>
<span class="lineNum">     640 </span><span class="lineCov">         75 :             file-&gt;line_num++;</span>
<span class="lineNum">     641 </span><span class="lineCov">         75 :             inp();</span>
<span class="lineNum">     642 </span>            :         } else {
<span class="lineNum">     643 </span>            :         fail:
<span class="lineNum">     644 </span><span class="lineCov">         28 :             return 1;</span>
<span class="lineNum">     645 </span>            :         }
<span class="lineNum">     646 </span>            :     }
<span class="lineNum">     647 </span><span class="lineCov">      33726 :     return 0;</span>
<a name="648"><span class="lineNum">     648 </span>            : }</a>
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span><span class="lineNoCov">          0 : static void handle_stray(void)</span>
<span class="lineNum">     651 </span>            : {
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :     if (handle_stray_noerror())</span>
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :         tcc_error(&quot;stray '\\' in program&quot;);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     655 </span>            : 
<a name="656"><span class="lineNum">     656 </span>            : /* skip the stray and handle the \\n case. Output an error if</a>
<span class="lineNum">     657 </span>            :    incorrect char after the stray */
<span class="lineNum">     658 </span><span class="lineCov">      91175 : static int handle_stray1(uint8_t *p)</span>
<span class="lineNum">     659 </span>            : {
<span class="lineNum">     660 </span>            :     int c;
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineCov">      91175 :     file-&gt;buf_ptr = p;</span>
<span class="lineNum">     663 </span><span class="lineCov">      91175 :     if (p &gt;= file-&gt;buf_end) {</span>
<span class="lineNum">     664 </span><span class="lineCov">      75828 :         c = handle_eob();</span>
<span class="lineNum">     665 </span><span class="lineCov">      75828 :         if (c != '\\')</span>
<span class="lineNum">     666 </span><span class="lineCov">      75820 :             return c;</span>
<span class="lineNum">     667 </span><span class="lineCov">          8 :         p = file-&gt;buf_ptr;</span>
<span class="lineNum">     668 </span>            :     }
<span class="lineNum">     669 </span><span class="lineCov">      15355 :     ch = *p;</span>
<span class="lineNum">     670 </span><span class="lineCov">      15355 :     if (handle_stray_noerror()) {</span>
<span class="lineNum">     671 </span><span class="lineCov">         27 :         if (!(parse_flags &amp; PARSE_FLAG_ACCEPT_STRAYS))</span>
<span class="lineNum">     672 </span><span class="lineCov">         27 :             tcc_error(&quot;stray '\\' in program&quot;);</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :         *--file-&gt;buf_ptr = '\\';</span>
<span class="lineNum">     674 </span>            :     }
<span class="lineNum">     675 </span><span class="lineCov">      15328 :     p = file-&gt;buf_ptr;</span>
<span class="lineNum">     676 </span><span class="lineCov">      15328 :     c = *p;</span>
<span class="lineNum">     677 </span><span class="lineCov">      15328 :     return c;</span>
<span class="lineNum">     678 </span>            : }
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            : /* handle just the EOB case, but not stray */
<span class="lineNum">     681 </span>            : #define PEEKC_EOB(c, p)\
<span class="lineNum">     682 </span>            : {\
<span class="lineNum">     683 </span>            :     p++;\
<span class="lineNum">     684 </span>            :     c = *p;\
<span class="lineNum">     685 </span>            :     if (c == '\\') {\
<span class="lineNum">     686 </span>            :         file-&gt;buf_ptr = p;\
<span class="lineNum">     687 </span>            :         c = handle_eob();\
<span class="lineNum">     688 </span>            :         p = file-&gt;buf_ptr;\
<span class="lineNum">     689 </span>            :     }\
<span class="lineNum">     690 </span>            : }
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            : /* handle the complicated stray case */
<span class="lineNum">     693 </span>            : #define PEEKC(c, p)\
<span class="lineNum">     694 </span>            : {\
<span class="lineNum">     695 </span>            :     p++;\
<span class="lineNum">     696 </span>            :     c = *p;\
<span class="lineNum">     697 </span>            :     if (c == '\\') {\
<span class="lineNum">     698 </span>            :         c = handle_stray1(p);\
<span class="lineNum">     699 </span>            :         p = file-&gt;buf_ptr;\
<span class="lineNum">     700 </span>            :     }\
<span class="lineNum">     701 </span>            : }
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span>            : /* input with '\[\r]\n' handling. Note that this function cannot
<a name="704"><span class="lineNum">     704 </span>            :    handle other characters after '\', so you cannot call it inside</a>
<span class="lineNum">     705 </span>            :    strings or comments */
<span class="lineNum">     706 </span><span class="lineCov">     175597 : ST_FUNC void minp(void)</span>
<span class="lineNum">     707 </span>            : {
<span class="lineNum">     708 </span><span class="lineCov">     175597 :     inp();</span>
<span class="lineNum">     709 </span><span class="lineCov">     175597 :     if (ch == '\\') </span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         handle_stray();</span>
<span class="lineNum">     711 </span><span class="lineCov">     175597 : }</span>
<a name="712"><span class="lineNum">     712 </span>            : </a>
<span class="lineNum">     713 </span>            : /* single line C++ comments */
<span class="lineNum">     714 </span><span class="lineCov">       1001 : static uint8_t *parse_line_comment(uint8_t *p)</span>
<span class="lineNum">     715 </span>            : {
<span class="lineNum">     716 </span>            :     int c;
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">       1001 :     p++;</span>
<span class="lineNum">     719 </span>            :     for(;;) {
<span class="lineNum">     720 </span><span class="lineCov">      81232 :         c = *p;</span>
<span class="lineNum">     721 </span>            :     redo:
<span class="lineNum">     722 </span><span class="lineCov">      81429 :         if (c == '\n' || c == CH_EOF) {</span>
<span class="lineNum">     723 </span>            :             break;
<span class="lineNum">     724 </span><span class="lineCov">      80428 :         } else if (c == '\\') {</span>
<span class="lineNum">     725 </span><span class="lineCov">        912 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">     726 </span><span class="lineCov">        912 :             c = handle_eob();</span>
<span class="lineNum">     727 </span><span class="lineCov">        912 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">     728 </span><span class="lineCov">        912 :             if (c == '\\') {</span>
<span class="lineNum">     729 </span><span class="lineCov">        715 :                 PEEKC_EOB(c, p);</span>
<span class="lineNum">     730 </span><span class="lineCov">        715 :                 if (c == '\n') {</span>
<span class="lineNum">     731 </span><span class="lineCov">        421 :                     file-&gt;line_num++;</span>
<span class="lineNum">     732 </span><span class="lineCov">        421 :                     PEEKC_EOB(c, p);</span>
<span class="lineNum">     733 </span><span class="lineCov">        294 :                 } else if (c == '\r') {</span>
<span class="lineNum">     734 </span><span class="lineCov">        213 :                     PEEKC_EOB(c, p);</span>
<span class="lineNum">     735 </span><span class="lineCov">        213 :                     if (c == '\n') {</span>
<span class="lineNum">     736 </span><span class="lineCov">        195 :                         file-&gt;line_num++;</span>
<span class="lineNum">     737 </span><span class="lineCov">        195 :                         PEEKC_EOB(c, p);</span>
<span class="lineNum">     738 </span>            :                     }
<span class="lineNum">     739 </span>            :                 }
<span class="lineNum">     740 </span>            :             } else {
<span class="lineNum">     741 </span><span class="lineCov">        197 :                 goto redo;</span>
<span class="lineNum">     742 </span>            :             }
<span class="lineNum">     743 </span>            :         } else {
<span class="lineNum">     744 </span><span class="lineCov">      79516 :             p++;</span>
<span class="lineNum">     745 </span>            :         }
<span class="lineNum">     746 </span><span class="lineCov">      80231 :     }</span>
<span class="lineNum">     747 </span><span class="lineCov">       1001 :     return p;</span>
<span class="lineNum">     748 </span>            : }
<a name="749"><span class="lineNum">     749 </span>            : </a>
<span class="lineNum">     750 </span>            : /* C comments */
<span class="lineNum">     751 </span><span class="lineCov">     177001 : ST_FUNC uint8_t *parse_comment(uint8_t *p)</span>
<span class="lineNum">     752 </span>            : {
<span class="lineNum">     753 </span>            :     int c;
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span><span class="lineCov">     177001 :     p++;</span>
<span class="lineNum">     756 </span>            :     for(;;) {
<span class="lineNum">     757 </span>            :         /* fast skip loop */
<span class="lineNum">     758 </span>            :         for(;;) {
<span class="lineNum">     759 </span><span class="lineCov">   11855152 :             c = *p;</span>
<span class="lineNum">     760 </span><span class="lineCov">   11855152 :             if (c == '\n' || c == '*' || c == '\\')</span>
<span class="lineNum">     761 </span>            :                 break;
<span class="lineNum">     762 </span><span class="lineCov">   11530452 :             p++;</span>
<span class="lineNum">     763 </span><span class="lineCov">   11530452 :             c = *p;</span>
<span class="lineNum">     764 </span><span class="lineCov">   11530452 :             if (c == '\n' || c == '*' || c == '\\')</span>
<span class="lineNum">     765 </span>            :                 break;
<span class="lineNum">     766 </span><span class="lineCov">   11132817 :             p++;</span>
<span class="lineNum">     767 </span><span class="lineCov">   11132817 :         }</span>
<span class="lineNum">     768 </span>            :         /* now we can handle all the cases */
<span class="lineNum">     769 </span><span class="lineCov">     722335 :         if (c == '\n') {</span>
<span class="lineNum">     770 </span><span class="lineCov">     275125 :             file-&gt;line_num++;</span>
<span class="lineNum">     771 </span><span class="lineCov">     275125 :             p++;</span>
<span class="lineNum">     772 </span><span class="lineCov">     447210 :         } else if (c == '*') {</span>
<span class="lineNum">     773 </span><span class="lineCov">     426650 :             p++;</span>
<span class="lineNum">     774 </span>            :             for(;;) {
<span class="lineNum">     775 </span><span class="lineCov">    2102059 :                 c = *p;</span>
<span class="lineNum">     776 </span><span class="lineCov">    2102059 :                 if (c == '*') {</span>
<span class="lineNum">     777 </span><span class="lineCov">    1637511 :                     p++;</span>
<span class="lineNum">     778 </span><span class="lineCov">     464548 :                 } else if (c == '/') {</span>
<span class="lineNum">     779 </span><span class="lineCov">     176265 :                     goto end_of_comment;</span>
<span class="lineNum">     780 </span><span class="lineCov">     288283 :                 } else if (c == '\\') {</span>
<span class="lineNum">     781 </span><span class="lineCov">      49287 :                     file-&gt;buf_ptr = p;</span>
<span class="lineNum">     782 </span><span class="lineCov">      49287 :                     c = handle_eob();</span>
<span class="lineNum">     783 </span><span class="lineCov">      49287 :                     p = file-&gt;buf_ptr;</span>
<span class="lineNum">     784 </span><span class="lineCov">      49287 :                     if (c == CH_EOF)</span>
<span class="lineNum">     785 </span><span class="lineCov">        346 :                         tcc_error(&quot;unexpected end of file in comment&quot;);</span>
<span class="lineNum">     786 </span><span class="lineCov">      48941 :                     if (c == '\\') {</span>
<span class="lineNum">     787 </span>            :                         /* skip '\[\r]\n', otherwise just skip the stray */
<span class="lineNum">     788 </span><span class="lineCov">     140513 :                         while (c == '\\') {</span>
<span class="lineNum">     789 </span><span class="lineCov">      54016 :                             PEEKC_EOB(c, p);</span>
<span class="lineNum">     790 </span><span class="lineCov">      54016 :                             if (c == '\n') {</span>
<span class="lineNum">     791 </span><span class="lineCov">       1472 :                                 file-&gt;line_num++;</span>
<span class="lineNum">     792 </span><span class="lineCov">       1472 :                                 PEEKC_EOB(c, p);</span>
<span class="lineNum">     793 </span><span class="lineCov">      52544 :                             } else if (c == '\r') {</span>
<span class="lineNum">     794 </span><span class="lineCov">      41501 :                                 PEEKC_EOB(c, p);</span>
<span class="lineNum">     795 </span><span class="lineCov">      41501 :                                 if (c == '\n') {</span>
<span class="lineNum">     796 </span><span class="lineCov">       4665 :                                     file-&gt;line_num++;</span>
<span class="lineNum">     797 </span><span class="lineCov">       4665 :                                     PEEKC_EOB(c, p);</span>
<span class="lineNum">     798 </span>            :                                 }
<span class="lineNum">     799 </span>            :                             } else {
<span class="lineNum">     800 </span><span class="lineCov">      11043 :                                 goto after_star;</span>
<span class="lineNum">     801 </span>            :                             }
<span class="lineNum">     802 </span>            :                         }
<span class="lineNum">     803 </span>            :                     }
<span class="lineNum">     804 </span>            :                 } else {
<span class="lineNum">     805 </span><span class="lineCov">     238996 :                     break;</span>
<span class="lineNum">     806 </span>            :                 }
<span class="lineNum">     807 </span><span class="lineCov">    1675409 :             }</span>
<span class="lineNum">     808 </span>            :         after_star: ;
<span class="lineNum">     809 </span>            :         } else {
<span class="lineNum">     810 </span>            :             /* stray, eob or eof */
<span class="lineNum">     811 </span><span class="lineCov">      20560 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">     812 </span><span class="lineCov">      20560 :             c = handle_eob();</span>
<span class="lineNum">     813 </span><span class="lineCov">      20560 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">     814 </span><span class="lineCov">      20560 :             if (c == CH_EOF) {</span>
<span class="lineNum">     815 </span><span class="lineCov">        390 :                 tcc_error(&quot;unexpected end of file in comment&quot;);</span>
<span class="lineNum">     816 </span><span class="lineCov">      20170 :             } else if (c == '\\') {</span>
<span class="lineNum">     817 </span><span class="lineCov">      17855 :                 p++;</span>
<span class="lineNum">     818 </span>            :             }
<span class="lineNum">     819 </span>            :         }
<span class="lineNum">     820 </span><span class="lineCov">     545334 :     }</span>
<span class="lineNum">     821 </span>            :  end_of_comment:
<span class="lineNum">     822 </span><span class="lineCov">     176265 :     p++;</span>
<span class="lineNum">     823 </span><span class="lineCov">     176265 :     return p;</span>
<a name="824"><span class="lineNum">     824 </span>            : }</a>
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineCov">     476578 : ST_FUNC int set_idnum(int c, int val)</span>
<span class="lineNum">     827 </span>            : {
<span class="lineNum">     828 </span><span class="lineCov">     476578 :     int prev = isidnum_table[c - CH_EOF];</span>
<span class="lineNum">     829 </span><span class="lineCov">     476578 :     isidnum_table[c - CH_EOF] = val;</span>
<span class="lineNum">     830 </span><span class="lineCov">     476578 :     return prev;</span>
<span class="lineNum">     831 </span>            : }
<span class="lineNum">     832 </span>            : 
<a name="833"><span class="lineNum">     833 </span>            : #define cinp minp</a>
<span class="lineNum">     834 </span>            : 
<span class="lineNum">     835 </span><span class="lineCov">       7425 : static inline void skip_spaces(void)</span>
<span class="lineNum">     836 </span>            : {
<span class="lineNum">     837 </span><span class="lineCov">      21976 :     while (isidnum_table[ch - CH_EOF] &amp; IS_SPC)</span>
<span class="lineNum">     838 </span><span class="lineCov">       7126 :         cinp();</span>
<a name="839"><span class="lineNum">     839 </span><span class="lineCov">       7425 : }</span></a>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span><span class="lineCov">     958659 : static inline int check_space(int t, int *spc) </span>
<span class="lineNum">     842 </span>            : {
<span class="lineNum">     843 </span><span class="lineCov">     958659 :     if (t &lt; 256 &amp;&amp; (isidnum_table[t - CH_EOF] &amp; IS_SPC)) {</span>
<span class="lineNum">     844 </span><span class="lineCov">     370233 :         if (*spc) </span>
<span class="lineNum">     845 </span><span class="lineCov">     191183 :             return 1;</span>
<span class="lineNum">     846 </span><span class="lineCov">     179050 :         *spc = 1;</span>
<span class="lineNum">     847 </span>            :     } else 
<span class="lineNum">     848 </span><span class="lineCov">     588426 :         *spc = 0;</span>
<span class="lineNum">     849 </span><span class="lineCov">     767476 :     return 0;</span>
<span class="lineNum">     850 </span>            : }
<a name="851"><span class="lineNum">     851 </span>            : </a>
<span class="lineNum">     852 </span>            : /* parse a string without interpreting escapes */
<span class="lineNum">     853 </span><span class="lineCov">      14884 : static uint8_t *parse_pp_string(uint8_t *p,</span>
<span class="lineNum">     854 </span>            :                                 int sep, CString *str)
<span class="lineNum">     855 </span>            : {
<span class="lineNum">     856 </span>            :     int c;
<span class="lineNum">     857 </span><span class="lineCov">      14884 :     p++;</span>
<span class="lineNum">     858 </span>            :     for(;;) {
<span class="lineNum">     859 </span><span class="lineCov">     219651 :         c = *p;</span>
<span class="lineNum">     860 </span><span class="lineCov">     219651 :         if (c == sep) {</span>
<span class="lineNum">     861 </span><span class="lineCov">      14878 :             break;</span>
<span class="lineNum">     862 </span><span class="lineCov">     204773 :         } else if (c == '\\') {</span>
<span class="lineNum">     863 </span><span class="lineCov">       2263 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">     864 </span><span class="lineCov">       2263 :             c = handle_eob();</span>
<span class="lineNum">     865 </span><span class="lineCov">       2263 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">     866 </span><span class="lineCov">       2263 :             if (c == CH_EOF) {</span>
<span class="lineNum">     867 </span>            :             unterminated_string:
<span class="lineNum">     868 </span>            :                 /* XXX: indicate line number of start of string */
<span class="lineNum">     869 </span><span class="lineCov">          6 :                 tcc_error(&quot;missing terminating %c character&quot;, sep);</span>
<span class="lineNum">     870 </span><span class="lineCov">       2257 :             } else if (c == '\\') {</span>
<span class="lineNum">     871 </span>            :                 /* escape : just skip \[\r]\n */
<span class="lineNum">     872 </span><span class="lineCov">       2257 :                 PEEKC_EOB(c, p);</span>
<span class="lineNum">     873 </span><span class="lineCov">       2257 :                 if (c == '\n') {</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                     file-&gt;line_num++;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                     p++;</span>
<span class="lineNum">     876 </span><span class="lineCov">       2257 :                 } else if (c == '\r') {</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :                     PEEKC_EOB(c, p);</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :                     if (c != '\n')</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                         expect(&quot;'\n' after '\r'&quot;);</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                     file-&gt;line_num++;</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                     p++;</span>
<span class="lineNum">     882 </span><span class="lineCov">       2257 :                 } else if (c == CH_EOF) {</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :                     goto unterminated_string;</span>
<span class="lineNum">     884 </span>            :                 } else {
<span class="lineNum">     885 </span><span class="lineCov">       2257 :                     if (str) {</span>
<span class="lineNum">     886 </span><span class="lineCov">        929 :                         cstr_ccat(str, '\\');</span>
<span class="lineNum">     887 </span><span class="lineCov">        929 :                         cstr_ccat(str, c);</span>
<span class="lineNum">     888 </span>            :                     }
<span class="lineNum">     889 </span><span class="lineCov">       2257 :                     p++;</span>
<span class="lineNum">     890 </span>            :                 }
<span class="lineNum">     891 </span>            :             }
<span class="lineNum">     892 </span><span class="lineCov">     202510 :         } else if (c == '\n') {</span>
<span class="lineNum">     893 </span><span class="lineCov">         34 :             file-&gt;line_num++;</span>
<span class="lineNum">     894 </span><span class="lineCov">         34 :             goto add_char;</span>
<span class="lineNum">     895 </span><span class="lineCov">     202476 :         } else if (c == '\r') {</span>
<span class="lineNum">     896 </span><span class="lineCov">          1 :             PEEKC_EOB(c, p);</span>
<span class="lineNum">     897 </span><span class="lineCov">          1 :             if (c != '\n') {</span>
<span class="lineNum">     898 </span><span class="lineCov">          1 :                 if (str)</span>
<span class="lineNum">     899 </span><span class="lineCov">          1 :                     cstr_ccat(str, '\r');</span>
<span class="lineNum">     900 </span>            :             } else {
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                 file-&gt;line_num++;</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :                 goto add_char;</span>
<span class="lineNum">     903 </span>            :             }
<span class="lineNum">     904 </span>            :         } else {
<span class="lineNum">     905 </span>            :         add_char:
<span class="lineNum">     906 </span><span class="lineCov">     202509 :             if (str)</span>
<span class="lineNum">     907 </span><span class="lineCov">     153519 :                 cstr_ccat(str, c);</span>
<span class="lineNum">     908 </span><span class="lineCov">     202509 :             p++;</span>
<span class="lineNum">     909 </span>            :         }
<span class="lineNum">     910 </span><span class="lineCov">     204767 :     }</span>
<span class="lineNum">     911 </span><span class="lineCov">      14878 :     p++;</span>
<span class="lineNum">     912 </span><span class="lineCov">      14878 :     return p;</span>
<span class="lineNum">     913 </span>            : }
<span class="lineNum">     914 </span>            : 
<a name="915"><span class="lineNum">     915 </span>            : /* skip block of text until #else, #elif or #endif. skip also pairs of</a>
<span class="lineNum">     916 </span>            :    #if/#endif */
<span class="lineNum">     917 </span><span class="lineCov">      43776 : static void preprocess_skip(void)</span>
<span class="lineNum">     918 </span>            : {
<span class="lineNum">     919 </span>            :     int a, start_of_line, c, in_warn_or_error;
<span class="lineNum">     920 </span>            :     uint8_t *p;
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineCov">      43776 :     p = file-&gt;buf_ptr;</span>
<span class="lineNum">     923 </span><span class="lineCov">      43776 :     a = 0;</span>
<span class="lineNum">     924 </span>            : redo_start:
<span class="lineNum">     925 </span><span class="lineCov">     496210 :     start_of_line = 1;</span>
<span class="lineNum">     926 </span><span class="lineCov">     496210 :     in_warn_or_error = 0;</span>
<span class="lineNum">     927 </span>            :     for(;;) {
<span class="lineNum">     928 </span>            :     redo_no_start:
<span class="lineNum">     929 </span><span class="lineCov">   11812309 :         c = *p;</span>
<span class="lineNum">     930 </span><span class="lineCov">   11812309 :         switch(c) {</span>
<span class="lineNum">     931 </span>            :         case ' ':
<span class="lineNum">     932 </span>            :         case '\t':
<span class="lineNum">     933 </span>            :         case '\f':
<span class="lineNum">     934 </span>            :         case '\v':
<span class="lineNum">     935 </span>            :         case '\r':
<span class="lineNum">     936 </span><span class="lineCov">    1640917 :             p++;</span>
<span class="lineNum">     937 </span><span class="lineCov">    1640917 :             goto redo_no_start;</span>
<span class="lineNum">     938 </span>            :         case '\n':
<span class="lineNum">     939 </span><span class="lineCov">     452434 :             file-&gt;line_num++;</span>
<span class="lineNum">     940 </span><span class="lineCov">     452434 :             p++;</span>
<span class="lineNum">     941 </span><span class="lineCov">     452434 :             goto redo_start;</span>
<span class="lineNum">     942 </span>            :         case '\\':
<span class="lineNum">     943 </span><span class="lineCov">      19079 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">     944 </span><span class="lineCov">      19079 :             c = handle_eob();</span>
<span class="lineNum">     945 </span><span class="lineCov">      19079 :             if (c == CH_EOF) {</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :                 expect(&quot;#endif&quot;);</span>
<span class="lineNum">     947 </span><span class="lineCov">      19079 :             } else if (c == '\\') {</span>
<span class="lineNum">     948 </span><span class="lineCov">      18398 :                 ch = file-&gt;buf_ptr[0];</span>
<span class="lineNum">     949 </span><span class="lineCov">      18398 :                 handle_stray_noerror();</span>
<span class="lineNum">     950 </span>            :             }
<span class="lineNum">     951 </span><span class="lineCov">      19079 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">     952 </span><span class="lineCov">      19079 :             goto redo_no_start;</span>
<span class="lineNum">     953 </span>            :         /* skip strings */
<span class="lineNum">     954 </span>            :         case '\&quot;':
<span class="lineNum">     955 </span>            :         case '\'':
<span class="lineNum">     956 </span><span class="lineCov">      14429 :             if (in_warn_or_error)</span>
<span class="lineNum">     957 </span><span class="lineCov">       2892 :                 goto _default;</span>
<span class="lineNum">     958 </span><span class="lineCov">      11537 :             p = parse_pp_string(p, c, NULL);</span>
<span class="lineNum">     959 </span><span class="lineCov">      11537 :             break;</span>
<span class="lineNum">     960 </span>            :         /* skip comments */
<span class="lineNum">     961 </span>            :         case '/':
<span class="lineNum">     962 </span><span class="lineCov">      66575 :             if (in_warn_or_error)</span>
<span class="lineNum">     963 </span><span class="lineCov">       1470 :                 goto _default;</span>
<span class="lineNum">     964 </span><span class="lineCov">      65105 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">     965 </span><span class="lineCov">      65105 :             ch = *p;</span>
<span class="lineNum">     966 </span><span class="lineCov">      65105 :             minp();</span>
<span class="lineNum">     967 </span><span class="lineCov">      65105 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">     968 </span><span class="lineCov">      65105 :             if (ch == '*') {</span>
<span class="lineNum">     969 </span><span class="lineCov">      61643 :                 p = parse_comment(p);</span>
<span class="lineNum">     970 </span><span class="lineCov">       3462 :             } else if (ch == '/') {</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                 p = parse_line_comment(p);</span>
<span class="lineNum">     972 </span>            :             }
<span class="lineNum">     973 </span><span class="lineCov">      65105 :             break;</span>
<span class="lineNum">     974 </span>            :         case '#':
<span class="lineNum">     975 </span><span class="lineCov">     193287 :             p++;</span>
<span class="lineNum">     976 </span><span class="lineCov">     193287 :             if (start_of_line) {</span>
<span class="lineNum">     977 </span><span class="lineCov">     188273 :                 file-&gt;buf_ptr = p;</span>
<span class="lineNum">     978 </span><span class="lineCov">     188273 :                 next_nomacro();</span>
<span class="lineNum">     979 </span><span class="lineCov">     188273 :                 p = file-&gt;buf_ptr;</span>
<span class="lineNum">     980 </span><span class="lineCov">     308370 :                 if (a == 0 &amp;&amp; </span>
<span class="lineNum">     981 </span><span class="lineCov">     228442 :                     (tok == TOK_ELSE || tok == TOK_ELIF || tok == TOK_ENDIF))</span>
<span class="lineNum">     982 </span>            :                     goto the_end;
<span class="lineNum">     983 </span><span class="lineCov">     144497 :                 if (tok == TOK_IF || tok == TOK_IFDEF || tok == TOK_IFNDEF)</span>
<span class="lineNum">     984 </span><span class="lineCov">      24384 :                     a++;</span>
<span class="lineNum">     985 </span><span class="lineCov">     120113 :                 else if (tok == TOK_ENDIF)</span>
<span class="lineNum">     986 </span><span class="lineCov">      24384 :                     a--;</span>
<span class="lineNum">     987 </span><span class="lineCov">      95729 :                 else if( tok == TOK_ERROR || tok == TOK_WARNING)</span>
<span class="lineNum">     988 </span><span class="lineCov">       2106 :                     in_warn_or_error = 1;</span>
<span class="lineNum">     989 </span><span class="lineCov">      93623 :                 else if (tok == TOK_LINEFEED)</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                     goto redo_start;</span>
<span class="lineNum">     991 </span><span class="lineCov">      93623 :                 else if (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                     p = parse_line_comment(p - 1);</span>
<span class="lineNum">     993 </span><span class="lineCov">       5014 :             } else if (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                 p = parse_line_comment(p - 1);</span>
<span class="lineNum">     995 </span><span class="lineCov">     149511 :             break;</span>
<span class="lineNum">     996 </span>            : _default:
<span class="lineNum">     997 </span>            :         default:
<span class="lineNum">     998 </span><span class="lineCov">    9429950 :             p++;</span>
<span class="lineNum">     999 </span><span class="lineCov">    9429950 :             break;</span>
<span class="lineNum">    1000 </span>            :         }
<span class="lineNum">    1001 </span><span class="lineCov">    9656103 :         start_of_line = 0;</span>
<span class="lineNum">    1002 </span><span class="lineCov">    9656103 :     }</span>
<span class="lineNum">    1003 </span>            :  the_end: ;
<span class="lineNum">    1004 </span><span class="lineCov">      43776 :     file-&gt;buf_ptr = p;</span>
<span class="lineNum">    1005 </span><span class="lineCov">      43776 : }</span>
<span class="lineNum">    1006 </span>            : 
<span class="lineNum">    1007 </span>            : #if 0
<span class="lineNum">    1008 </span>            : /* return the number of additional 'ints' necessary to store the
<span class="lineNum">    1009 </span>            :    token */
<span class="lineNum">    1010 </span>            : static inline int tok_size(const int *p)
<span class="lineNum">    1011 </span>            : {
<span class="lineNum">    1012 </span>            :     switch(*p) {
<span class="lineNum">    1013 </span>            :         /* 4 bytes */
<span class="lineNum">    1014 </span>            :     case TOK_CINT:
<span class="lineNum">    1015 </span>            :     case TOK_CUINT:
<span class="lineNum">    1016 </span>            :     case TOK_CCHAR:
<span class="lineNum">    1017 </span>            :     case TOK_LCHAR:
<span class="lineNum">    1018 </span>            :     case TOK_CFLOAT:
<span class="lineNum">    1019 </span>            :     case TOK_LINENUM:
<span class="lineNum">    1020 </span>            :         return 1 + 1;
<span class="lineNum">    1021 </span>            :     case TOK_STR:
<span class="lineNum">    1022 </span>            :     case TOK_LSTR:
<span class="lineNum">    1023 </span>            :     case TOK_PPNUM:
<span class="lineNum">    1024 </span>            :     case TOK_PPSTR:
<span class="lineNum">    1025 </span>            :         return 1 + ((sizeof(CString) + ((CString *)(p+1))-&gt;size + 3) &gt;&gt; 2);
<span class="lineNum">    1026 </span>            :     case TOK_CLONG:
<span class="lineNum">    1027 </span>            :     case TOK_CULONG:
<span class="lineNum">    1028 </span>            :         return 1 + LONG_SIZE / 4;
<span class="lineNum">    1029 </span>            :     case TOK_CDOUBLE:
<span class="lineNum">    1030 </span>            :     case TOK_CLLONG:
<span class="lineNum">    1031 </span>            :     case TOK_CULLONG:
<span class="lineNum">    1032 </span>            :         return 1 + 2;
<span class="lineNum">    1033 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">    1034 </span>            :         return 1 + LDOUBLE_SIZE / 4;
<span class="lineNum">    1035 </span>            :     default:
<span class="lineNum">    1036 </span>            :         return 1 + 0;
<span class="lineNum">    1037 </span>            :     }
<span class="lineNum">    1038 </span>            : }
<span class="lineNum">    1039 </span>            : #endif
<a name="1040"><span class="lineNum">    1040 </span>            : </a>
<span class="lineNum">    1041 </span>            : /* token string handling */
<span class="lineNum">    1042 </span><span class="lineCov">     164316 : ST_INLN void tok_str_new(TokenString *s)</span>
<span class="lineNum">    1043 </span>            : {
<span class="lineNum">    1044 </span><span class="lineCov">     164316 :     s-&gt;str = NULL;</span>
<span class="lineNum">    1045 </span><span class="lineCov">     164316 :     s-&gt;len = s-&gt;lastlen = 0;</span>
<span class="lineNum">    1046 </span><span class="lineCov">     164316 :     s-&gt;allocated_len = 0;</span>
<span class="lineNum">    1047 </span><span class="lineCov">     164316 :     s-&gt;last_line_num = -1;</span>
<a name="1048"><span class="lineNum">    1048 </span><span class="lineCov">     164316 : }</span></a>
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span><span class="lineCov">      39302 : ST_FUNC TokenString *tok_str_alloc(void)</span>
<span class="lineNum">    1051 </span>            : {
<span class="lineNum">    1052 </span><span class="lineCov">      39302 :     TokenString *str = tal_realloc(tokstr_alloc, 0, sizeof *str);</span>
<span class="lineNum">    1053 </span><span class="lineCov">      39302 :     tok_str_new(str);</span>
<span class="lineNum">    1054 </span><span class="lineCov">      39302 :     return str;</span>
<a name="1055"><span class="lineNum">    1055 </span>            : }</a>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineCov">     130388 : ST_FUNC int *tok_str_dup(TokenString *s)</span>
<span class="lineNum">    1058 </span>            : {
<span class="lineNum">    1059 </span>            :     int *str;
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineCov">     130388 :     str = tal_realloc(tokstr_alloc, 0, s-&gt;len * sizeof(int));</span>
<span class="lineNum">    1062 </span><span class="lineCov">     130388 :     memcpy(str, s-&gt;str, s-&gt;len * sizeof(int));</span>
<span class="lineNum">    1063 </span><span class="lineCov">     130388 :     return str;</span>
<a name="1064"><span class="lineNum">    1064 </span>            : }</a>
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span><span class="lineCov">     339989 : ST_FUNC void tok_str_free_str(int *str)</span>
<span class="lineNum">    1067 </span>            : {
<span class="lineNum">    1068 </span><span class="lineCov">     339989 :     tal_free(tokstr_alloc, str);</span>
<a name="1069"><span class="lineNum">    1069 </span><span class="lineCov">     339989 : }</span></a>
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineCov">      39302 : ST_FUNC void tok_str_free(TokenString *str)</span>
<span class="lineNum">    1072 </span>            : {
<span class="lineNum">    1073 </span><span class="lineCov">      39302 :     tok_str_free_str(str-&gt;str);</span>
<span class="lineNum">    1074 </span><span class="lineCov">      39302 :     tal_free(tokstr_alloc, str);</span>
<a name="1075"><span class="lineNum">    1075 </span><span class="lineCov">      39302 : }</span></a>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span><span class="lineCov">     188637 : ST_FUNC int *tok_str_realloc(TokenString *s, int new_size)</span>
<span class="lineNum">    1078 </span>            : {
<span class="lineNum">    1079 </span>            :     int *str, size;
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span><span class="lineCov">     188637 :     size = s-&gt;allocated_len;</span>
<span class="lineNum">    1082 </span><span class="lineCov">     188637 :     if (size &lt; 16)</span>
<span class="lineNum">    1083 </span><span class="lineCov">     157951 :         size = 16;</span>
<span class="lineNum">    1084 </span><span class="lineCov">     414648 :     while (size &lt; new_size)</span>
<span class="lineNum">    1085 </span><span class="lineCov">      37374 :         size = size * 2;</span>
<span class="lineNum">    1086 </span><span class="lineCov">     188637 :     if (size &gt; s-&gt;allocated_len) {</span>
<span class="lineNum">    1087 </span><span class="lineCov">     188637 :         str = tal_realloc(tokstr_alloc, s-&gt;str, size * sizeof(int));</span>
<span class="lineNum">    1088 </span><span class="lineCov">     188637 :         s-&gt;allocated_len = size;</span>
<span class="lineNum">    1089 </span><span class="lineCov">     188637 :         s-&gt;str = str;</span>
<span class="lineNum">    1090 </span>            :     }
<span class="lineNum">    1091 </span><span class="lineCov">     188637 :     return s-&gt;str;</span>
<a name="1092"><span class="lineNum">    1092 </span>            : }</a>
<span class="lineNum">    1093 </span>            : 
<span class="lineNum">    1094 </span><span class="lineCov">     510990 : ST_FUNC void tok_str_add(TokenString *s, int t)</span>
<span class="lineNum">    1095 </span>            : {
<span class="lineNum">    1096 </span>            :     int len, *str;
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span><span class="lineCov">     510990 :     len = s-&gt;len;</span>
<span class="lineNum">    1099 </span><span class="lineCov">     510990 :     str = s-&gt;str;</span>
<span class="lineNum">    1100 </span><span class="lineCov">     510990 :     if (len &gt;= s-&gt;allocated_len)</span>
<span class="lineNum">    1101 </span><span class="lineCov">      29413 :         str = tok_str_realloc(s, len + 1);</span>
<span class="lineNum">    1102 </span><span class="lineCov">     510990 :     str[len++] = t;</span>
<span class="lineNum">    1103 </span><span class="lineCov">     510990 :     s-&gt;len = len;</span>
<a name="1104"><span class="lineNum">    1104 </span><span class="lineCov">     510990 : }</span></a>
<span class="lineNum">    1105 </span>            : 
<span class="lineNum">    1106 </span><span class="lineCov">     191311 : ST_FUNC void begin_macro(TokenString *str, int alloc)</span>
<span class="lineNum">    1107 </span>            : {
<span class="lineNum">    1108 </span><span class="lineCov">     191311 :     str-&gt;alloc = alloc;</span>
<span class="lineNum">    1109 </span><span class="lineCov">     191311 :     str-&gt;prev = macro_stack;</span>
<span class="lineNum">    1110 </span><span class="lineCov">     191311 :     str-&gt;prev_ptr = macro_ptr;</span>
<span class="lineNum">    1111 </span><span class="lineCov">     191311 :     str-&gt;save_line_num = file-&gt;line_num;</span>
<span class="lineNum">    1112 </span><span class="lineCov">     191311 :     macro_ptr = str-&gt;str;</span>
<span class="lineNum">    1113 </span><span class="lineCov">     191311 :     macro_stack = str;</span>
<a name="1114"><span class="lineNum">    1114 </span><span class="lineCov">     191311 : }</span></a>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineCov">     191311 : ST_FUNC void end_macro(void)</span>
<span class="lineNum">    1117 </span>            : {
<span class="lineNum">    1118 </span><span class="lineCov">     191311 :     TokenString *str = macro_stack;</span>
<span class="lineNum">    1119 </span><span class="lineCov">     191311 :     macro_stack = str-&gt;prev;</span>
<span class="lineNum">    1120 </span><span class="lineCov">     191311 :     macro_ptr = str-&gt;prev_ptr;</span>
<span class="lineNum">    1121 </span><span class="lineCov">     191311 :     file-&gt;line_num = str-&gt;save_line_num;</span>
<span class="lineNum">    1122 </span><span class="lineCov">     191311 :     if (str-&gt;alloc == 2) {</span>
<span class="lineNum">    1123 </span><span class="lineCov">     152009 :         str-&gt;alloc = 3; /* just mark as finished */</span>
<span class="lineNum">    1124 </span>            :     } else {
<span class="lineNum">    1125 </span><span class="lineCov">      39302 :         tok_str_free(str);</span>
<span class="lineNum">    1126 </span>            :     }
<a name="1127"><span class="lineNum">    1127 </span><span class="lineCov">     191311 : }</span></a>
<span class="lineNum">    1128 </span>            : 
<span class="lineNum">    1129 </span><span class="lineCov">    1251420 : static void tok_str_add2(TokenString *s, int t, CValue *cv)</span>
<span class="lineNum">    1130 </span>            : {
<span class="lineNum">    1131 </span>            :     int len, *str;
<span class="lineNum">    1132 </span>            : 
<span class="lineNum">    1133 </span><span class="lineCov">    1251420 :     len = s-&gt;lastlen = s-&gt;len;</span>
<span class="lineNum">    1134 </span><span class="lineCov">    1251420 :     str = s-&gt;str;</span>
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span>            :     /* allocate space for worst case */
<span class="lineNum">    1137 </span><span class="lineCov">    1251420 :     if (len + TOK_MAX_SIZE &gt;= s-&gt;allocated_len)</span>
<span class="lineNum">    1138 </span><span class="lineCov">     156531 :         str = tok_str_realloc(s, len + TOK_MAX_SIZE + 1);</span>
<span class="lineNum">    1139 </span><span class="lineCov">    1251420 :     str[len++] = t;</span>
<span class="lineNum">    1140 </span><span class="lineCov">    1251420 :     switch(t) {</span>
<span class="lineNum">    1141 </span>            :     case TOK_CINT:
<span class="lineNum">    1142 </span>            :     case TOK_CUINT:
<span class="lineNum">    1143 </span>            :     case TOK_CCHAR:
<span class="lineNum">    1144 </span>            :     case TOK_LCHAR:
<span class="lineNum">    1145 </span>            :     case TOK_CFLOAT:
<span class="lineNum">    1146 </span>            :     case TOK_LINENUM:
<span class="lineNum">    1147 </span>            : #if LONG_SIZE == 4
<span class="lineNum">    1148 </span>            :     case TOK_CLONG:
<span class="lineNum">    1149 </span>            :     case TOK_CULONG:
<span class="lineNum">    1150 </span>            : #endif
<span class="lineNum">    1151 </span><span class="lineCov">     157566 :         str[len++] = cv-&gt;tab[0];</span>
<span class="lineNum">    1152 </span><span class="lineCov">     157566 :         break;</span>
<span class="lineNum">    1153 </span>            :     case TOK_PPNUM:
<span class="lineNum">    1154 </span>            :     case TOK_PPSTR:
<span class="lineNum">    1155 </span>            :     case TOK_STR:
<span class="lineNum">    1156 </span>            :     case TOK_LSTR:
<span class="lineNum">    1157 </span>            :         {
<span class="lineNum">    1158 </span>            :             /* Insert the string into the int array. */
<span class="lineNum">    1159 </span><span class="lineCov">     115828 :             size_t nb_words =</span>
<span class="lineNum">    1160 </span><span class="lineCov">     115828 :                 1 + (cv-&gt;str.size + sizeof(int) - 1) / sizeof(int);</span>
<span class="lineNum">    1161 </span><span class="lineCov">     115828 :             if (len + nb_words &gt;= s-&gt;allocated_len)</span>
<span class="lineNum">    1162 </span><span class="lineCov">       1021 :                 str = tok_str_realloc(s, len + nb_words + 1);</span>
<span class="lineNum">    1163 </span><span class="lineCov">     115828 :             str[len] = cv-&gt;str.size;</span>
<span class="lineNum">    1164 </span><span class="lineCov">     115828 :             memcpy(&amp;str[len + 1], cv-&gt;str.data, cv-&gt;str.size);</span>
<span class="lineNum">    1165 </span><span class="lineCov">     115828 :             len += nb_words;</span>
<span class="lineNum">    1166 </span>            :         }
<span class="lineNum">    1167 </span><span class="lineCov">     115828 :         break;</span>
<span class="lineNum">    1168 </span>            :     case TOK_CDOUBLE:
<span class="lineNum">    1169 </span>            :     case TOK_CLLONG:
<span class="lineNum">    1170 </span>            :     case TOK_CULLONG:
<span class="lineNum">    1171 </span>            : #if LONG_SIZE == 8
<span class="lineNum">    1172 </span>            :     case TOK_CLONG:
<span class="lineNum">    1173 </span>            :     case TOK_CULONG:
<span class="lineNum">    1174 </span>            : #endif
<span class="lineNum">    1175 </span>            : #if LDOUBLE_SIZE == 8
<span class="lineNum">    1176 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">    1177 </span>            : #endif
<span class="lineNum">    1178 </span><span class="lineCov">       7950 :         str[len++] = cv-&gt;tab[0];</span>
<span class="lineNum">    1179 </span><span class="lineCov">       7950 :         str[len++] = cv-&gt;tab[1];</span>
<span class="lineNum">    1180 </span><span class="lineCov">       7950 :         break;</span>
<span class="lineNum">    1181 </span>            : #if LDOUBLE_SIZE == 12
<span class="lineNum">    1182 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">    1183 </span>            :         str[len++] = cv-&gt;tab[0];
<span class="lineNum">    1184 </span>            :         str[len++] = cv-&gt;tab[1];
<span class="lineNum">    1185 </span>            :         str[len++] = cv-&gt;tab[2];
<span class="lineNum">    1186 </span>            : #elif LDOUBLE_SIZE == 16
<span class="lineNum">    1187 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :         str[len++] = cv-&gt;tab[0];</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :         str[len++] = cv-&gt;tab[1];</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :         str[len++] = cv-&gt;tab[2];</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :         str[len++] = cv-&gt;tab[3];</span>
<span class="lineNum">    1192 </span>            : #elif LDOUBLE_SIZE != 8
<span class="lineNum">    1193 </span>            : #error add long double size support
<span class="lineNum">    1194 </span>            : #endif
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1196 </span>            :     default:
<span class="lineNum">    1197 </span><span class="lineCov">     970076 :         break;</span>
<span class="lineNum">    1198 </span>            :     }
<span class="lineNum">    1199 </span><span class="lineCov">    1251420 :     s-&gt;len = len;</span>
<span class="lineNum">    1200 </span><span class="lineCov">    1251420 : }</span>
<a name="1201"><span class="lineNum">    1201 </span>            : </a>
<span class="lineNum">    1202 </span>            : /* add the current parse token in token string 's' */
<span class="lineNum">    1203 </span><span class="lineCov">     216297 : ST_FUNC void tok_str_add_tok(TokenString *s)</span>
<span class="lineNum">    1204 </span>            : {
<span class="lineNum">    1205 </span>            :     CValue cval;
<span class="lineNum">    1206 </span>            : 
<span class="lineNum">    1207 </span>            :     /* save line number info */
<span class="lineNum">    1208 </span><span class="lineCov">     216297 :     if (file-&gt;line_num != s-&gt;last_line_num) {</span>
<span class="lineNum">    1209 </span><span class="lineCov">      79321 :         s-&gt;last_line_num = file-&gt;line_num;</span>
<span class="lineNum">    1210 </span><span class="lineCov">      79321 :         cval.i = s-&gt;last_line_num;</span>
<span class="lineNum">    1211 </span><span class="lineCov">      79321 :         tok_str_add2(s, TOK_LINENUM, &amp;cval);</span>
<span class="lineNum">    1212 </span>            :     }
<span class="lineNum">    1213 </span><span class="lineCov">     216297 :     tok_str_add2(s, tok, &amp;tokc);</span>
<span class="lineNum">    1214 </span><span class="lineCov">     216297 : }</span>
<span class="lineNum">    1215 </span>            : 
<a name="1216"><span class="lineNum">    1216 </span>            : /* get a token from an integer array and increment pointer</a>
<span class="lineNum">    1217 </span>            :    accordingly. we code it as a macro to avoid pointer aliasing. */
<span class="lineNum">    1218 </span><span class="lineCov">    1766846 : static inline void TOK_GET(int *t, const int **pp, CValue *cv)</span>
<span class="lineNum">    1219 </span>            : {
<span class="lineNum">    1220 </span><span class="lineCov">    1766846 :     const int *p = *pp;</span>
<span class="lineNum">    1221 </span>            :     int n, *tab;
<span class="lineNum">    1222 </span>            : 
<span class="lineNum">    1223 </span><span class="lineCov">    1766846 :     tab = cv-&gt;tab;</span>
<span class="lineNum">    1224 </span><span class="lineCov">    1766846 :     switch(*t = *p++) {</span>
<span class="lineNum">    1225 </span>            : #if LONG_SIZE == 4
<span class="lineNum">    1226 </span>            :     case TOK_CLONG:
<span class="lineNum">    1227 </span>            : #endif
<span class="lineNum">    1228 </span>            :     case TOK_CINT:
<span class="lineNum">    1229 </span>            :     case TOK_CCHAR:
<span class="lineNum">    1230 </span>            :     case TOK_LCHAR:
<span class="lineNum">    1231 </span>            :     case TOK_LINENUM:
<span class="lineNum">    1232 </span><span class="lineCov">     158741 :         cv-&gt;i = *p++;</span>
<span class="lineNum">    1233 </span><span class="lineCov">     158741 :         break;</span>
<span class="lineNum">    1234 </span>            : #if LONG_SIZE == 4
<span class="lineNum">    1235 </span>            :     case TOK_CULONG:
<span class="lineNum">    1236 </span>            : #endif
<span class="lineNum">    1237 </span>            :     case TOK_CUINT:
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :         cv-&gt;i = (unsigned)*p++;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1240 </span>            :     case TOK_CFLOAT:
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :         tab[0] = *p++;</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1243 </span>            :     case TOK_STR:
<span class="lineNum">    1244 </span>            :     case TOK_LSTR:
<span class="lineNum">    1245 </span>            :     case TOK_PPNUM:
<span class="lineNum">    1246 </span>            :     case TOK_PPSTR:
<span class="lineNum">    1247 </span><span class="lineCov">      65490 :         cv-&gt;str.size = *p++;</span>
<span class="lineNum">    1248 </span><span class="lineCov">      65490 :         cv-&gt;str.data = p;</span>
<span class="lineNum">    1249 </span><span class="lineCov">      65490 :         p += (cv-&gt;str.size + sizeof(int) - 1) / sizeof(int);</span>
<span class="lineNum">    1250 </span><span class="lineCov">      65490 :         break;</span>
<span class="lineNum">    1251 </span>            :     case TOK_CDOUBLE:
<span class="lineNum">    1252 </span>            :     case TOK_CLLONG:
<span class="lineNum">    1253 </span>            :     case TOK_CULLONG:
<span class="lineNum">    1254 </span>            : #if LONG_SIZE == 8
<span class="lineNum">    1255 </span>            :     case TOK_CLONG:
<span class="lineNum">    1256 </span>            :     case TOK_CULONG:
<span class="lineNum">    1257 </span>            : #endif
<span class="lineNum">    1258 </span><span class="lineCov">       7950 :         n = 2;</span>
<span class="lineNum">    1259 </span><span class="lineCov">       7950 :         goto copy;</span>
<span class="lineNum">    1260 </span>            :     case TOK_CLDOUBLE:
<span class="lineNum">    1261 </span>            : #if LDOUBLE_SIZE == 16
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :         n = 4;</span>
<span class="lineNum">    1263 </span>            : #elif LDOUBLE_SIZE == 12
<span class="lineNum">    1264 </span>            :         n = 3;
<span class="lineNum">    1265 </span>            : #elif LDOUBLE_SIZE == 8
<span class="lineNum">    1266 </span>            :         n = 2;
<span class="lineNum">    1267 </span>            : #else
<span class="lineNum">    1268 </span>            : # error add long double size support
<span class="lineNum">    1269 </span>            : #endif
<span class="lineNum">    1270 </span>            :     copy:
<span class="lineNum">    1271 </span>            :         do
<span class="lineNum">    1272 </span><span class="lineCov">      15900 :             *tab++ = *p++;</span>
<span class="lineNum">    1273 </span><span class="lineCov">      15900 :         while (--n);</span>
<span class="lineNum">    1274 </span><span class="lineCov">       7950 :         break;</span>
<span class="lineNum">    1275 </span>            :     default:
<span class="lineNum">    1276 </span><span class="lineCov">    1534665 :         break;</span>
<span class="lineNum">    1277 </span>            :     }
<span class="lineNum">    1278 </span><span class="lineCov">    1766846 :     *pp = p;</span>
<a name="1279"><span class="lineNum">    1279 </span><span class="lineCov">    1766846 : }</span></a>
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span><span class="lineCov">       1785 : static int macro_is_equal(const int *a, const int *b)</span>
<span class="lineNum">    1282 </span>            : {
<span class="lineNum">    1283 </span>            :     CValue cv;
<span class="lineNum">    1284 </span>            :     int t;
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span><span class="lineCov">       1785 :     if (!a || !b)</span>
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    1288 </span>            : 
<span class="lineNum">    1289 </span><span class="lineCov">       4647 :     while (*a &amp;&amp; *b) {</span>
<span class="lineNum">    1290 </span>            :         /* first time preallocate macro_equal_buf, next time only reset position to start */
<span class="lineNum">    1291 </span><span class="lineCov">       1077 :         cstr_reset(&amp;macro_equal_buf);</span>
<span class="lineNum">    1292 </span><span class="lineCov">       1077 :         TOK_GET(&amp;t, &amp;a, &amp;cv);</span>
<span class="lineNum">    1293 </span><span class="lineCov">       1077 :         cstr_cat(&amp;macro_equal_buf, get_tok_str(t, &amp;cv), 0);</span>
<span class="lineNum">    1294 </span><span class="lineCov">       1077 :         TOK_GET(&amp;t, &amp;b, &amp;cv);</span>
<span class="lineNum">    1295 </span><span class="lineCov">       1077 :         if (strcmp(macro_equal_buf.data, get_tok_str(t, &amp;cv)))</span>
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :             return 0;</span>
<span class="lineNum">    1297 </span>            :     }
<span class="lineNum">    1298 </span><span class="lineCov">       1785 :     return !(*a || *b);</span>
<span class="lineNum">    1299 </span>            : }
<a name="1300"><span class="lineNum">    1300 </span>            : </a>
<span class="lineNum">    1301 </span>            : /* defines handling */
<span class="lineNum">    1302 </span><span class="lineCov">     138748 : ST_INLN void define_push(int v, int macro_type, int *str, Sym *first_arg)</span>
<span class="lineNum">    1303 </span>            : {
<span class="lineNum">    1304 </span>            :     Sym *s, *o;
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineCov">     138748 :     o = define_find(v);</span>
<span class="lineNum">    1307 </span><span class="lineCov">     138748 :     s = sym_push2(&amp;define_stack, v, macro_type, 0);</span>
<span class="lineNum">    1308 </span><span class="lineCov">     138748 :     s-&gt;d = str;</span>
<span class="lineNum">    1309 </span><span class="lineCov">     138748 :     s-&gt;next = first_arg;</span>
<span class="lineNum">    1310 </span><span class="lineCov">     138748 :     table_ident[v - TOK_IDENT]-&gt;sym_define = s;</span>
<span class="lineNum">    1311 </span>            : 
<span class="lineNum">    1312 </span><span class="lineCov">     138748 :     if (o &amp;&amp; !macro_is_equal(o-&gt;d, s-&gt;d))</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :         tcc_warning(&quot;%s redefined&quot;, get_tok_str(v, NULL));</span>
<span class="lineNum">    1314 </span><span class="lineCov">     138748 : }</span>
<a name="1315"><span class="lineNum">    1315 </span>            : </a>
<span class="lineNum">    1316 </span>            : /* undefined a define symbol. Its name is just set to zero */
<span class="lineNum">    1317 </span><span class="lineCov">     177791 : ST_FUNC void define_undef(Sym *s)</span>
<span class="lineNum">    1318 </span>            : {
<span class="lineNum">    1319 </span><span class="lineCov">     177791 :     int v = s-&gt;v;</span>
<span class="lineNum">    1320 </span><span class="lineCov">     177791 :     if (v &gt;= TOK_IDENT &amp;&amp; v &lt; tok_ident)</span>
<span class="lineNum">    1321 </span><span class="lineCov">     140866 :         table_ident[v - TOK_IDENT]-&gt;sym_define = NULL;</span>
<a name="1322"><span class="lineNum">    1322 </span><span class="lineCov">     177791 : }</span></a>
<span class="lineNum">    1323 </span>            : 
<span class="lineNum">    1324 </span><span class="lineCov">     957579 : ST_INLN Sym *define_find(int v)</span>
<span class="lineNum">    1325 </span>            : {
<span class="lineNum">    1326 </span><span class="lineCov">     957579 :     v -= TOK_IDENT;</span>
<span class="lineNum">    1327 </span><span class="lineCov">     957579 :     if ((unsigned)v &gt;= (unsigned)(tok_ident - TOK_IDENT))</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1329 </span><span class="lineCov">     957579 :     return table_ident[v]-&gt;sym_define;</span>
<span class="lineNum">    1330 </span>            : }
<a name="1331"><span class="lineNum">    1331 </span>            : </a>
<span class="lineNum">    1332 </span>            : /* free define stack until top reaches 'b' */
<span class="lineNum">    1333 </span><span class="lineCov">       3344 : ST_FUNC void free_defines(Sym *b)</span>
<span class="lineNum">    1334 </span>            : {
<span class="lineNum">    1335 </span><span class="lineCov">     182361 :     while (define_stack != b) {</span>
<span class="lineNum">    1336 </span><span class="lineCov">     175673 :         Sym *top = define_stack;</span>
<span class="lineNum">    1337 </span><span class="lineCov">     175673 :         define_stack = top-&gt;prev;</span>
<span class="lineNum">    1338 </span><span class="lineCov">     175673 :         tok_str_free_str(top-&gt;d);</span>
<span class="lineNum">    1339 </span><span class="lineCov">     175673 :         define_undef(top);</span>
<span class="lineNum">    1340 </span><span class="lineCov">     175673 :         sym_free(top);</span>
<span class="lineNum">    1341 </span>            :     }
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span>            :     /* restore remaining (-D or predefined) symbols if they were
<span class="lineNum">    1344 </span>            :        #undef'd in the file */
<span class="lineNum">    1345 </span><span class="lineCov">      56848 :     while (b) {</span>
<span class="lineNum">    1346 </span><span class="lineCov">      50160 :         int v = b-&gt;v;</span>
<span class="lineNum">    1347 </span><span class="lineCov">      50160 :         if (v &gt;= TOK_IDENT &amp;&amp; v &lt; tok_ident) {</span>
<span class="lineNum">    1348 </span><span class="lineCov">      38456 :             Sym **d = &amp;table_ident[v - TOK_IDENT]-&gt;sym_define;</span>
<span class="lineNum">    1349 </span><span class="lineCov">      38456 :             if (!*d)</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :                 *d = b;</span>
<span class="lineNum">    1351 </span>            :         }
<span class="lineNum">    1352 </span><span class="lineCov">      50160 :         b = b-&gt;prev;</span>
<span class="lineNum">    1353 </span>            :     }
<span class="lineNum">    1354 </span><span class="lineCov">       3344 : }</span>
<a name="1355"><span class="lineNum">    1355 </span>            : </a>
<span class="lineNum">    1356 </span>            : /* label lookup */
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 : ST_FUNC Sym *label_find(int v)</span>
<span class="lineNum">    1358 </span>            : {
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :     v -= TOK_IDENT;</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :     if ((unsigned)v &gt;= (unsigned)(tok_ident - TOK_IDENT))</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     return table_ident[v]-&gt;sym_label;</span>
<a name="1363"><span class="lineNum">    1363 </span>            : }</a>
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 : ST_FUNC Sym *label_push(Sym **ptop, int v, int flags)</span>
<span class="lineNum">    1366 </span>            : {
<span class="lineNum">    1367 </span>            :     Sym *s, **ps;
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     s = sym_push2(ptop, v, 0, 0);</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :     s-&gt;r = flags;</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     ps = &amp;table_ident[v - TOK_IDENT]-&gt;sym_label;</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :     if (ptop == &amp;global_label_stack) {</span>
<span class="lineNum">    1372 </span>            :         /* modify the top most local identifier, so that
<span class="lineNum">    1373 </span>            :            sym_identifier will point to 's' when popped */
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :         while (*ps != NULL)</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :             ps = &amp;(*ps)-&gt;prev_tok;</span>
<span class="lineNum">    1376 </span>            :     }
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :     s-&gt;prev_tok = *ps;</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     *ps = s;</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     return s;</span>
<span class="lineNum">    1380 </span>            : }
<span class="lineNum">    1381 </span>            : 
<a name="1382"><span class="lineNum">    1382 </span>            : /* pop labels until element last is reached. Look if any labels are</a>
<span class="lineNum">    1383 </span>            :    undefined. Define symbols if '&amp;&amp;label' was used. */
<span class="lineNum">    1384 </span><span class="lineCov">       1153 : ST_FUNC void label_pop(Sym **ptop, Sym *slast, int keep)</span>
<span class="lineNum">    1385 </span>            : {
<span class="lineNum">    1386 </span>            :     Sym *s, *s1;
<span class="lineNum">    1387 </span><span class="lineCov">       1153 :     for(s = *ptop; s != slast; s = s1) {</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :         s1 = s-&gt;prev;</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         if (s-&gt;r == LABEL_DECLARED) {</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;label '%s' declared but not used&quot;, get_tok_str(s-&gt;v, NULL));</span>
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :         } else if (s-&gt;r == LABEL_FORWARD) {</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;label '%s' used but not defined&quot;,</span>
<span class="lineNum">    1393 </span>            :                       get_tok_str(s-&gt;v, NULL));
<span class="lineNum">    1394 </span>            :         } else {
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :             if (s-&gt;c) {</span>
<span class="lineNum">    1396 </span>            :                 /* define corresponding symbol. A size of
<span class="lineNum">    1397 </span>            :                    1 is put. */
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                 put_extern_sym(s, cur_text_section, s-&gt;jnext, 1);</span>
<span class="lineNum">    1399 </span>            :             }
<span class="lineNum">    1400 </span>            :         }
<span class="lineNum">    1401 </span>            :         /* remove label */
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :         table_ident[s-&gt;v - TOK_IDENT]-&gt;sym_label = s-&gt;prev_tok;</span>
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :         if (!keep)</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :             sym_free(s);</span>
<span class="lineNum">    1405 </span>            :     }
<span class="lineNum">    1406 </span><span class="lineCov">       1153 :     if (!keep)</span>
<span class="lineNum">    1407 </span><span class="lineCov">       1153 :         *ptop = slast;</span>
<span class="lineNum">    1408 </span><span class="lineCov">       1153 : }</span>
<a name="1409"><span class="lineNum">    1409 </span>            : </a>
<span class="lineNum">    1410 </span>            : /* fake the nth &quot;#if defined test_...&quot; for tcc -dt -run */
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 : static void maybe_run_test(TCCState *s)</span>
<span class="lineNum">    1412 </span>            : {
<span class="lineNum">    1413 </span>            :     const char *p;
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :     if (s-&gt;include_stack_ptr != s-&gt;include_stack)</span>
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :     p = get_tok_str(tok, NULL);</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :     if (0 != memcmp(p, &quot;test_&quot;, 5))</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :     if (0 != --s-&gt;run_test)</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :     fprintf(s-&gt;ppfp, &quot;\n[%s]\n&quot; + !(s-&gt;dflag &amp; 32), p), fflush(s-&gt;ppfp);</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :     define_push(tok, MACRO_OBJ, NULL, NULL);</span>
<span class="lineNum">    1423 </span>            : }
<a name="1424"><span class="lineNum">    1424 </span>            : </a>
<span class="lineNum">    1425 </span>            : /* eval an expression for #if/#elif */
<span class="lineNum">    1426 </span><span class="lineCov">      34001 : static int expr_preprocess(void)</span>
<span class="lineNum">    1427 </span>            : {
<span class="lineNum">    1428 </span>            :     int c, t;
<span class="lineNum">    1429 </span>            :     TokenString *str;
<span class="lineNum">    1430 </span>            :     
<span class="lineNum">    1431 </span><span class="lineCov">      34001 :     str = tok_str_alloc();</span>
<span class="lineNum">    1432 </span><span class="lineCov">      34001 :     pp_expr = 1;</span>
<span class="lineNum">    1433 </span><span class="lineCov">     283100 :     while (tok != TOK_LINEFEED &amp;&amp; tok != TOK_EOF) {</span>
<span class="lineNum">    1434 </span><span class="lineCov">     215098 :         next(); /* do macro subst */</span>
<span class="lineNum">    1435 </span><span class="lineCov">     215098 :         if (tok == TOK_DEFINED) {</span>
<span class="lineNum">    1436 </span><span class="lineCov">      55574 :             next_nomacro();</span>
<span class="lineNum">    1437 </span><span class="lineCov">      55574 :             t = tok;</span>
<span class="lineNum">    1438 </span><span class="lineCov">      55574 :             if (t == '(') </span>
<span class="lineNum">    1439 </span><span class="lineCov">        692 :                 next_nomacro();</span>
<span class="lineNum">    1440 </span><span class="lineCov">      55574 :             if (tok &lt; TOK_IDENT)</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                 expect(&quot;identifier&quot;);</span>
<span class="lineNum">    1442 </span><span class="lineCov">      55574 :             if (tcc_state-&gt;run_test)</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                 maybe_run_test(tcc_state);</span>
<span class="lineNum">    1444 </span><span class="lineCov">      55574 :             c = define_find(tok) != 0;</span>
<span class="lineNum">    1445 </span><span class="lineCov">      55574 :             if (t == '(') {</span>
<span class="lineNum">    1446 </span><span class="lineCov">        692 :                 next_nomacro();</span>
<span class="lineNum">    1447 </span><span class="lineCov">        692 :                 if (tok != ')')</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                     expect(&quot;')'&quot;);</span>
<span class="lineNum">    1449 </span>            :             }
<span class="lineNum">    1450 </span><span class="lineCov">      55574 :             tok = TOK_CINT;</span>
<span class="lineNum">    1451 </span><span class="lineCov">      55574 :             tokc.i = c;</span>
<span class="lineNum">    1452 </span><span class="lineCov">     159524 :         } else if (tok &gt;= TOK_IDENT) {</span>
<span class="lineNum">    1453 </span>            :             /* if undefined macro */
<span class="lineNum">    1454 </span><span class="lineCov">       3364 :             tok = TOK_CINT;</span>
<span class="lineNum">    1455 </span><span class="lineCov">       3364 :             tokc.i = 0;</span>
<span class="lineNum">    1456 </span>            :         }
<span class="lineNum">    1457 </span><span class="lineCov">     215098 :         tok_str_add_tok(str);</span>
<span class="lineNum">    1458 </span>            :     }
<span class="lineNum">    1459 </span><span class="lineCov">      34001 :     pp_expr = 0;</span>
<span class="lineNum">    1460 </span><span class="lineCov">      34001 :     tok_str_add(str, -1); /* simulate end of file */</span>
<span class="lineNum">    1461 </span><span class="lineCov">      34001 :     tok_str_add(str, 0);</span>
<span class="lineNum">    1462 </span>            :     /* now evaluate C constant expression */
<span class="lineNum">    1463 </span><span class="lineCov">      34001 :     begin_macro(str, 1);</span>
<span class="lineNum">    1464 </span><span class="lineCov">      34001 :     next();</span>
<span class="lineNum">    1465 </span><span class="lineCov">      34001 :     c = expr_const();</span>
<span class="lineNum">    1466 </span><span class="lineCov">      34001 :     end_macro();</span>
<span class="lineNum">    1467 </span><span class="lineCov">      34001 :     return c != 0;</span>
<span class="lineNum">    1468 </span>            : }
<span class="lineNum">    1469 </span>            : 
<a name="1470"><span class="lineNum">    1470 </span>            : </a>
<span class="lineNum">    1471 </span>            : /* parse after #define */
<span class="lineNum">    1472 </span><span class="lineCov">     130388 : ST_FUNC void parse_define(void)</span>
<span class="lineNum">    1473 </span>            : {
<span class="lineNum">    1474 </span>            :     Sym *s, *first, **ps;
<span class="lineNum">    1475 </span>            :     int v, t, varg, is_vaargs, spc;
<span class="lineNum">    1476 </span><span class="lineCov">     130388 :     int saved_parse_flags = parse_flags;</span>
<span class="lineNum">    1477 </span>            : 
<span class="lineNum">    1478 </span><span class="lineCov">     130388 :     v = tok;</span>
<span class="lineNum">    1479 </span><span class="lineCov">     130388 :     if (v &lt; TOK_IDENT || v == TOK_DEFINED)</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :         tcc_error(&quot;invalid macro name '%s'&quot;, get_tok_str(tok, &amp;tokc));</span>
<span class="lineNum">    1481 </span>            :     /* XXX: should check if same macro (ANSI) */
<span class="lineNum">    1482 </span><span class="lineCov">     130388 :     first = NULL;</span>
<span class="lineNum">    1483 </span><span class="lineCov">     130388 :     t = MACRO_OBJ;</span>
<span class="lineNum">    1484 </span>            :     /* We have to parse the whole define as if not in asm mode, in particular
<span class="lineNum">    1485 </span>            :        no line comment with '#' must be ignored.  Also for function
<span class="lineNum">    1486 </span>            :        macros the argument list must be parsed without '.' being an ID
<span class="lineNum">    1487 </span>            :        character.  */
<span class="lineNum">    1488 </span><span class="lineCov">     130388 :     parse_flags = ((parse_flags &amp; ~PARSE_FLAG_ASM_FILE) | PARSE_FLAG_SPACES);</span>
<span class="lineNum">    1489 </span>            :     /* '(' must be just after macro definition for MACRO_FUNC */
<span class="lineNum">    1490 </span><span class="lineCov">     130388 :     next_nomacro_spc();</span>
<span class="lineNum">    1491 </span><span class="lineCov">     130388 :     if (tok == '(') {</span>
<span class="lineNum">    1492 </span><span class="lineCov">      21765 :         int dotid = set_idnum('.', 0);</span>
<span class="lineNum">    1493 </span><span class="lineCov">      21765 :         next_nomacro();</span>
<span class="lineNum">    1494 </span><span class="lineCov">      21765 :         ps = &amp;first;</span>
<span class="lineNum">    1495 </span><span class="lineCov">      21765 :         if (tok != ')') for (;;) {</span>
<span class="lineNum">    1496 </span><span class="lineCov">      36925 :             varg = tok;</span>
<span class="lineNum">    1497 </span><span class="lineCov">      36925 :             next_nomacro();</span>
<span class="lineNum">    1498 </span><span class="lineCov">      36925 :             is_vaargs = 0;</span>
<span class="lineNum">    1499 </span><span class="lineCov">      36925 :             if (varg == TOK_DOTS) {</span>
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                 varg = TOK___VA_ARGS__;</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                 is_vaargs = 1;</span>
<span class="lineNum">    1502 </span><span class="lineCov">      36925 :             } else if (tok == TOK_DOTS &amp;&amp; gnu_ext) {</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                 is_vaargs = 1;</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :                 next_nomacro();</span>
<span class="lineNum">    1505 </span>            :             }
<span class="lineNum">    1506 </span><span class="lineCov">      36925 :             if (varg &lt; TOK_IDENT)</span>
<span class="lineNum">    1507 </span>            :         bad_list:
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;bad macro parameter list&quot;);</span>
<span class="lineNum">    1509 </span><span class="lineCov">      36925 :             s = sym_push2(&amp;define_stack, varg | SYM_FIELD, is_vaargs, 0);</span>
<span class="lineNum">    1510 </span><span class="lineCov">      36925 :             *ps = s;</span>
<span class="lineNum">    1511 </span><span class="lineCov">      36925 :             ps = &amp;s-&gt;next;</span>
<span class="lineNum">    1512 </span><span class="lineCov">      36925 :             if (tok == ')')</span>
<span class="lineNum">    1513 </span><span class="lineCov">      21765 :                 break;</span>
<span class="lineNum">    1514 </span><span class="lineCov">      15160 :             if (tok != ',' || is_vaargs)</span>
<span class="lineNum">    1515 </span>            :                 goto bad_list;
<span class="lineNum">    1516 </span><span class="lineCov">      15160 :             next_nomacro();</span>
<span class="lineNum">    1517 </span><span class="lineCov">      15160 :         }</span>
<span class="lineNum">    1518 </span><span class="lineCov">      21765 :         next_nomacro_spc();</span>
<span class="lineNum">    1519 </span><span class="lineCov">      21765 :         t = MACRO_FUNC;</span>
<span class="lineNum">    1520 </span><span class="lineCov">      21765 :         set_idnum('.', dotid);</span>
<span class="lineNum">    1521 </span>            :     }
<span class="lineNum">    1522 </span>            : 
<span class="lineNum">    1523 </span><span class="lineCov">     130388 :     tokstr_buf.len = 0;</span>
<span class="lineNum">    1524 </span><span class="lineCov">     130388 :     spc = 2;</span>
<span class="lineNum">    1525 </span><span class="lineCov">     130388 :     parse_flags |= PARSE_FLAG_ACCEPT_STRAYS | PARSE_FLAG_SPACES | PARSE_FLAG_LINEFEED;</span>
<span class="lineNum">    1526 </span>            :     /* The body of a macro definition should be parsed such that identifiers
<span class="lineNum">    1527 </span>            :        are parsed like the file mode determines (i.e. with '.' being an
<span class="lineNum">    1528 </span>            :        ID character in asm mode).  But '#' should be retained instead of
<span class="lineNum">    1529 </span>            :        regarded as line comment leader, so still don't set ASM_FILE
<span class="lineNum">    1530 </span>            :        in parse_flags. */
<span class="lineNum">    1531 </span><span class="lineCov">     786683 :     while (tok != TOK_LINEFEED &amp;&amp; tok != TOK_EOF) {</span>
<span class="lineNum">    1532 </span>            :         /* remove spaces around ## and after '#' */
<span class="lineNum">    1533 </span><span class="lineCov">     525907 :         if (TOK_TWOSHARPS == tok) {</span>
<span class="lineNum">    1534 </span><span class="lineCov">        350 :             if (2 == spc)</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :                 goto bad_twosharp;</span>
<span class="lineNum">    1536 </span><span class="lineCov">        350 :             if (1 == spc)</span>
<span class="lineNum">    1537 </span><span class="lineCov">        330 :                 --tokstr_buf.len;</span>
<span class="lineNum">    1538 </span><span class="lineCov">        350 :             spc = 3;</span>
<span class="lineNum">    1539 </span><span class="lineCov">        350 :             tok = TOK_PPJOIN;</span>
<span class="lineNum">    1540 </span><span class="lineCov">     525557 :         } else if ('#' == tok) {</span>
<span class="lineNum">    1541 </span><span class="lineCov">       3674 :             spc = 4;</span>
<span class="lineNum">    1542 </span><span class="lineCov">     521883 :         } else if (check_space(tok, &amp;spc)) {</span>
<span class="lineNum">    1543 </span><span class="lineCov">     179963 :             goto skip;</span>
<span class="lineNum">    1544 </span>            :         }
<span class="lineNum">    1545 </span><span class="lineCov">     345944 :         tok_str_add2(&amp;tokstr_buf, tok, &amp;tokc);</span>
<span class="lineNum">    1546 </span>            :     skip:
<span class="lineNum">    1547 </span><span class="lineCov">     525907 :         next_nomacro_spc();</span>
<span class="lineNum">    1548 </span>            :     }
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineCov">     130388 :     parse_flags = saved_parse_flags;</span>
<span class="lineNum">    1551 </span><span class="lineCov">     130388 :     if (spc == 1)</span>
<span class="lineNum">    1552 </span><span class="lineCov">       4783 :         --tokstr_buf.len; /* remove trailing space */</span>
<span class="lineNum">    1553 </span><span class="lineCov">     130388 :     tok_str_add(&amp;tokstr_buf, 0);</span>
<span class="lineNum">    1554 </span><span class="lineCov">     130388 :     if (3 == spc)</span>
<span class="lineNum">    1555 </span>            : bad_twosharp:
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :         tcc_error(&quot;'##' cannot appear at either end of macro&quot;);</span>
<span class="lineNum">    1557 </span><span class="lineCov">     130388 :     define_push(v, t, tok_str_dup(&amp;tokstr_buf), first);</span>
<a name="1558"><span class="lineNum">    1558 </span><span class="lineCov">     130388 : }</span></a>
<span class="lineNum">    1559 </span>            : 
<span class="lineNum">    1560 </span><span class="lineCov">      36926 : static CachedInclude *search_cached_include(TCCState *s1, const char *filename, int add)</span>
<span class="lineNum">    1561 </span>            : {
<span class="lineNum">    1562 </span>            :     const unsigned char *s;
<span class="lineNum">    1563 </span>            :     unsigned int h;
<span class="lineNum">    1564 </span>            :     CachedInclude *e;
<span class="lineNum">    1565 </span>            :     int i;
<span class="lineNum">    1566 </span>            : 
<span class="lineNum">    1567 </span><span class="lineCov">      36926 :     h = TOK_HASH_INIT;</span>
<span class="lineNum">    1568 </span><span class="lineCov">      36926 :     s = (unsigned char *) filename;</span>
<span class="lineNum">    1569 </span><span class="lineCov">    1662745 :     while (*s) {</span>
<span class="lineNum">    1570 </span>            : #ifdef _WIN32
<span class="lineNum">    1571 </span>            :         h = TOK_HASH_FUNC(h, toup(*s));
<span class="lineNum">    1572 </span>            : #else
<span class="lineNum">    1573 </span><span class="lineCov">    1588893 :         h = TOK_HASH_FUNC(h, *s);</span>
<span class="lineNum">    1574 </span>            : #endif
<span class="lineNum">    1575 </span><span class="lineCov">    1588893 :         s++;</span>
<span class="lineNum">    1576 </span>            :     }
<span class="lineNum">    1577 </span><span class="lineCov">      36926 :     h &amp;= (CACHED_INCLUDES_HASH_SIZE - 1);</span>
<span class="lineNum">    1578 </span>            : 
<span class="lineNum">    1579 </span><span class="lineCov">      36926 :     i = s1-&gt;cached_includes_hash[h];</span>
<span class="lineNum">    1580 </span>            :     for(;;) {
<span class="lineNum">    1581 </span><span class="lineCov">      40932 :         if (i == 0)</span>
<span class="lineNum">    1582 </span><span class="lineCov">      35751 :             break;</span>
<span class="lineNum">    1583 </span><span class="lineCov">       5181 :         e = s1-&gt;cached_includes[i - 1];</span>
<span class="lineNum">    1584 </span><span class="lineCov">       5181 :         if (0 == PATHCMP(e-&gt;filename, filename))</span>
<span class="lineNum">    1585 </span><span class="lineCov">       1175 :             return e;</span>
<span class="lineNum">    1586 </span><span class="lineCov">       4006 :         i = e-&gt;hash_next;</span>
<span class="lineNum">    1587 </span><span class="lineCov">       4006 :     }</span>
<span class="lineNum">    1588 </span><span class="lineCov">      35751 :     if (!add)</span>
<span class="lineNum">    1589 </span><span class="lineCov">      33021 :         return NULL;</span>
<span class="lineNum">    1590 </span>            : 
<span class="lineNum">    1591 </span><span class="lineCov">       2730 :     e = tcc_malloc(sizeof(CachedInclude) + strlen(filename));</span>
<span class="lineNum">    1592 </span><span class="lineCov">       2730 :     strcpy(e-&gt;filename, filename);</span>
<span class="lineNum">    1593 </span><span class="lineCov">       2730 :     e-&gt;ifndef_macro = e-&gt;once = 0;</span>
<span class="lineNum">    1594 </span><span class="lineCov">       2730 :     dynarray_add(&amp;s1-&gt;cached_includes, &amp;s1-&gt;nb_cached_includes, e);</span>
<span class="lineNum">    1595 </span>            :     /* add in hash table */
<span class="lineNum">    1596 </span><span class="lineCov">       2730 :     e-&gt;hash_next = s1-&gt;cached_includes_hash[h];</span>
<span class="lineNum">    1597 </span><span class="lineCov">       2730 :     s1-&gt;cached_includes_hash[h] = s1-&gt;nb_cached_includes;</span>
<span class="lineNum">    1598 </span>            : #ifdef INC_DEBUG
<span class="lineNum">    1599 </span>            :     printf(&quot;adding cached '%s'\n&quot;, filename);
<span class="lineNum">    1600 </span>            : #endif
<span class="lineNum">    1601 </span><span class="lineCov">       2730 :     return e;</span>
<a name="1602"><span class="lineNum">    1602 </span>            : }</a>
<span class="lineNum">    1603 </span>            : 
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 : static void pragma_parse(TCCState *s1)</span>
<span class="lineNum">    1605 </span>            : {
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 :     next_nomacro();</span>
<span class="lineNum">    1607 </span><span class="lineNoCov">          0 :     if (tok == TOK_push_macro || tok == TOK_pop_macro) {</span>
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :         int t = tok, v;</span>
<span class="lineNum">    1609 </span>            :         Sym *s;
<span class="lineNum">    1610 </span>            : 
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :         if (next(), tok != '(')</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :         if (next(), tok != TOK_STR)</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :         v = tok_alloc(tokc.str.data, tokc.str.size - 1)-&gt;tok;</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :         if (next(), tok != ')')</span>
<span class="lineNum">    1617 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :         if (t == TOK_push_macro) {</span>
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :             while (NULL == (s = define_find(v)))</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :                 define_push(v, 0, NULL, NULL);</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :             s-&gt;type.ref = s; /* set push boundary */</span>
<span class="lineNum">    1622 </span>            :         } else {
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :             for (s = define_stack; s; s = s-&gt;prev)</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :                 if (s-&gt;v == v &amp;&amp; s-&gt;type.ref == s) {</span>
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :                     s-&gt;type.ref = NULL;</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    1627 </span>            :                 }
<span class="lineNum">    1628 </span>            :         }
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :         if (s)</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :             table_ident[v - TOK_IDENT]-&gt;sym_define = s-&gt;d ? s : NULL;</span>
<span class="lineNum">    1631 </span>            :         else
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;unbalanced #pragma pop_macro&quot;);</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :         pp_debug_tok = t, pp_debug_symv = v;</span>
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :     } else if (tok == TOK_once) {</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :         search_cached_include(s1, file-&gt;filename, 1)-&gt;once = pp_once;</span>
<span class="lineNum">    1637 </span>            : 
<span class="lineNum">    1638 </span><span class="lineNoCov">          0 :     } else if (s1-&gt;output_type == TCC_OUTPUT_PREPROCESS) {</span>
<span class="lineNum">    1639 </span>            :         /* tcc -E: keep pragmas below unchanged */
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :         unget_tok(' ');</span>
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 :         unget_tok(TOK_PRAGMA);</span>
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :         unget_tok('#');</span>
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :         unget_tok(TOK_LINEFEED);</span>
<span class="lineNum">    1644 </span>            : 
<span class="lineNum">    1645 </span><span class="lineNoCov">          0 :     } else if (tok == TOK_pack) {</span>
<span class="lineNum">    1646 </span>            :         /* This may be:
<span class="lineNum">    1647 </span>            :            #pragma pack(1) // set
<span class="lineNum">    1648 </span>            :            #pragma pack() // reset to default
<span class="lineNum">    1649 </span>            :            #pragma pack(push,1) // push &amp; set
<span class="lineNum">    1650 </span>            :            #pragma pack(pop) // restore previous */
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :         skip('(');</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :         if (tok == TOK_ASM_pop) {</span>
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :             next();</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :             if (s1-&gt;pack_stack_ptr &lt;= s1-&gt;pack_stack) {</span>
<span class="lineNum">    1656 </span>            :             stk_error:
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;out of pack stack&quot;);</span>
<span class="lineNum">    1658 </span>            :             }
<span class="lineNum">    1659 </span><span class="lineNoCov">          0 :             s1-&gt;pack_stack_ptr--;</span>
<span class="lineNum">    1660 </span>            :         } else {
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 :             int val = 0;</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :             if (tok != ')') {</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :                 if (tok == TOK_ASM_push) {</span>
<span class="lineNum">    1664 </span><span class="lineNoCov">          0 :                     next();</span>
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :                     if (s1-&gt;pack_stack_ptr &gt;= s1-&gt;pack_stack + PACK_STACK_SIZE - 1)</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :                         goto stk_error;</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :                     s1-&gt;pack_stack_ptr++;</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :                     skip(',');</span>
<span class="lineNum">    1669 </span>            :                 }
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :                 if (tok != TOK_CINT)</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :                     goto pragma_err;</span>
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :                 val = tokc.i;</span>
<span class="lineNum">    1673 </span><span class="lineNoCov">          0 :                 if (val &lt; 1 || val &gt; 16 || (val &amp; (val - 1)) != 0)</span>
<span class="lineNum">    1674 </span>            :                     goto pragma_err;
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                 next();</span>
<span class="lineNum">    1676 </span>            :             }
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :             *s1-&gt;pack_stack_ptr = val;</span>
<span class="lineNum">    1678 </span>            :         }
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :         if (tok != ')')</span>
<span class="lineNum">    1680 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :     } else if (tok == TOK_comment) {</span>
<span class="lineNum">    1683 </span>            :         char *p; int t;
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :         skip('(');</span>
<span class="lineNum">    1686 </span><span class="lineNoCov">          0 :         t = tok;</span>
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1688 </span><span class="lineNoCov">          0 :         skip(',');</span>
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :         if (tok != TOK_STR)</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :         p = tcc_strdup((char *)tokc.str.data);</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1693 </span><span class="lineNoCov">          0 :         if (tok != ')')</span>
<span class="lineNum">    1694 </span><span class="lineNoCov">          0 :             goto pragma_err;</span>
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :         if (t == TOK_lib) {</span>
<span class="lineNum">    1696 </span><span class="lineNoCov">          0 :             dynarray_add(&amp;s1-&gt;pragma_libs, &amp;s1-&gt;nb_pragma_libs, p);</span>
<span class="lineNum">    1697 </span>            :         } else {
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :             if (t == TOK_option)</span>
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :                 tcc_set_options(s1, p);</span>
<span class="lineNum">    1700 </span><span class="lineNoCov">          0 :             tcc_free(p);</span>
<span class="lineNum">    1701 </span>            :         }
<span class="lineNum">    1702 </span>            : 
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :     } else if (s1-&gt;warn_unsupported) {</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :         tcc_warning(&quot;#pragma %s is ignored&quot;, get_tok_str(tok, &amp;tokc));</span>
<span class="lineNum">    1705 </span>            :     }
<span class="lineNum">    1706 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1707 </span>            : 
<span class="lineNum">    1708 </span>            : pragma_err:
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :     tcc_error(&quot;malformed #pragma directive&quot;);</span>
<span class="lineNum">    1710 </span>            :     return;
<span class="lineNum">    1711 </span>            : }
<a name="1712"><span class="lineNum">    1712 </span>            : </a>
<span class="lineNum">    1713 </span>            : /* is_bof is true if first non space token at beginning of file */
<span class="lineNum">    1714 </span><span class="lineCov">     242601 : ST_FUNC void preprocess(int is_bof)</span>
<span class="lineNum">    1715 </span>            : {
<span class="lineNum">    1716 </span><span class="lineCov">     242601 :     TCCState *s1 = tcc_state;</span>
<span class="lineNum">    1717 </span>            :     int i, c, n, saved_parse_flags;
<span class="lineNum">    1718 </span>            :     char buf[1024], *q;
<span class="lineNum">    1719 </span>            :     Sym *s;
<span class="lineNum">    1720 </span>            : 
<span class="lineNum">    1721 </span><span class="lineCov">     242601 :     saved_parse_flags = parse_flags;</span>
<span class="lineNum">    1722 </span><span class="lineCov">     242601 :     parse_flags = PARSE_FLAG_PREPROCESS</span>
<span class="lineNum">    1723 </span>            :         | PARSE_FLAG_TOK_NUM
<span class="lineNum">    1724 </span>            :         | PARSE_FLAG_TOK_STR
<span class="lineNum">    1725 </span>            :         | PARSE_FLAG_LINEFEED
<span class="lineNum">    1726 </span><span class="lineCov">     242601 :         | (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">    1727 </span>            :         ;
<span class="lineNum">    1728 </span>            : 
<span class="lineNum">    1729 </span><span class="lineCov">     242601 :     next_nomacro();</span>
<span class="lineNum">    1730 </span>            :  redo:
<span class="lineNum">    1731 </span><span class="lineCov">     286374 :     switch(tok) {</span>
<span class="lineNum">    1732 </span>            :     case TOK_DEFINE:
<span class="lineNum">    1733 </span><span class="lineCov">      98620 :         pp_debug_tok = tok;</span>
<span class="lineNum">    1734 </span><span class="lineCov">      98620 :         next_nomacro();</span>
<span class="lineNum">    1735 </span><span class="lineCov">      98620 :         pp_debug_symv = tok;</span>
<span class="lineNum">    1736 </span><span class="lineCov">      98620 :         parse_define();</span>
<span class="lineNum">    1737 </span><span class="lineCov">      98620 :         break;</span>
<span class="lineNum">    1738 </span>            :     case TOK_UNDEF:
<span class="lineNum">    1739 </span><span class="lineCov">      13426 :         pp_debug_tok = tok;</span>
<span class="lineNum">    1740 </span><span class="lineCov">      13426 :         next_nomacro();</span>
<span class="lineNum">    1741 </span><span class="lineCov">      13426 :         pp_debug_symv = tok;</span>
<span class="lineNum">    1742 </span><span class="lineCov">      13426 :         s = define_find(tok);</span>
<span class="lineNum">    1743 </span>            :         /* undefine symbol by putting an invalid name */
<span class="lineNum">    1744 </span><span class="lineCov">      13426 :         if (s)</span>
<span class="lineNum">    1745 </span><span class="lineCov">       2118 :             define_undef(s);</span>
<span class="lineNum">    1746 </span><span class="lineCov">      13426 :         break;</span>
<span class="lineNum">    1747 </span>            :     case TOK_INCLUDE:
<span class="lineNum">    1748 </span>            :     case TOK_INCLUDE_NEXT:
<span class="lineNum">    1749 </span><span class="lineCov">       7425 :         ch = file-&gt;buf_ptr[0];</span>
<span class="lineNum">    1750 </span>            :         /* XXX: incorrect if comments : use next_nomacro with a special mode */
<span class="lineNum">    1751 </span><span class="lineCov">       7425 :         skip_spaces();</span>
<span class="lineNum">    1752 </span><span class="lineCov">       7425 :         if (ch == '&lt;') {</span>
<span class="lineNum">    1753 </span><span class="lineCov">       7423 :             c = '&gt;';</span>
<span class="lineNum">    1754 </span><span class="lineCov">       7423 :             goto read_name;</span>
<span class="lineNum">    1755 </span><span class="lineCov">          2 :         } else if (ch == '\&quot;') {</span>
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :             c = ch;</span>
<span class="lineNum">    1757 </span>            :         read_name:
<span class="lineNum">    1758 </span><span class="lineCov">       7423 :             inp();</span>
<span class="lineNum">    1759 </span><span class="lineCov">       7423 :             q = buf;</span>
<span class="lineNum">    1760 </span><span class="lineCov">      98919 :             while (ch != c &amp;&amp; ch != '\n' &amp;&amp; ch != CH_EOF) {</span>
<span class="lineNum">    1761 </span><span class="lineCov">      84073 :                 if ((q - buf) &lt; sizeof(buf) - 1)</span>
<span class="lineNum">    1762 </span><span class="lineCov">      84073 :                     *q++ = ch;</span>
<span class="lineNum">    1763 </span><span class="lineCov">      84073 :                 if (ch == '\\') {</span>
<span class="lineNum">    1764 </span><span class="lineCov">          1 :                     if (handle_stray_noerror() == 0)</span>
<span class="lineNum">    1765 </span><span class="lineNoCov">          0 :                         --q;</span>
<span class="lineNum">    1766 </span>            :                 } else
<span class="lineNum">    1767 </span><span class="lineCov">      84072 :                     inp();</span>
<span class="lineNum">    1768 </span>            :             }
<span class="lineNum">    1769 </span><span class="lineCov">       7423 :             *q = '\0';</span>
<span class="lineNum">    1770 </span><span class="lineCov">       7423 :             minp();</span>
<span class="lineNum">    1771 </span>            : #if 0
<span class="lineNum">    1772 </span>            :             /* eat all spaces and comments after include */
<span class="lineNum">    1773 </span>            :             /* XXX: slightly incorrect */
<span class="lineNum">    1774 </span>            :             while (ch1 != '\n' &amp;&amp; ch1 != CH_EOF)
<span class="lineNum">    1775 </span>            :                 inp();
<span class="lineNum">    1776 </span>            : #endif
<span class="lineNum">    1777 </span>            :         } else {
<span class="lineNum">    1778 </span>            :             int len;
<span class="lineNum">    1779 </span>            :             /* computed #include : concatenate everything up to linefeed,
<span class="lineNum">    1780 </span>            :                the result must be one of the two accepted forms.
<span class="lineNum">    1781 </span>            :                Don't convert pp-tokens to tokens here.  */
<span class="lineNum">    1782 </span><span class="lineCov">          2 :             parse_flags = (PARSE_FLAG_PREPROCESS</span>
<span class="lineNum">    1783 </span>            :                            | PARSE_FLAG_LINEFEED
<span class="lineNum">    1784 </span><span class="lineCov">          2 :                            | (parse_flags &amp; PARSE_FLAG_ASM_FILE));</span>
<span class="lineNum">    1785 </span><span class="lineCov">          2 :             next();</span>
<span class="lineNum">    1786 </span><span class="lineCov">          2 :             buf[0] = '\0';</span>
<span class="lineNum">    1787 </span><span class="lineCov">          4 :             while (tok != TOK_LINEFEED) {</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :                 pstrcat(buf, sizeof(buf), get_tok_str(tok, &amp;tokc));</span>
<span class="lineNum">    1789 </span><span class="lineNoCov">          0 :                 next();</span>
<span class="lineNum">    1790 </span>            :             }
<span class="lineNum">    1791 </span><span class="lineCov">          2 :             len = strlen(buf);</span>
<span class="lineNum">    1792 </span>            :             /* check syntax and remove '&lt;&gt;|&quot;&quot;' */
<span class="lineNum">    1793 </span><span class="lineCov">          2 :             if ((len &lt; 2 || ((buf[0] != '&quot;' || buf[len-1] != '&quot;') &amp;&amp;</span>
<span class="lineNum">    1794 </span><span class="lineNoCov">          0 :                              (buf[0] != '&lt;' || buf[len-1] != '&gt;'))))</span>
<span class="lineNum">    1795 </span><span class="lineCov">          2 :                 tcc_error(&quot;'#include' expects \&quot;FILENAME\&quot; or &lt;FILENAME&gt;&quot;);</span>
<span class="lineNum">    1796 </span><span class="lineNoCov">          0 :             c = buf[len-1];</span>
<span class="lineNum">    1797 </span><span class="lineNoCov">          0 :             memmove(buf, buf + 1, len - 2);</span>
<span class="lineNum">    1798 </span><span class="lineNoCov">          0 :             buf[len - 2] = '\0';</span>
<span class="lineNum">    1799 </span>            :         }
<span class="lineNum">    1800 </span>            : 
<span class="lineNum">    1801 </span><span class="lineCov">       7423 :         if (s1-&gt;include_stack_ptr &gt;= s1-&gt;include_stack + INCLUDE_STACK_SIZE)</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#include recursion too deep&quot;);</span>
<span class="lineNum">    1803 </span>            :         /* store current file in stack, but increment stack later below */
<span class="lineNum">    1804 </span><span class="lineCov">       7423 :         *s1-&gt;include_stack_ptr = file;</span>
<span class="lineNum">    1805 </span><span class="lineCov">       7423 :         i = tok == TOK_INCLUDE_NEXT ? file-&gt;include_next_index : 0;</span>
<span class="lineNum">    1806 </span><span class="lineCov">       7423 :         n = 2 + s1-&gt;nb_include_paths + s1-&gt;nb_sysinclude_paths;</span>
<span class="lineNum">    1807 </span><span class="lineCov">      49055 :         for (; i &lt; n; ++i) {</span>
<span class="lineNum">    1808 </span>            :             char buf1[sizeof file-&gt;filename];
<span class="lineNum">    1809 </span>            :             CachedInclude *e;
<span class="lineNum">    1810 </span>            :             const char *path;
<span class="lineNum">    1811 </span>            : 
<span class="lineNum">    1812 </span><span class="lineCov">      49034 :             if (i == 0) {</span>
<span class="lineNum">    1813 </span>            :                 /* check absolute include path */
<span class="lineNum">    1814 </span><span class="lineCov">       7423 :                 if (!IS_ABSPATH(buf))</span>
<span class="lineNum">    1815 </span><span class="lineCov">      49055 :                     continue;</span>
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 :                 buf1[0] = 0;</span>
<span class="lineNum">    1817 </span>            : 
<span class="lineNum">    1818 </span><span class="lineCov">      41611 :             } else if (i == 1) {</span>
<span class="lineNum">    1819 </span>            :                 /* search in file's dir if &quot;header.h&quot; */
<span class="lineNum">    1820 </span><span class="lineCov">       7423 :                 if (c != '\&quot;')</span>
<span class="lineNum">    1821 </span><span class="lineCov">       7423 :                     continue;</span>
<span class="lineNum">    1822 </span>            :                 /* https://savannah.nongnu.org/bugs/index.php?50847 */
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :                 path = file-&gt;true_filename;</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :                 pstrncpy(buf1, path, tcc_basename(path) - path);</span>
<span class="lineNum">    1825 </span>            : 
<span class="lineNum">    1826 </span>            :             } else {
<span class="lineNum">    1827 </span>            :                 /* search in all the include paths */
<span class="lineNum">    1828 </span><span class="lineCov">      34188 :                 int j = i - 2, k = j - s1-&gt;nb_include_paths;</span>
<span class="lineNum">    1829 </span><span class="lineCov">      34188 :                 path = k &lt; 0 ? s1-&gt;include_paths[j] : s1-&gt;sysinclude_paths[k];</span>
<span class="lineNum">    1830 </span><span class="lineCov">      34188 :                 pstrcpy(buf1, sizeof(buf1), path);</span>
<span class="lineNum">    1831 </span><span class="lineCov">      34188 :                 pstrcat(buf1, sizeof(buf1), &quot;/&quot;);</span>
<span class="lineNum">    1832 </span>            :             }
<span class="lineNum">    1833 </span>            : 
<span class="lineNum">    1834 </span><span class="lineCov">      34188 :             pstrcat(buf1, sizeof(buf1), buf);</span>
<span class="lineNum">    1835 </span><span class="lineCov">      34188 :             e = search_cached_include(s1, buf1, 0);</span>
<span class="lineNum">    1836 </span><span class="lineCov">      34188 :             if (e &amp;&amp; (define_find(e-&gt;ifndef_macro) || e-&gt;once == pp_once)) {</span>
<span class="lineNum">    1837 </span>            :                 /* no need to parse the include because the 'ifndef macro'
<span class="lineNum">    1838 </span>            :                    is defined (or had #pragma once) */
<span class="lineNum">    1839 </span>            : #ifdef INC_DEBUG
<span class="lineNum">    1840 </span>            :                 printf(&quot;%s: skipping cached %s\n&quot;, file-&gt;filename, buf1);
<span class="lineNum">    1841 </span>            : #endif
<span class="lineNum">    1842 </span>            :                 goto include_done;
<span class="lineNum">    1843 </span>            :             }
<span class="lineNum">    1844 </span>            : 
<span class="lineNum">    1845 </span><span class="lineCov">      33029 :             if (tcc_open(s1, buf1) &lt; 0)</span>
<span class="lineNum">    1846 </span><span class="lineCov">      26786 :                 continue;</span>
<span class="lineNum">    1847 </span>            : 
<span class="lineNum">    1848 </span><span class="lineCov">       6243 :             file-&gt;include_next_index = i + 1;</span>
<span class="lineNum">    1849 </span>            : #ifdef INC_DEBUG
<span class="lineNum">    1850 </span>            :             printf(&quot;%s: including %s\n&quot;, file-&gt;prev-&gt;filename, file-&gt;filename);
<span class="lineNum">    1851 </span>            : #endif
<span class="lineNum">    1852 </span>            :             /* update target deps */
<span class="lineNum">    1853 </span><span class="lineCov">       6243 :             dynarray_add(&amp;s1-&gt;target_deps, &amp;s1-&gt;nb_target_deps,</span>
<span class="lineNum">    1854 </span><span class="lineCov">       6243 :                     tcc_strdup(buf1));</span>
<span class="lineNum">    1855 </span>            :             /* push current file in stack */
<span class="lineNum">    1856 </span><span class="lineCov">       6243 :             ++s1-&gt;include_stack_ptr;</span>
<span class="lineNum">    1857 </span>            :             /* add include file debug info */
<span class="lineNum">    1858 </span><span class="lineCov">       6243 :             if (s1-&gt;do_debug)</span>
<span class="lineNum">    1859 </span><span class="lineNoCov">          0 :                 put_stabs(file-&gt;filename, N_BINCL, 0, 0, 0);</span>
<span class="lineNum">    1860 </span><span class="lineCov">       6243 :             tok_flags |= TOK_FLAG_BOF | TOK_FLAG_BOL;</span>
<span class="lineNum">    1861 </span><span class="lineCov">       6243 :             ch = file-&gt;buf_ptr[0];</span>
<span class="lineNum">    1862 </span><span class="lineCov">       6243 :             goto the_end;</span>
<span class="lineNum">    1863 </span>            :         }
<span class="lineNum">    1864 </span><span class="lineCov">         21 :         tcc_error(&quot;include file '%s' not found&quot;, buf);</span>
<span class="lineNum">    1865 </span>            : include_done:
<span class="lineNum">    1866 </span><span class="lineCov">       1159 :         break;</span>
<span class="lineNum">    1867 </span>            :     case TOK_IFNDEF:
<span class="lineNum">    1868 </span><span class="lineCov">      12772 :         c = 1;</span>
<span class="lineNum">    1869 </span><span class="lineCov">      12772 :         goto do_ifdef;</span>
<span class="lineNum">    1870 </span>            :     case TOK_IF:
<span class="lineNum">    1871 </span><span class="lineCov">      33621 :         c = expr_preprocess();</span>
<span class="lineNum">    1872 </span><span class="lineCov">      33621 :         goto do_if;</span>
<span class="lineNum">    1873 </span>            :     case TOK_IFDEF:
<span class="lineNum">    1874 </span><span class="lineCov">      27100 :         c = 0;</span>
<span class="lineNum">    1875 </span>            :     do_ifdef:
<span class="lineNum">    1876 </span><span class="lineCov">      39872 :         next_nomacro();</span>
<span class="lineNum">    1877 </span><span class="lineCov">      39872 :         if (tok &lt; TOK_IDENT)</span>
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :             tcc_error(&quot;invalid argument for '#if%sdef'&quot;, c ? &quot;n&quot; : &quot;&quot;);</span>
<span class="lineNum">    1879 </span><span class="lineCov">      39872 :         if (is_bof) {</span>
<span class="lineNum">    1880 </span><span class="lineCov">       4850 :             if (c) {</span>
<span class="lineNum">    1881 </span>            : #ifdef INC_DEBUG
<span class="lineNum">    1882 </span>            :                 printf(&quot;#ifndef %s\n&quot;, get_tok_str(tok, NULL));
<span class="lineNum">    1883 </span>            : #endif
<span class="lineNum">    1884 </span><span class="lineCov">       4520 :                 file-&gt;ifndef_macro = tok;</span>
<span class="lineNum">    1885 </span>            :             }
<span class="lineNum">    1886 </span>            :         }
<span class="lineNum">    1887 </span><span class="lineCov">      39872 :         c = (define_find(tok) != 0) ^ c;</span>
<span class="lineNum">    1888 </span>            :     do_if:
<span class="lineNum">    1889 </span><span class="lineCov">      73493 :         if (s1-&gt;ifdef_stack_ptr &gt;= s1-&gt;ifdef_stack + IFDEF_STACK_SIZE)</span>
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :             tcc_error(&quot;memory full (ifdef)&quot;);</span>
<span class="lineNum">    1891 </span><span class="lineCov">      73493 :         *s1-&gt;ifdef_stack_ptr++ = c;</span>
<span class="lineNum">    1892 </span><span class="lineCov">      73493 :         goto test_skip;</span>
<span class="lineNum">    1893 </span>            :     case TOK_ELSE:
<span class="lineNum">    1894 </span><span class="lineCov">      18854 :         if (s1-&gt;ifdef_stack_ptr == s1-&gt;ifdef_stack)</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#else without matching #if&quot;);</span>
<span class="lineNum">    1896 </span><span class="lineCov">      18854 :         if (s1-&gt;ifdef_stack_ptr[-1] &amp; 2)</span>
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#else after #else&quot;);</span>
<span class="lineNum">    1898 </span><span class="lineCov">      18854 :         c = (s1-&gt;ifdef_stack_ptr[-1] ^= 3);</span>
<span class="lineNum">    1899 </span><span class="lineCov">      18854 :         goto test_else;</span>
<span class="lineNum">    1900 </span>            :     case TOK_ELIF:
<span class="lineNum">    1901 </span><span class="lineCov">       1053 :         if (s1-&gt;ifdef_stack_ptr == s1-&gt;ifdef_stack)</span>
<span class="lineNum">    1902 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#elif without matching #if&quot;);</span>
<span class="lineNum">    1903 </span><span class="lineCov">       1053 :         c = s1-&gt;ifdef_stack_ptr[-1];</span>
<span class="lineNum">    1904 </span><span class="lineCov">       1053 :         if (c &gt; 1)</span>
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#elif after #else&quot;);</span>
<span class="lineNum">    1906 </span>            :         /* last #if/#elif expression was true: we skip */
<span class="lineNum">    1907 </span><span class="lineCov">       1053 :         if (c == 1) {</span>
<span class="lineNum">    1908 </span><span class="lineCov">        673 :             c = 0;</span>
<span class="lineNum">    1909 </span>            :         } else {
<span class="lineNum">    1910 </span><span class="lineCov">        380 :             c = expr_preprocess();</span>
<span class="lineNum">    1911 </span><span class="lineCov">        380 :             s1-&gt;ifdef_stack_ptr[-1] = c;</span>
<span class="lineNum">    1912 </span>            :         }
<span class="lineNum">    1913 </span>            :     test_else:
<span class="lineNum">    1914 </span><span class="lineCov">      19907 :         if (s1-&gt;ifdef_stack_ptr == file-&gt;ifdef_stack_ptr + 1)</span>
<span class="lineNum">    1915 </span><span class="lineCov">        765 :             file-&gt;ifndef_macro = 0;</span>
<span class="lineNum">    1916 </span>            :     test_skip:
<span class="lineNum">    1917 </span><span class="lineCov">      93400 :         if (!(c &amp; 1)) {</span>
<span class="lineNum">    1918 </span><span class="lineCov">      43776 :             preprocess_skip();</span>
<span class="lineNum">    1919 </span><span class="lineCov">      43776 :             is_bof = 0;</span>
<span class="lineNum">    1920 </span><span class="lineCov">      43776 :             goto redo;</span>
<span class="lineNum">    1921 </span>            :         }
<span class="lineNum">    1922 </span><span class="lineCov">      49624 :         break;</span>
<span class="lineNum">    1923 </span>            :     case TOK_ENDIF:
<span class="lineNum">    1924 </span><span class="lineCov">      73493 :         if (s1-&gt;ifdef_stack_ptr &lt;= file-&gt;ifdef_stack_ptr)</span>
<span class="lineNum">    1925 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#endif without matching #if&quot;);</span>
<span class="lineNum">    1926 </span><span class="lineCov">      73493 :         s1-&gt;ifdef_stack_ptr--;</span>
<span class="lineNum">    1927 </span>            :         /* '#ifndef macro' was at the start of file. Now we check if
<span class="lineNum">    1928 </span>            :            an '#endif' is exactly at the end of file */
<span class="lineNum">    1929 </span><span class="lineCov">     138968 :         if (file-&gt;ifndef_macro &amp;&amp;</span>
<span class="lineNum">    1930 </span><span class="lineCov">      65475 :             s1-&gt;ifdef_stack_ptr == file-&gt;ifdef_stack_ptr) {</span>
<span class="lineNum">    1931 </span><span class="lineCov">       4520 :             file-&gt;ifndef_macro_saved = file-&gt;ifndef_macro;</span>
<span class="lineNum">    1932 </span>            :             /* need to set to zero to avoid false matches if another
<span class="lineNum">    1933 </span>            :                #ifndef at middle of file */
<span class="lineNum">    1934 </span><span class="lineCov">       4520 :             file-&gt;ifndef_macro = 0;</span>
<span class="lineNum">    1935 </span><span class="lineCov">      13560 :             while (tok != TOK_LINEFEED)</span>
<span class="lineNum">    1936 </span><span class="lineCov">       4520 :                 next_nomacro();</span>
<span class="lineNum">    1937 </span><span class="lineCov">       4520 :             tok_flags |= TOK_FLAG_ENDIF;</span>
<span class="lineNum">    1938 </span><span class="lineCov">       4520 :             goto the_end;</span>
<span class="lineNum">    1939 </span>            :         }
<span class="lineNum">    1940 </span><span class="lineCov">      68973 :         break;</span>
<span class="lineNum">    1941 </span>            :     case TOK_PPNUM:
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :         n = strtoul((char*)tokc.str.data, &amp;q, 10);</span>
<span class="lineNum">    1943 </span><span class="lineNoCov">          0 :         goto _line_num;</span>
<span class="lineNum">    1944 </span>            :     case TOK_LINE:
<span class="lineNum">    1945 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :         if (tok != TOK_CINT)</span>
<span class="lineNum">    1947 </span>            :     _line_err:
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :             tcc_error(&quot;wrong #line format&quot;);</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :         n = tokc.i;</span>
<span class="lineNum">    1950 </span>            :     _line_num:
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :         if (tok != TOK_LINEFEED) {</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :             if (tok == TOK_STR) {</span>
<span class="lineNum">    1954 </span><span class="lineNoCov">          0 :                 if (file-&gt;true_filename == file-&gt;filename)</span>
<span class="lineNum">    1955 </span><span class="lineNoCov">          0 :                     file-&gt;true_filename = tcc_strdup(file-&gt;filename);</span>
<span class="lineNum">    1956 </span><span class="lineNoCov">          0 :                 pstrcpy(file-&gt;filename, sizeof(file-&gt;filename), (char *)tokc.str.data);</span>
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :             } else if (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1959 </span>            :             else
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :                 goto _line_err;</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :             --n;</span>
<span class="lineNum">    1962 </span>            :         }
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :         if (file-&gt;fd &gt; 0)</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :             total_lines += file-&gt;line_num - n;</span>
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 :         file-&gt;line_num = n;</span>
<span class="lineNum">    1966 </span><span class="lineNoCov">          0 :         if (s1-&gt;do_debug)</span>
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :             put_stabs(file-&gt;filename, N_BINCL, 0, 0, 0);</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1969 </span>            :     case TOK_ERROR:
<span class="lineNum">    1970 </span>            :     case TOK_WARNING:
<span class="lineNum">    1971 </span><span class="lineNoCov">          0 :         c = tok;</span>
<span class="lineNum">    1972 </span><span class="lineNoCov">          0 :         ch = file-&gt;buf_ptr[0];</span>
<span class="lineNum">    1973 </span><span class="lineNoCov">          0 :         skip_spaces();</span>
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 :         q = buf;</span>
<span class="lineNum">    1975 </span><span class="lineNoCov">          0 :         while (ch != '\n' &amp;&amp; ch != CH_EOF) {</span>
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :             if ((q - buf) &lt; sizeof(buf) - 1)</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :                 *q++ = ch;</span>
<span class="lineNum">    1978 </span><span class="lineNoCov">          0 :             if (ch == '\\') {</span>
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :                 if (handle_stray_noerror() == 0)</span>
<span class="lineNum">    1980 </span><span class="lineNoCov">          0 :                     --q;</span>
<span class="lineNum">    1981 </span>            :             } else
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :                 inp();</span>
<span class="lineNum">    1983 </span>            :         }
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :         *q = '\0';</span>
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :         if (c == TOK_ERROR)</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :             tcc_error(&quot;#error %s&quot;, buf);</span>
<span class="lineNum">    1987 </span>            :         else
<span class="lineNum">    1988 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;#warning %s&quot;, buf);</span>
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1990 </span>            :     case TOK_PRAGMA:
<span class="lineNum">    1991 </span><span class="lineNoCov">          0 :         pragma_parse(s1);</span>
<span class="lineNum">    1992 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1993 </span>            :     case TOK_LINEFEED:
<span class="lineNum">    1994 </span><span class="lineCov">          1 :         goto the_end;</span>
<span class="lineNum">    1995 </span>            :     default:
<span class="lineNum">    1996 </span>            :         /* ignore gas line comment in an 'S' file. */
<span class="lineNum">    1997 </span><span class="lineCov">          9 :         if (saved_parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :             goto ignore;</span>
<span class="lineNum">    1999 </span><span class="lineCov">          9 :         if (tok == '!' &amp;&amp; is_bof)</span>
<span class="lineNum">    2000 </span>            :             /* '!' is ignored at beginning to allow C scripts. */
<span class="lineNum">    2001 </span><span class="lineNoCov">          0 :             goto ignore;</span>
<span class="lineNum">    2002 </span><span class="lineCov">          9 :         tcc_warning(&quot;Ignoring unknown preprocessing directive #%s&quot;, get_tok_str(tok, &amp;tokc));</span>
<span class="lineNum">    2003 </span>            :     ignore:
<span class="lineNum">    2004 </span><span class="lineCov">          9 :         file-&gt;buf_ptr = parse_line_comment(file-&gt;buf_ptr - 1);</span>
<span class="lineNum">    2005 </span><span class="lineCov">          9 :         goto the_end;</span>
<span class="lineNum">    2006 </span>            :     }
<span class="lineNum">    2007 </span>            :     /* ignore other preprocess commands or #! for C scripts */
<span class="lineNum">    2008 </span><span class="lineCov">     582320 :     while (tok != TOK_LINEFEED)</span>
<span class="lineNum">    2009 </span><span class="lineCov">     118716 :         next_nomacro();</span>
<span class="lineNum">    2010 </span>            :  the_end:
<span class="lineNum">    2011 </span><span class="lineCov">     242575 :     parse_flags = saved_parse_flags;</span>
<span class="lineNum">    2012 </span><span class="lineCov">     242575 : }</span>
<a name="2013"><span class="lineNum">    2013 </span>            : </a>
<span class="lineNum">    2014 </span>            : /* evaluate escape codes in a string. */
<span class="lineNum">    2015 </span><span class="lineCov">       3327 : static void parse_escape_string(CString *outstr, const uint8_t *buf, int is_long)</span>
<span class="lineNum">    2016 </span>            : {
<span class="lineNum">    2017 </span>            :     int c, n;
<span class="lineNum">    2018 </span>            :     const uint8_t *p;
<span class="lineNum">    2019 </span>            : 
<span class="lineNum">    2020 </span><span class="lineCov">       3327 :     p = buf;</span>
<span class="lineNum">    2021 </span>            :     for(;;) {
<span class="lineNum">    2022 </span><span class="lineCov">      53556 :         c = *p;</span>
<span class="lineNum">    2023 </span><span class="lineCov">      53556 :         if (c == '\0')</span>
<span class="lineNum">    2024 </span><span class="lineCov">       3327 :             break;</span>
<span class="lineNum">    2025 </span><span class="lineCov">      50229 :         if (c == '\\') {</span>
<span class="lineNum">    2026 </span><span class="lineCov">        927 :             p++;</span>
<span class="lineNum">    2027 </span>            :             /* escape */
<span class="lineNum">    2028 </span><span class="lineCov">        927 :             c = *p;</span>
<span class="lineNum">    2029 </span><span class="lineCov">        927 :             switch(c) {</span>
<span class="lineNum">    2030 </span>            :             case '0': case '1': case '2': case '3':
<span class="lineNum">    2031 </span>            :             case '4': case '5': case '6': case '7':
<span class="lineNum">    2032 </span>            :                 /* at most three octal digits */
<span class="lineNum">    2033 </span><span class="lineCov">         12 :                 n = c - '0';</span>
<span class="lineNum">    2034 </span><span class="lineCov">         12 :                 p++;</span>
<span class="lineNum">    2035 </span><span class="lineCov">         12 :                 c = *p;</span>
<span class="lineNum">    2036 </span><span class="lineCov">         12 :                 if (isoct(c)) {</span>
<span class="lineNum">    2037 </span><span class="lineNoCov">          0 :                     n = n * 8 + c - '0';</span>
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :                     p++;</span>
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :                     c = *p;</span>
<span class="lineNum">    2040 </span><span class="lineNoCov">          0 :                     if (isoct(c)) {</span>
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :                         n = n * 8 + c - '0';</span>
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :                         p++;</span>
<span class="lineNum">    2043 </span>            :                     }
<span class="lineNum">    2044 </span>            :                 }
<span class="lineNum">    2045 </span><span class="lineCov">         12 :                 c = n;</span>
<span class="lineNum">    2046 </span><span class="lineCov">         12 :                 goto add_char_nonext;</span>
<span class="lineNum">    2047 </span>            :             case 'x':
<span class="lineNum">    2048 </span>            :             case 'u':
<span class="lineNum">    2049 </span>            :             case 'U':
<span class="lineNum">    2050 </span><span class="lineNoCov">          0 :                 p++;</span>
<span class="lineNum">    2051 </span><span class="lineNoCov">          0 :                 n = 0;</span>
<span class="lineNum">    2052 </span>            :                 for(;;) {
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :                     c = *p;</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :                     if (c &gt;= 'a' &amp;&amp; c &lt;= 'f')</span>
<span class="lineNum">    2055 </span><span class="lineNoCov">          0 :                         c = c - 'a' + 10;</span>
<span class="lineNum">    2056 </span><span class="lineNoCov">          0 :                     else if (c &gt;= 'A' &amp;&amp; c &lt;= 'F')</span>
<span class="lineNum">    2057 </span><span class="lineNoCov">          0 :                         c = c - 'A' + 10;</span>
<span class="lineNum">    2058 </span><span class="lineNoCov">          0 :                     else if (isnum(c))</span>
<span class="lineNum">    2059 </span><span class="lineNoCov">          0 :                         c = c - '0';</span>
<span class="lineNum">    2060 </span>            :                     else
<span class="lineNum">    2061 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    2062 </span><span class="lineNoCov">          0 :                     n = n * 16 + c;</span>
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :                     p++;</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2065 </span><span class="lineNoCov">          0 :                 c = n;</span>
<span class="lineNum">    2066 </span><span class="lineNoCov">          0 :                 goto add_char_nonext;</span>
<span class="lineNum">    2067 </span>            :             case 'a':
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :                 c = '\a';</span>
<span class="lineNum">    2069 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2070 </span>            :             case 'b':
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :                 c = '\b';</span>
<span class="lineNum">    2072 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2073 </span>            :             case 'f':
<span class="lineNum">    2074 </span><span class="lineNoCov">          0 :                 c = '\f';</span>
<span class="lineNum">    2075 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2076 </span>            :             case 'n':
<span class="lineNum">    2077 </span><span class="lineCov">        410 :                 c = '\n';</span>
<span class="lineNum">    2078 </span><span class="lineCov">        410 :                 break;</span>
<span class="lineNum">    2079 </span>            :             case 'r':
<span class="lineNum">    2080 </span><span class="lineNoCov">          0 :                 c = '\r';</span>
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2082 </span>            :             case 't':
<span class="lineNum">    2083 </span><span class="lineCov">        505 :                 c = '\t';</span>
<span class="lineNum">    2084 </span><span class="lineCov">        505 :                 break;</span>
<span class="lineNum">    2085 </span>            :             case 'v':
<span class="lineNum">    2086 </span><span class="lineNoCov">          0 :                 c = '\v';</span>
<span class="lineNum">    2087 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2088 </span>            :             case 'e':
<span class="lineNum">    2089 </span><span class="lineNoCov">          0 :                 if (!gnu_ext)</span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 :                     goto invalid_escape;</span>
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :                 c = 27;</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2093 </span>            :             case '\'':
<span class="lineNum">    2094 </span>            :             case '\&quot;':
<span class="lineNum">    2095 </span>            :             case '\\': 
<span class="lineNum">    2096 </span>            :             case '?':
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2098 </span>            :             default:
<span class="lineNum">    2099 </span>            :             invalid_escape:
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :                 if (c &gt;= '!' &amp;&amp; c &lt;= '~')</span>
<span class="lineNum">    2101 </span><span class="lineNoCov">          0 :                     tcc_warning(&quot;unknown escape sequence: \'\\%c\'&quot;, c);</span>
<span class="lineNum">    2102 </span>            :                 else
<span class="lineNum">    2103 </span><span class="lineNoCov">          0 :                     tcc_warning(&quot;unknown escape sequence: \'\\x%x\'&quot;, c);</span>
<span class="lineNum">    2104 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    2105 </span>            :             }
<span class="lineNum">    2106 </span><span class="lineCov">      49302 :         } else if (is_long &amp;&amp; c &gt;= 0x80) {</span>
<span class="lineNum">    2107 </span>            :             /* assume we are processing UTF-8 sequence */
<span class="lineNum">    2108 </span>            :             /* reference: The Unicode Standard, Version 10.0, ch3.9 */
<span class="lineNum">    2109 </span>            : 
<span class="lineNum">    2110 </span>            :             int cont; /* count of continuation bytes */
<span class="lineNum">    2111 </span>            :             int skip; /* how many bytes should skip when error occurred */
<span class="lineNum">    2112 </span>            :             int i;
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span>            :             /* decode leading byte */
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :             if (c &lt; 0xC2) {</span>
<span class="lineNum">    2116 </span><span class="lineNoCov">          0 :                     skip = 1; goto invalid_utf8_sequence;</span>
<span class="lineNum">    2117 </span><span class="lineNoCov">          0 :             } else if (c &lt;= 0xDF) {</span>
<span class="lineNum">    2118 </span><span class="lineNoCov">          0 :                     cont = 1; n = c &amp; 0x1f;</span>
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :             } else if (c &lt;= 0xEF) {</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :                     cont = 2; n = c &amp; 0xf;</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :             } else if (c &lt;= 0xF4) {</span>
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :                     cont = 3; n = c &amp; 0x7;</span>
<span class="lineNum">    2123 </span>            :             } else {
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :                     skip = 1; goto invalid_utf8_sequence;</span>
<span class="lineNum">    2125 </span>            :             }
<span class="lineNum">    2126 </span>            : 
<span class="lineNum">    2127 </span>            :             /* decode continuation bytes */
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :             for (i = 1; i &lt;= cont; i++) {</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :                 int l = 0x80, h = 0xBF;</span>
<span class="lineNum">    2130 </span>            : 
<span class="lineNum">    2131 </span>            :                 /* adjust limit for second byte */
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :                 if (i == 1) {</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :                     switch (c) {</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :                     case 0xE0: l = 0xA0; break;</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :                     case 0xED: h = 0x9F; break;</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :                     case 0xF0: l = 0x90; break;</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :                     case 0xF4: h = 0x8F; break;</span>
<span class="lineNum">    2138 </span>            :                     }
<span class="lineNum">    2139 </span>            :                 }
<span class="lineNum">    2140 </span>            : 
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 :                 if (p[i] &lt; l || p[i] &gt; h) {</span>
<span class="lineNum">    2142 </span><span class="lineNoCov">          0 :                     skip = i; goto invalid_utf8_sequence;</span>
<span class="lineNum">    2143 </span>            :                 }
<span class="lineNum">    2144 </span>            : 
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :                 n = (n &lt;&lt; 6) | (p[i] &amp; 0x3f);</span>
<span class="lineNum">    2146 </span>            :             }
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span>            :             /* advance pointer */
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :             p += 1 + cont;</span>
<span class="lineNum">    2150 </span><span class="lineNoCov">          0 :             c = n;</span>
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :             goto add_char_nonext;</span>
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :             /* error handling */
<span class="lineNum">    2154 </span>            :         invalid_utf8_sequence:
<span class="lineNum">    2155 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;ill-formed UTF-8 subsequence starting with: \'\\x%x\'&quot;, c);</span>
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :             c = 0xFFFD;</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :             p += skip;</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :             goto add_char_nonext;</span>
<span class="lineNum">    2159 </span>            : 
<span class="lineNum">    2160 </span>            :         }
<span class="lineNum">    2161 </span><span class="lineCov">      50217 :         p++;</span>
<span class="lineNum">    2162 </span>            :     add_char_nonext:
<span class="lineNum">    2163 </span><span class="lineCov">      50229 :         if (!is_long)</span>
<span class="lineNum">    2164 </span><span class="lineCov">      50229 :             cstr_ccat(outstr, c);</span>
<span class="lineNum">    2165 </span>            :         else {
<span class="lineNum">    2166 </span>            : #ifdef TCC_TARGET_PE
<span class="lineNum">    2167 </span>            :             /* store as UTF-16 */
<span class="lineNum">    2168 </span>            :             if (c &lt; 0x10000) {
<span class="lineNum">    2169 </span>            :                 cstr_wccat(outstr, c);
<span class="lineNum">    2170 </span>            :             } else {
<span class="lineNum">    2171 </span>            :                 c -= 0x10000;
<span class="lineNum">    2172 </span>            :                 cstr_wccat(outstr, (c &gt;&gt; 10) + 0xD800);
<span class="lineNum">    2173 </span>            :                 cstr_wccat(outstr, (c &amp; 0x3FF) + 0xDC00);
<span class="lineNum">    2174 </span>            :             }
<span class="lineNum">    2175 </span>            : #else
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 :             cstr_wccat(outstr, c);</span>
<span class="lineNum">    2177 </span>            : #endif
<span class="lineNum">    2178 </span>            :         }
<span class="lineNum">    2179 </span><span class="lineCov">      50229 :     }</span>
<span class="lineNum">    2180 </span>            :     /* add a trailing '\0' */
<span class="lineNum">    2181 </span><span class="lineCov">       3327 :     if (!is_long)</span>
<span class="lineNum">    2182 </span><span class="lineCov">       3327 :         cstr_ccat(outstr, '\0');</span>
<span class="lineNum">    2183 </span>            :     else
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :         cstr_wccat(outstr, '\0');</span>
<a name="2185"><span class="lineNum">    2185 </span><span class="lineCov">       3327 : }</span></a>
<span class="lineNum">    2186 </span>            : 
<span class="lineNum">    2187 </span><span class="lineCov">       3327 : static void parse_string(const char *s, int len)</span>
<span class="lineNum">    2188 </span>            : {
<span class="lineNum">    2189 </span><span class="lineCov">       3327 :     uint8_t buf[1000], *p = buf;</span>
<span class="lineNum">    2190 </span>            :     int is_long, sep;
<span class="lineNum">    2191 </span>            : 
<span class="lineNum">    2192 </span><span class="lineCov">       3327 :     if ((is_long = *s == 'L'))</span>
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :         ++s, --len;</span>
<span class="lineNum">    2194 </span><span class="lineCov">       3327 :     sep = *s++;</span>
<span class="lineNum">    2195 </span><span class="lineCov">       3327 :     len -= 2;</span>
<span class="lineNum">    2196 </span><span class="lineCov">       3327 :     if (len &gt;= sizeof buf)</span>
<span class="lineNum">    2197 </span><span class="lineNoCov">          0 :         p = tcc_malloc(len + 1);</span>
<span class="lineNum">    2198 </span><span class="lineCov">       3327 :     memcpy(p, s, len);</span>
<span class="lineNum">    2199 </span><span class="lineCov">       3327 :     p[len] = 0;</span>
<span class="lineNum">    2200 </span>            : 
<span class="lineNum">    2201 </span><span class="lineCov">       3327 :     cstr_reset(&amp;tokcstr);</span>
<span class="lineNum">    2202 </span><span class="lineCov">       3327 :     parse_escape_string(&amp;tokcstr, p, is_long);</span>
<span class="lineNum">    2203 </span><span class="lineCov">       3327 :     if (p != buf)</span>
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :         tcc_free(p);</span>
<span class="lineNum">    2205 </span>            : 
<span class="lineNum">    2206 </span><span class="lineCov">       3327 :     if (sep == '\'') {</span>
<span class="lineNum">    2207 </span>            :         int char_size, i, n, c;
<span class="lineNum">    2208 </span>            :         /* XXX: make it portable */
<span class="lineNum">    2209 </span><span class="lineCov">        115 :         if (!is_long)</span>
<span class="lineNum">    2210 </span><span class="lineCov">        115 :             tok = TOK_CCHAR, char_size = 1;</span>
<span class="lineNum">    2211 </span>            :         else
<span class="lineNum">    2212 </span><span class="lineNoCov">          0 :             tok = TOK_LCHAR, char_size = sizeof(nwchar_t);</span>
<span class="lineNum">    2213 </span><span class="lineCov">        115 :         n = tokcstr.size / char_size - 1;</span>
<span class="lineNum">    2214 </span><span class="lineCov">        115 :         if (n &lt; 1)</span>
<span class="lineNum">    2215 </span><span class="lineNoCov">          0 :             tcc_error(&quot;empty character constant&quot;);</span>
<span class="lineNum">    2216 </span><span class="lineCov">        115 :         if (n &gt; 1)</span>
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;multi-character character constant&quot;);</span>
<span class="lineNum">    2218 </span><span class="lineCov">        230 :         for (c = i = 0; i &lt; n; ++i) {</span>
<span class="lineNum">    2219 </span><span class="lineCov">        115 :             if (is_long)</span>
<span class="lineNum">    2220 </span><span class="lineNoCov">          0 :                 c = ((nwchar_t *)tokcstr.data)[i];</span>
<span class="lineNum">    2221 </span>            :             else
<span class="lineNum">    2222 </span><span class="lineCov">        115 :                 c = (c &lt;&lt; 8) | ((char *)tokcstr.data)[i];</span>
<span class="lineNum">    2223 </span>            :         }
<span class="lineNum">    2224 </span><span class="lineCov">        115 :         tokc.i = c;</span>
<span class="lineNum">    2225 </span>            :     } else {
<span class="lineNum">    2226 </span><span class="lineCov">       3212 :         tokc.str.size = tokcstr.size;</span>
<span class="lineNum">    2227 </span><span class="lineCov">       3212 :         tokc.str.data = tokcstr.data;</span>
<span class="lineNum">    2228 </span><span class="lineCov">       3212 :         if (!is_long)</span>
<span class="lineNum">    2229 </span><span class="lineCov">       3212 :             tok = TOK_STR;</span>
<span class="lineNum">    2230 </span>            :         else
<span class="lineNum">    2231 </span><span class="lineNoCov">          0 :             tok = TOK_LSTR;</span>
<span class="lineNum">    2232 </span>            :     }
<span class="lineNum">    2233 </span><span class="lineCov">       3327 : }</span>
<span class="lineNum">    2234 </span>            : 
<span class="lineNum">    2235 </span>            : /* we use 64 bit numbers */
<span class="lineNum">    2236 </span>            : #define BN_SIZE 2
<a name="2237"><span class="lineNum">    2237 </span>            : </a>
<span class="lineNum">    2238 </span>            : /* bn = (bn &lt;&lt; shift) | or_val */
<span class="lineNum">    2239 </span><span class="lineNoCov">          0 : static void bn_lshift(unsigned int *bn, int shift, int or_val)</span>
<span class="lineNum">    2240 </span>            : {
<span class="lineNum">    2241 </span>            :     int i;
<span class="lineNum">    2242 </span>            :     unsigned int v;
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;BN_SIZE;i++) {</span>
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :         v = bn[i];</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :         bn[i] = (v &lt;&lt; shift) | or_val;</span>
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :         or_val = v &gt;&gt; (32 - shift);</span>
<span class="lineNum">    2247 </span>            :     }
<a name="2248"><span class="lineNum">    2248 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2249 </span>            : 
<span class="lineNum">    2250 </span><span class="lineNoCov">          0 : static void bn_zero(unsigned int *bn)</span>
<span class="lineNum">    2251 </span>            : {
<span class="lineNum">    2252 </span>            :     int i;
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;BN_SIZE;i++) {</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 :         bn[i] = 0;</span>
<span class="lineNum">    2255 </span>            :     }
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2257 </span>            : 
<a name="2258"><span class="lineNum">    2258 </span>            : /* parse number in null terminated string 'p' and return it in the</a>
<span class="lineNum">    2259 </span>            :    current token */
<span class="lineNum">    2260 </span><span class="lineCov">      31300 : static void parse_number(const char *p)</span>
<span class="lineNum">    2261 </span>            : {
<span class="lineNum">    2262 </span>            :     int b, t, shift, frac_bits, s, exp_val, ch;
<span class="lineNum">    2263 </span>            :     char *q;
<span class="lineNum">    2264 </span>            :     unsigned int bn[BN_SIZE];
<span class="lineNum">    2265 </span>            :     double d;
<span class="lineNum">    2266 </span>            : 
<span class="lineNum">    2267 </span>            :     /* number */
<span class="lineNum">    2268 </span><span class="lineCov">      31300 :     q = token_buf;</span>
<span class="lineNum">    2269 </span><span class="lineCov">      31300 :     ch = *p++;</span>
<span class="lineNum">    2270 </span><span class="lineCov">      31300 :     t = ch;</span>
<span class="lineNum">    2271 </span><span class="lineCov">      31300 :     ch = *p++;</span>
<span class="lineNum">    2272 </span><span class="lineCov">      31300 :     *q++ = t;</span>
<span class="lineNum">    2273 </span><span class="lineCov">      31300 :     b = 10;</span>
<span class="lineNum">    2274 </span><span class="lineCov">      31300 :     if (t == '.') {</span>
<span class="lineNum">    2275 </span><span class="lineCov">          1 :         goto float_frac_parse;</span>
<span class="lineNum">    2276 </span><span class="lineCov">      31299 :     } else if (t == '0') {</span>
<span class="lineNum">    2277 </span><span class="lineCov">      13931 :         if (ch == 'x' || ch == 'X') {</span>
<span class="lineNum">    2278 </span><span class="lineCov">        887 :             q--;</span>
<span class="lineNum">    2279 </span><span class="lineCov">        887 :             ch = *p++;</span>
<span class="lineNum">    2280 </span><span class="lineCov">        887 :             b = 16;</span>
<span class="lineNum">    2281 </span><span class="lineCov">      13044 :         } else if (tcc_ext &amp;&amp; (ch == 'b' || ch == 'B')) {</span>
<span class="lineNum">    2282 </span><span class="lineNoCov">          0 :             q--;</span>
<span class="lineNum">    2283 </span><span class="lineNoCov">          0 :             ch = *p++;</span>
<span class="lineNum">    2284 </span><span class="lineNoCov">          0 :             b = 2;</span>
<span class="lineNum">    2285 </span>            :         }
<span class="lineNum">    2286 </span>            :     }
<span class="lineNum">    2287 </span>            :     /* parse all digits. cannot check octal numbers at this stage
<span class="lineNum">    2288 </span>            :        because of floating point constants */
<span class="lineNum">    2289 </span>            :     while (1) {
<span class="lineNum">    2290 </span><span class="lineCov">      85046 :         if (ch &gt;= 'a' &amp;&amp; ch &lt;= 'f')</span>
<span class="lineNum">    2291 </span><span class="lineCov">        404 :             t = ch - 'a' + 10;</span>
<span class="lineNum">    2292 </span><span class="lineCov">      84642 :         else if (ch &gt;= 'A' &amp;&amp; ch &lt;= 'F')</span>
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :             t = ch - 'A' + 10;</span>
<span class="lineNum">    2294 </span><span class="lineCov">      84642 :         else if (isnum(ch))</span>
<span class="lineNum">    2295 </span><span class="lineCov">      53343 :             t = ch - '0';</span>
<span class="lineNum">    2296 </span>            :         else
<span class="lineNum">    2297 </span><span class="lineCov">      31299 :             break;</span>
<span class="lineNum">    2298 </span><span class="lineCov">      53747 :         if (t &gt;= b)</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2300 </span><span class="lineCov">      53747 :         if (q &gt;= token_buf + STRING_MAX_SIZE) {</span>
<span class="lineNum">    2301 </span>            :         num_too_long:
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :             tcc_error(&quot;number too long&quot;);</span>
<span class="lineNum">    2303 </span>            :         }
<span class="lineNum">    2304 </span><span class="lineCov">      53747 :         *q++ = ch;</span>
<span class="lineNum">    2305 </span><span class="lineCov">      53747 :         ch = *p++;</span>
<span class="lineNum">    2306 </span><span class="lineCov">      53747 :     }</span>
<span class="lineNum">    2307 </span><span class="lineCov">      31299 :     if (ch == '.' ||</span>
<span class="lineNum">    2308 </span><span class="lineCov">      31293 :         ((ch == 'e' || ch == 'E') &amp;&amp; b == 10) ||</span>
<span class="lineNum">    2309 </span><span class="lineCov">      31293 :         ((ch == 'p' || ch == 'P') &amp;&amp; (b == 16 || b == 2))) {</span>
<span class="lineNum">    2310 </span><span class="lineCov">         13 :         if (b != 10) {</span>
<span class="lineNum">    2311 </span>            :             /* NOTE: strtox should support that for hexa numbers, but
<span class="lineNum">    2312 </span>            :                non ISOC99 libcs do not support it, so we prefer to do
<span class="lineNum">    2313 </span>            :                it by hand */
<span class="lineNum">    2314 </span>            :             /* hexadecimal or binary floats */
<span class="lineNum">    2315 </span>            :             /* XXX: handle overflows */
<span class="lineNum">    2316 </span><span class="lineNoCov">          0 :             *q = '\0';</span>
<span class="lineNum">    2317 </span><span class="lineNoCov">          0 :             if (b == 16)</span>
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :                 shift = 4;</span>
<span class="lineNum">    2319 </span>            :             else 
<span class="lineNum">    2320 </span><span class="lineNoCov">          0 :                 shift = 1;</span>
<span class="lineNum">    2321 </span><span class="lineNoCov">          0 :             bn_zero(bn);</span>
<span class="lineNum">    2322 </span><span class="lineNoCov">          0 :             q = token_buf;</span>
<span class="lineNum">    2323 </span>            :             while (1) {
<span class="lineNum">    2324 </span><span class="lineNoCov">          0 :                 t = *q++;</span>
<span class="lineNum">    2325 </span><span class="lineNoCov">          0 :                 if (t == '\0') {</span>
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :                 } else if (t &gt;= 'a') {</span>
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :                     t = t - 'a' + 10;</span>
<span class="lineNum">    2329 </span><span class="lineNoCov">          0 :                 } else if (t &gt;= 'A') {</span>
<span class="lineNum">    2330 </span><span class="lineNoCov">          0 :                     t = t - 'A' + 10;</span>
<span class="lineNum">    2331 </span>            :                 } else {
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :                     t = t - '0';</span>
<span class="lineNum">    2333 </span>            :                 }
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :                 bn_lshift(bn, shift, t);</span>
<span class="lineNum">    2335 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :             frac_bits = 0;</span>
<span class="lineNum">    2337 </span><span class="lineNoCov">          0 :             if (ch == '.') {</span>
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2339 </span>            :                 while (1) {
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :                     t = ch;</span>
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :                     if (t &gt;= 'a' &amp;&amp; t &lt;= 'f') {</span>
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :                         t = t - 'a' + 10;</span>
<span class="lineNum">    2343 </span><span class="lineNoCov">          0 :                     } else if (t &gt;= 'A' &amp;&amp; t &lt;= 'F') {</span>
<span class="lineNum">    2344 </span><span class="lineNoCov">          0 :                         t = t - 'A' + 10;</span>
<span class="lineNum">    2345 </span><span class="lineNoCov">          0 :                     } else if (t &gt;= '0' &amp;&amp; t &lt;= '9') {</span>
<span class="lineNum">    2346 </span><span class="lineNoCov">          0 :                         t = t - '0';</span>
<span class="lineNum">    2347 </span>            :                     } else {
<span class="lineNum">    2348 </span>            :                         break;
<span class="lineNum">    2349 </span>            :                     }
<span class="lineNum">    2350 </span><span class="lineNoCov">          0 :                     if (t &gt;= b)</span>
<span class="lineNum">    2351 </span><span class="lineNoCov">          0 :                         tcc_error(&quot;invalid digit&quot;);</span>
<span class="lineNum">    2352 </span><span class="lineNoCov">          0 :                     bn_lshift(bn, shift, t);</span>
<span class="lineNum">    2353 </span><span class="lineNoCov">          0 :                     frac_bits += shift;</span>
<span class="lineNum">    2354 </span><span class="lineNoCov">          0 :                     ch = *p++;</span>
<span class="lineNum">    2355 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    2356 </span>            :             }
<span class="lineNum">    2357 </span><span class="lineNoCov">          0 :             if (ch != 'p' &amp;&amp; ch != 'P')</span>
<span class="lineNum">    2358 </span><span class="lineNoCov">          0 :                 expect(&quot;exponent&quot;);</span>
<span class="lineNum">    2359 </span><span class="lineNoCov">          0 :             ch = *p++;</span>
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :             s = 1;</span>
<span class="lineNum">    2361 </span><span class="lineNoCov">          0 :             exp_val = 0;</span>
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :             if (ch == '+') {</span>
<span class="lineNum">    2363 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2364 </span><span class="lineNoCov">          0 :             } else if (ch == '-') {</span>
<span class="lineNum">    2365 </span><span class="lineNoCov">          0 :                 s = -1;</span>
<span class="lineNum">    2366 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2367 </span>            :             }
<span class="lineNum">    2368 </span><span class="lineNoCov">          0 :             if (ch &lt; '0' || ch &gt; '9')</span>
<span class="lineNum">    2369 </span><span class="lineNoCov">          0 :                 expect(&quot;exponent digits&quot;);</span>
<span class="lineNum">    2370 </span><span class="lineNoCov">          0 :             while (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :                 exp_val = exp_val * 10 + ch - '0';</span>
<span class="lineNum">    2372 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2373 </span>            :             }
<span class="lineNum">    2374 </span><span class="lineNoCov">          0 :             exp_val = exp_val * s;</span>
<span class="lineNum">    2375 </span>            :             
<span class="lineNum">    2376 </span>            :             /* now we can generate the number */
<span class="lineNum">    2377 </span>            :             /* XXX: should patch directly float number */
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :             d = (double)bn[1] * 4294967296.0 + (double)bn[0];</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :             d = ldexp(d, exp_val - frac_bits);</span>
<span class="lineNum">    2380 </span><span class="lineNoCov">          0 :             t = toup(ch);</span>
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 :             if (t == 'F') {</span>
<span class="lineNum">    2382 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2383 </span><span class="lineNoCov">          0 :                 tok = TOK_CFLOAT;</span>
<span class="lineNum">    2384 </span>            :                 /* float : should handle overflow */
<span class="lineNum">    2385 </span><span class="lineNoCov">          0 :                 tokc.f = (float)d;</span>
<span class="lineNum">    2386 </span><span class="lineNoCov">          0 :             } else if (t == 'L') {</span>
<span class="lineNum">    2387 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2388 </span>            : #ifdef TCC_TARGET_PE
<span class="lineNum">    2389 </span>            :                 tok = TOK_CDOUBLE;
<span class="lineNum">    2390 </span>            :                 tokc.d = d;
<span class="lineNum">    2391 </span>            : #else
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :                 tok = TOK_CLDOUBLE;</span>
<span class="lineNum">    2393 </span>            :                 /* XXX: not large enough */
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :                 tokc.ld = (long double)d;</span>
<span class="lineNum">    2395 </span>            : #endif
<span class="lineNum">    2396 </span>            :             } else {
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :                 tok = TOK_CDOUBLE;</span>
<span class="lineNum">    2398 </span><span class="lineNoCov">          0 :                 tokc.d = d;</span>
<span class="lineNum">    2399 </span>            :             }
<span class="lineNum">    2400 </span>            :         } else {
<span class="lineNum">    2401 </span>            :             /* decimal floats */
<span class="lineNum">    2402 </span><span class="lineCov">          6 :             if (ch == '.') {</span>
<span class="lineNum">    2403 </span><span class="lineCov">          6 :                 if (q &gt;= token_buf + STRING_MAX_SIZE)</span>
<span class="lineNum">    2404 </span><span class="lineNoCov">          0 :                     goto num_too_long;</span>
<span class="lineNum">    2405 </span><span class="lineCov">          6 :                 *q++ = ch;</span>
<span class="lineNum">    2406 </span><span class="lineCov">          6 :                 ch = *p++;</span>
<span class="lineNum">    2407 </span>            :             float_frac_parse:
<span class="lineNum">    2408 </span><span class="lineCov">         24 :                 while (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {</span>
<span class="lineNum">    2409 </span><span class="lineCov">         10 :                     if (q &gt;= token_buf + STRING_MAX_SIZE)</span>
<span class="lineNum">    2410 </span><span class="lineNoCov">          0 :                         goto num_too_long;</span>
<span class="lineNum">    2411 </span><span class="lineCov">         10 :                     *q++ = ch;</span>
<span class="lineNum">    2412 </span><span class="lineCov">         10 :                     ch = *p++;</span>
<span class="lineNum">    2413 </span>            :                 }
<span class="lineNum">    2414 </span>            :             }
<span class="lineNum">    2415 </span><span class="lineCov">          7 :             if (ch == 'e' || ch == 'E') {</span>
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :                 if (q &gt;= token_buf + STRING_MAX_SIZE)</span>
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 :                     goto num_too_long;</span>
<span class="lineNum">    2418 </span><span class="lineNoCov">          0 :                 *q++ = ch;</span>
<span class="lineNum">    2419 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :                 if (ch == '-' || ch == '+') {</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :                     if (q &gt;= token_buf + STRING_MAX_SIZE)</span>
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :                         goto num_too_long;</span>
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :                     *q++ = ch;</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :                     ch = *p++;</span>
<span class="lineNum">    2425 </span>            :                 }
<span class="lineNum">    2426 </span><span class="lineNoCov">          0 :                 if (ch &lt; '0' || ch &gt; '9')</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :                     expect(&quot;exponent digits&quot;);</span>
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :                 while (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {</span>
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :                     if (q &gt;= token_buf + STRING_MAX_SIZE)</span>
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :                         goto num_too_long;</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :                     *q++ = ch;</span>
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :                     ch = *p++;</span>
<span class="lineNum">    2433 </span>            :                 }
<span class="lineNum">    2434 </span>            :             }
<span class="lineNum">    2435 </span><span class="lineCov">          7 :             *q = '\0';</span>
<span class="lineNum">    2436 </span><span class="lineCov">          7 :             t = toup(ch);</span>
<span class="lineNum">    2437 </span><span class="lineCov">          7 :             errno = 0;</span>
<span class="lineNum">    2438 </span><span class="lineCov">          7 :             if (t == 'F') {</span>
<span class="lineNum">    2439 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2440 </span><span class="lineNoCov">          0 :                 tok = TOK_CFLOAT;</span>
<span class="lineNum">    2441 </span><span class="lineNoCov">          0 :                 tokc.f = strtof(token_buf, NULL);</span>
<span class="lineNum">    2442 </span><span class="lineCov">          7 :             } else if (t == 'L') {</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :                 ch = *p++;</span>
<span class="lineNum">    2444 </span>            : #ifdef TCC_TARGET_PE
<span class="lineNum">    2445 </span>            :                 tok = TOK_CDOUBLE;
<span class="lineNum">    2446 </span>            :                 tokc.d = strtod(token_buf, NULL);
<span class="lineNum">    2447 </span>            : #else
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :                 tok = TOK_CLDOUBLE;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :                 tokc.ld = strtold(token_buf, NULL);</span>
<span class="lineNum">    2450 </span>            : #endif
<span class="lineNum">    2451 </span>            :             } else {
<span class="lineNum">    2452 </span><span class="lineCov">          7 :                 tok = TOK_CDOUBLE;</span>
<span class="lineNum">    2453 </span><span class="lineCov">          7 :                 tokc.d = strtod(token_buf, NULL);</span>
<span class="lineNum">    2454 </span>            :             }
<span class="lineNum">    2455 </span>            :         }
<span class="lineNum">    2456 </span>            :     } else {
<span class="lineNum">    2457 </span>            :         unsigned long long n, n1;
<span class="lineNum">    2458 </span><span class="lineCov">      31293 :         int lcount, ucount, ov = 0;</span>
<span class="lineNum">    2459 </span>            :         const char *p1;
<span class="lineNum">    2460 </span>            : 
<span class="lineNum">    2461 </span>            :         /* integer number */
<span class="lineNum">    2462 </span><span class="lineCov">      31293 :         *q = '\0';</span>
<span class="lineNum">    2463 </span><span class="lineCov">      31293 :         q = token_buf;</span>
<span class="lineNum">    2464 </span><span class="lineCov">      31293 :         if (b == 10 &amp;&amp; *q == '0') {</span>
<span class="lineNum">    2465 </span><span class="lineCov">      13041 :             b = 8;</span>
<span class="lineNum">    2466 </span><span class="lineCov">      13041 :             q++;</span>
<span class="lineNum">    2467 </span>            :         }
<span class="lineNum">    2468 </span><span class="lineCov">      31293 :         n = 0;</span>
<span class="lineNum">    2469 </span>            :         while(1) {
<span class="lineNum">    2470 </span><span class="lineCov">     102405 :             t = *q++;</span>
<span class="lineNum">    2471 </span>            :             /* no need for checks except for base 10 / 8 errors */
<span class="lineNum">    2472 </span><span class="lineCov">     102405 :             if (t == '\0')</span>
<span class="lineNum">    2473 </span><span class="lineCov">      31293 :                 break;</span>
<span class="lineNum">    2474 </span><span class="lineCov">      71112 :             else if (t &gt;= 'a')</span>
<span class="lineNum">    2475 </span><span class="lineCov">        404 :                 t = t - 'a' + 10;</span>
<span class="lineNum">    2476 </span><span class="lineCov">      70708 :             else if (t &gt;= 'A')</span>
<span class="lineNum">    2477 </span><span class="lineNoCov">          0 :                 t = t - 'A' + 10;</span>
<span class="lineNum">    2478 </span>            :             else
<span class="lineNum">    2479 </span><span class="lineCov">      70708 :                 t = t - '0';</span>
<span class="lineNum">    2480 </span><span class="lineCov">      71112 :             if (t &gt;= b)</span>
<span class="lineNum">    2481 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;invalid digit&quot;);</span>
<span class="lineNum">    2482 </span><span class="lineCov">      71112 :             n1 = n;</span>
<span class="lineNum">    2483 </span><span class="lineCov">      71112 :             n = n * b + t;</span>
<span class="lineNum">    2484 </span>            :             /* detect overflow */
<span class="lineNum">    2485 </span><span class="lineCov">      71112 :             if (n1 &gt;= 0x1000000000000000ULL &amp;&amp; n / b != n1)</span>
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :                 ov = 1;</span>
<span class="lineNum">    2487 </span><span class="lineCov">      71112 :         }</span>
<span class="lineNum">    2488 </span>            : 
<span class="lineNum">    2489 </span>            :         /* Determine the characteristics (unsigned and/or 64bit) the type of
<span class="lineNum">    2490 </span>            :            the constant must have according to the constant suffix(es) */
<span class="lineNum">    2491 </span><span class="lineCov">      31293 :         lcount = ucount = 0;</span>
<span class="lineNum">    2492 </span><span class="lineCov">      31293 :         p1 = p;</span>
<span class="lineNum">    2493 </span>            :         for(;;) {
<span class="lineNum">    2494 </span><span class="lineCov">      39555 :             t = toup(ch);</span>
<span class="lineNum">    2495 </span><span class="lineCov">      39555 :             if (t == 'L') {</span>
<span class="lineNum">    2496 </span><span class="lineCov">       8158 :                 if (lcount &gt;= 2)</span>
<span class="lineNum">    2497 </span><span class="lineNoCov">          0 :                     tcc_error(&quot;three 'l's in integer constant&quot;);</span>
<span class="lineNum">    2498 </span><span class="lineCov">       8158 :                 if (lcount &amp;&amp; *(p - 1) != ch)</span>
<span class="lineNum">    2499 </span><span class="lineNoCov">          0 :                     tcc_error(&quot;incorrect integer suffix: %s&quot;, p1);</span>
<span class="lineNum">    2500 </span><span class="lineCov">       8158 :                 lcount++;</span>
<span class="lineNum">    2501 </span><span class="lineCov">       8158 :                 ch = *p++;</span>
<span class="lineNum">    2502 </span><span class="lineCov">      31397 :             } else if (t == 'U') {</span>
<span class="lineNum">    2503 </span><span class="lineCov">        104 :                 if (ucount &gt;= 1)</span>
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :                     tcc_error(&quot;two 'u's in integer constant&quot;);</span>
<span class="lineNum">    2505 </span><span class="lineCov">        104 :                 ucount++;</span>
<span class="lineNum">    2506 </span><span class="lineCov">        104 :                 ch = *p++;</span>
<span class="lineNum">    2507 </span>            :             } else {
<span class="lineNum">    2508 </span><span class="lineCov">      31293 :                 break;</span>
<span class="lineNum">    2509 </span>            :             }
<span class="lineNum">    2510 </span><span class="lineCov">       8262 :         }</span>
<span class="lineNum">    2511 </span>            : 
<span class="lineNum">    2512 </span>            :         /* Determine if it needs 64 bits and/or unsigned in order to fit */
<span class="lineNum">    2513 </span><span class="lineCov">      31293 :         if (ucount == 0 &amp;&amp; b == 10) {</span>
<span class="lineNum">    2514 </span><span class="lineCov">      17365 :             if (lcount &lt;= (LONG_SIZE == 4)) {</span>
<span class="lineNum">    2515 </span><span class="lineCov">       9415 :                 if (n &gt;= 0x80000000U)</span>
<span class="lineNum">    2516 </span><span class="lineNoCov">          0 :                     lcount = (LONG_SIZE == 4) + 1;</span>
<span class="lineNum">    2517 </span>            :             }
<span class="lineNum">    2518 </span><span class="lineCov">      34730 :             if (n &gt;= 0x8000000000000000ULL)</span>
<span class="lineNum">    2519 </span><span class="lineNoCov">          0 :                 ov = 1, ucount = 1;</span>
<span class="lineNum">    2520 </span>            :         } else {
<span class="lineNum">    2521 </span><span class="lineCov">      13928 :             if (lcount &lt;= (LONG_SIZE == 4)) {</span>
<span class="lineNum">    2522 </span><span class="lineCov">      13824 :                 if (n &gt;= 0x100000000ULL)</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :                     lcount = (LONG_SIZE == 4) + 1;</span>
<span class="lineNum">    2524 </span><span class="lineCov">      13824 :                 else if (n &gt;= 0x80000000U)</span>
<span class="lineNum">    2525 </span><span class="lineCov">         13 :                     ucount = 1;</span>
<span class="lineNum">    2526 </span>            :             }
<span class="lineNum">    2527 </span><span class="lineCov">      13928 :             if (n &gt;= 0x8000000000000000ULL)</span>
<span class="lineNum">    2528 </span><span class="lineCov">         13 :                 ucount = 1;</span>
<span class="lineNum">    2529 </span>            :         }
<span class="lineNum">    2530 </span>            : 
<span class="lineNum">    2531 </span><span class="lineCov">      31293 :         if (ov)</span>
<span class="lineNum">    2532 </span><span class="lineNoCov">          0 :             tcc_warning(&quot;integer constant overflow&quot;);</span>
<span class="lineNum">    2533 </span>            : 
<span class="lineNum">    2534 </span><span class="lineCov">      31293 :         tok = TOK_CINT;</span>
<span class="lineNum">    2535 </span><span class="lineCov">      31293 :         if (lcount) {</span>
<span class="lineNum">    2536 </span><span class="lineCov">       8054 :             tok = TOK_CLONG;</span>
<span class="lineNum">    2537 </span><span class="lineCov">       8054 :             if (lcount == 2)</span>
<span class="lineNum">    2538 </span><span class="lineCov">        104 :                 tok = TOK_CLLONG;</span>
<span class="lineNum">    2539 </span>            :         }
<span class="lineNum">    2540 </span><span class="lineCov">      31293 :         if (ucount)</span>
<span class="lineNum">    2541 </span><span class="lineCov">        117 :             ++tok; /* TOK_CU... */</span>
<span class="lineNum">    2542 </span><span class="lineCov">      31293 :         tokc.i = n;</span>
<span class="lineNum">    2543 </span>            :     }
<span class="lineNum">    2544 </span><span class="lineCov">      31300 :     if (ch)</span>
<span class="lineNum">    2545 </span><span class="lineNoCov">          0 :         tcc_error(&quot;invalid number\n&quot;);</span>
<span class="lineNum">    2546 </span><span class="lineCov">      31300 : }</span>
<span class="lineNum">    2547 </span>            : 
<span class="lineNum">    2548 </span>            : 
<span class="lineNum">    2549 </span>            : #define PARSE2(c1, tok1, c2, tok2)              \
<span class="lineNum">    2550 </span>            :     case c1:                                    \
<span class="lineNum">    2551 </span>            :         PEEKC(c, p);                            \
<span class="lineNum">    2552 </span>            :         if (c == c2) {                          \
<span class="lineNum">    2553 </span>            :             p++;                                \
<span class="lineNum">    2554 </span>            :             tok = tok2;                         \
<span class="lineNum">    2555 </span>            :         } else {                                \
<span class="lineNum">    2556 </span>            :             tok = tok1;                         \
<span class="lineNum">    2557 </span>            :         }                                       \
<span class="lineNum">    2558 </span>            :         break;
<a name="2559"><span class="lineNum">    2559 </span>            : </a>
<span class="lineNum">    2560 </span>            : /* return next token without macro substitution */
<span class="lineNum">    2561 </span><span class="lineCov">    2874575 : static inline void next_nomacro1(void)</span>
<span class="lineNum">    2562 </span>            : {
<span class="lineNum">    2563 </span>            :     int t, c, is_long, len;
<span class="lineNum">    2564 </span>            :     TokenSym *ts;
<span class="lineNum">    2565 </span>            :     uint8_t *p, *p1;
<span class="lineNum">    2566 </span>            :     unsigned int h;
<span class="lineNum">    2567 </span>            : 
<span class="lineNum">    2568 </span><span class="lineCov">    2874575 :     p = file-&gt;buf_ptr;</span>
<span class="lineNum">    2569 </span>            :  redo_no_start:
<span class="lineNum">    2570 </span><span class="lineCov">    4460122 :     c = *p;</span>
<span class="lineNum">    2571 </span><span class="lineCov">    4460122 :     switch(c) {</span>
<span class="lineNum">    2572 </span>            :     case ' ':
<span class="lineNum">    2573 </span>            :     case '\t':
<span class="lineNum">    2574 </span><span class="lineCov">    1277816 :         tok = c;</span>
<span class="lineNum">    2575 </span><span class="lineCov">    1277816 :         p++;</span>
<span class="lineNum">    2576 </span><span class="lineCov">    1277816 :         if (parse_flags &amp; PARSE_FLAG_SPACES)</span>
<span class="lineNum">    2577 </span><span class="lineCov">     309013 :             goto keep_tok_flags;</span>
<span class="lineNum">    2578 </span><span class="lineCov">    2468441 :         while (isidnum_table[*p - CH_EOF] &amp; IS_SPC)</span>
<span class="lineNum">    2579 </span><span class="lineCov">     530835 :             ++p;</span>
<span class="lineNum">    2580 </span><span class="lineCov">     968803 :         goto redo_no_start;</span>
<span class="lineNum">    2581 </span>            :     case '\f':
<span class="lineNum">    2582 </span>            :     case '\v':
<span class="lineNum">    2583 </span>            :     case '\r':
<span class="lineNum">    2584 </span><span class="lineCov">        134 :         p++;</span>
<span class="lineNum">    2585 </span><span class="lineCov">        134 :         goto redo_no_start;</span>
<span class="lineNum">    2586 </span>            :     case '\\':
<span class="lineNum">    2587 </span>            :         /* first look if it is in fact an end of buffer */
<span class="lineNum">    2588 </span><span class="lineCov">      61830 :         c = handle_stray1(p);</span>
<span class="lineNum">    2589 </span><span class="lineCov">      61817 :         p = file-&gt;buf_ptr;</span>
<span class="lineNum">    2590 </span><span class="lineCov">      61817 :         if (c == '\\')</span>
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :             goto parse_simple;</span>
<span class="lineNum">    2592 </span><span class="lineCov">      61817 :         if (c != CH_EOF)</span>
<span class="lineNum">    2593 </span><span class="lineCov">      23196 :             goto redo_no_start;</span>
<span class="lineNum">    2594 </span>            :         {
<span class="lineNum">    2595 </span><span class="lineCov">      38621 :             TCCState *s1 = tcc_state;</span>
<span class="lineNum">    2596 </span><span class="lineCov">      38621 :             if ((parse_flags &amp; PARSE_FLAG_LINEFEED)</span>
<span class="lineNum">    2597 </span><span class="lineCov">      31771 :                 &amp;&amp; !(tok_flags &amp; TOK_FLAG_EOF)) {</span>
<span class="lineNum">    2598 </span><span class="lineCov">      31771 :                 tok_flags |= TOK_FLAG_EOF;</span>
<span class="lineNum">    2599 </span><span class="lineCov">      31771 :                 tok = TOK_LINEFEED;</span>
<span class="lineNum">    2600 </span><span class="lineCov">      31771 :                 goto keep_tok_flags;</span>
<span class="lineNum">    2601 </span><span class="lineCov">       6850 :             } else if (!(parse_flags &amp; PARSE_FLAG_PREPROCESS)) {</span>
<span class="lineNum">    2602 </span><span class="lineNoCov">          0 :                 tok = TOK_EOF;</span>
<span class="lineNum">    2603 </span><span class="lineCov">       6850 :             } else if (s1-&gt;ifdef_stack_ptr != file-&gt;ifdef_stack_ptr) {</span>
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;missing #endif&quot;);</span>
<span class="lineNum">    2605 </span><span class="lineCov">       6850 :             } else if (s1-&gt;include_stack_ptr == s1-&gt;include_stack) {</span>
<span class="lineNum">    2606 </span>            :                 /* no include left : end of file. */
<span class="lineNum">    2607 </span><span class="lineCov">        607 :                 tok = TOK_EOF;</span>
<span class="lineNum">    2608 </span>            :             } else {
<span class="lineNum">    2609 </span><span class="lineCov">       6243 :                 tok_flags &amp;= ~TOK_FLAG_EOF;</span>
<span class="lineNum">    2610 </span>            :                 /* pop include file */
<span class="lineNum">    2611 </span>            :                 
<span class="lineNum">    2612 </span>            :                 /* test if previous '#endif' was after a #ifdef at
<span class="lineNum">    2613 </span>            :                    start of file */
<span class="lineNum">    2614 </span><span class="lineCov">       6243 :                 if (tok_flags &amp; TOK_FLAG_ENDIF) {</span>
<span class="lineNum">    2615 </span>            : #ifdef INC_DEBUG
<span class="lineNum">    2616 </span>            :                     printf(&quot;#endif %s\n&quot;, get_tok_str(file-&gt;ifndef_macro_saved, NULL));
<span class="lineNum">    2617 </span>            : #endif
<span class="lineNum">    2618 </span><span class="lineCov">       2738 :                     search_cached_include(s1, file-&gt;filename, 1)</span>
<span class="lineNum">    2619 </span><span class="lineCov">       2738 :                         -&gt;ifndef_macro = file-&gt;ifndef_macro_saved;</span>
<span class="lineNum">    2620 </span><span class="lineCov">       2738 :                     tok_flags &amp;= ~TOK_FLAG_ENDIF;</span>
<span class="lineNum">    2621 </span>            :                 }
<span class="lineNum">    2622 </span>            : 
<span class="lineNum">    2623 </span>            :                 /* add end of include file debug info */
<span class="lineNum">    2624 </span><span class="lineCov">       6243 :                 if (tcc_state-&gt;do_debug) {</span>
<span class="lineNum">    2625 </span><span class="lineNoCov">          0 :                     put_stabd(N_EINCL, 0, 0);</span>
<span class="lineNum">    2626 </span>            :                 }
<span class="lineNum">    2627 </span>            :                 /* pop include stack */
<span class="lineNum">    2628 </span><span class="lineCov">       6243 :                 tcc_close();</span>
<span class="lineNum">    2629 </span><span class="lineCov">       6243 :                 s1-&gt;include_stack_ptr--;</span>
<span class="lineNum">    2630 </span><span class="lineCov">       6243 :                 p = file-&gt;buf_ptr;</span>
<span class="lineNum">    2631 </span><span class="lineCov">       6243 :                 if (p == file-&gt;buffer)</span>
<span class="lineNum">    2632 </span><span class="lineNoCov">          0 :                     tok_flags = TOK_FLAG_BOF|TOK_FLAG_BOL;</span>
<span class="lineNum">    2633 </span><span class="lineCov">       6243 :                 goto redo_no_start;</span>
<span class="lineNum">    2634 </span>            :             }
<span class="lineNum">    2635 </span>            :         }
<span class="lineNum">    2636 </span><span class="lineCov">        607 :         break;</span>
<span class="lineNum">    2637 </span>            : 
<span class="lineNum">    2638 </span>            :     case '\n':
<span class="lineNum">    2639 </span><span class="lineCov">     604429 :         file-&gt;line_num++;</span>
<span class="lineNum">    2640 </span><span class="lineCov">     604429 :         tok_flags |= TOK_FLAG_BOL;</span>
<span class="lineNum">    2641 </span><span class="lineCov">     604429 :         p++;</span>
<span class="lineNum">    2642 </span>            : maybe_newline:
<span class="lineNum">    2643 </span><span class="lineCov">     847004 :         if (0 == (parse_flags &amp; PARSE_FLAG_LINEFEED))</span>
<span class="lineNum">    2644 </span><span class="lineCov">     587171 :             goto redo_no_start;</span>
<span class="lineNum">    2645 </span><span class="lineCov">     259833 :         tok = TOK_LINEFEED;</span>
<span class="lineNum">    2646 </span><span class="lineCov">     259833 :         goto keep_tok_flags;</span>
<span class="lineNum">    2647 </span>            : 
<span class="lineNum">    2648 </span>            :     case '#':
<span class="lineNum">    2649 </span>            :         /* XXX: simplify */
<span class="lineNum">    2650 </span><span class="lineCov">     246625 :         PEEKC(c, p);</span>
<span class="lineNum">    2651 </span><span class="lineCov">     489226 :         if ((tok_flags &amp; TOK_FLAG_BOL) &amp;&amp; </span>
<span class="lineNum">    2652 </span><span class="lineCov">     242601 :             (parse_flags &amp; PARSE_FLAG_PREPROCESS)) {</span>
<span class="lineNum">    2653 </span><span class="lineCov">     242601 :             file-&gt;buf_ptr = p;</span>
<span class="lineNum">    2654 </span><span class="lineCov">     242601 :             preprocess(tok_flags &amp; TOK_FLAG_BOF);</span>
<span class="lineNum">    2655 </span><span class="lineCov">     242575 :             p = file-&gt;buf_ptr;</span>
<span class="lineNum">    2656 </span><span class="lineCov">     242575 :             goto maybe_newline;</span>
<span class="lineNum">    2657 </span>            :         } else {
<span class="lineNum">    2658 </span><span class="lineCov">       4024 :             if (c == '#') {</span>
<span class="lineNum">    2659 </span><span class="lineCov">        350 :                 p++;</span>
<span class="lineNum">    2660 </span><span class="lineCov">        350 :                 tok = TOK_TWOSHARPS;</span>
<span class="lineNum">    2661 </span>            :             } else {
<span class="lineNum">    2662 </span><span class="lineCov">       3674 :                 if (parse_flags &amp; PARSE_FLAG_ASM_FILE) {</span>
<span class="lineNum">    2663 </span><span class="lineNoCov">          0 :                     p = parse_line_comment(p - 1);</span>
<span class="lineNum">    2664 </span><span class="lineNoCov">          0 :                     goto redo_no_start;</span>
<span class="lineNum">    2665 </span>            :                 } else {
<span class="lineNum">    2666 </span><span class="lineCov">       3674 :                     tok = '#';</span>
<span class="lineNum">    2667 </span>            :                 }
<span class="lineNum">    2668 </span>            :             }
<span class="lineNum">    2669 </span>            :         }
<span class="lineNum">    2670 </span><span class="lineCov">       4024 :         break;</span>
<span class="lineNum">    2671 </span>            :     
<span class="lineNum">    2672 </span>            :     /* dollar is allowed to start identifiers when not parsing asm */
<span class="lineNum">    2673 </span>            :     case '$':
<span class="lineNum">    2674 </span><span class="lineCov">          4 :         if (!(isidnum_table[c - CH_EOF] &amp; IS_ID)</span>
<span class="lineNum">    2675 </span><span class="lineNoCov">          0 :          || (parse_flags &amp; PARSE_FLAG_ASM_FILE))</span>
<span class="lineNum">    2676 </span>            :             goto parse_simple;
<span class="lineNum">    2677 </span>            : 
<span class="lineNum">    2678 </span>            :     case 'a': case 'b': case 'c': case 'd':
<span class="lineNum">    2679 </span>            :     case 'e': case 'f': case 'g': case 'h':
<span class="lineNum">    2680 </span>            :     case 'i': case 'j': case 'k': case 'l':
<span class="lineNum">    2681 </span>            :     case 'm': case 'n': case 'o': case 'p':
<span class="lineNum">    2682 </span>            :     case 'q': case 'r': case 's': case 't':
<span class="lineNum">    2683 </span>            :     case 'u': case 'v': case 'w': case 'x':
<span class="lineNum">    2684 </span>            :     case 'y': case 'z': 
<span class="lineNum">    2685 </span>            :     case 'A': case 'B': case 'C': case 'D':
<span class="lineNum">    2686 </span>            :     case 'E': case 'F': case 'G': case 'H':
<span class="lineNum">    2687 </span>            :     case 'I': case 'J': case 'K': 
<span class="lineNum">    2688 </span>            :     case 'M': case 'N': case 'O': case 'P':
<span class="lineNum">    2689 </span>            :     case 'Q': case 'R': case 'S': case 'T':
<span class="lineNum">    2690 </span>            :     case 'U': case 'V': case 'W': case 'X':
<span class="lineNum">    2691 </span>            :     case 'Y': case 'Z': 
<span class="lineNum">    2692 </span>            :     case '_':
<span class="lineNum">    2693 </span>            :     parse_ident_fast:
<span class="lineNum">    2694 </span><span class="lineCov">    1411433 :         p1 = p;</span>
<span class="lineNum">    2695 </span><span class="lineCov">    1411433 :         h = TOK_HASH_INIT;</span>
<span class="lineNum">    2696 </span><span class="lineCov">    1411433 :         h = TOK_HASH_FUNC(h, c);</span>
<span class="lineNum">    2697 </span><span class="lineCov">   12093994 :         while (c = *++p, isidnum_table[c - CH_EOF] &amp; (IS_ID|IS_NUM))</span>
<span class="lineNum">    2698 </span><span class="lineCov">    9271128 :             h = TOK_HASH_FUNC(h, c);</span>
<span class="lineNum">    2699 </span><span class="lineCov">    1411433 :         len = p - p1;</span>
<span class="lineNum">    2700 </span><span class="lineCov">    1411433 :         if (c != '\\') {</span>
<span class="lineNum">    2701 </span>            :             TokenSym **pts;
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span>            :             /* fast case : no stray found, so we have the full token
<span class="lineNum">    2704 </span>            :                and we have already hashed it */
<span class="lineNum">    2705 </span><span class="lineCov">    1400626 :             h &amp;= (TOK_HASH_SIZE - 1);</span>
<span class="lineNum">    2706 </span><span class="lineCov">    1400626 :             pts = &amp;hash_ident[h];</span>
<span class="lineNum">    2707 </span>            :             for(;;) {
<span class="lineNum">    2708 </span><span class="lineCov">    1468779 :                 ts = *pts;</span>
<span class="lineNum">    2709 </span><span class="lineCov">    1468779 :                 if (!ts)</span>
<span class="lineNum">    2710 </span><span class="lineCov">     260148 :                     break;</span>
<span class="lineNum">    2711 </span><span class="lineCov">    1208631 :                 if (ts-&gt;len == len &amp;&amp; !memcmp(ts-&gt;str, p1, len))</span>
<span class="lineNum">    2712 </span><span class="lineCov">    1140478 :                     goto token_found;</span>
<span class="lineNum">    2713 </span><span class="lineCov">      68153 :                 pts = &amp;(ts-&gt;hash_next);</span>
<span class="lineNum">    2714 </span><span class="lineCov">      68153 :             }</span>
<span class="lineNum">    2715 </span><span class="lineCov">     260148 :             ts = tok_alloc_new(pts, (char *) p1, len);</span>
<span class="lineNum">    2716 </span>            :         token_found: ;
<span class="lineNum">    2717 </span>            :         } else {
<span class="lineNum">    2718 </span>            :             /* slower case */
<span class="lineNum">    2719 </span><span class="lineCov">      10807 :             cstr_reset(&amp;tokcstr);</span>
<span class="lineNum">    2720 </span><span class="lineCov">      10807 :             cstr_cat(&amp;tokcstr, (char *) p1, len);</span>
<span class="lineNum">    2721 </span><span class="lineCov">      10807 :             p--;</span>
<span class="lineNum">    2722 </span><span class="lineCov">      10807 :             PEEKC(c, p);</span>
<span class="lineNum">    2723 </span>            :         parse_ident_slow:
<span class="lineNum">    2724 </span><span class="lineCov">     491498 :             while (isidnum_table[c - CH_EOF] &amp; (IS_ID|IS_NUM))</span>
<span class="lineNum">    2725 </span>            :             {
<span class="lineNum">    2726 </span><span class="lineCov">     469902 :                 cstr_ccat(&amp;tokcstr, c);</span>
<span class="lineNum">    2727 </span><span class="lineCov">     469902 :                 PEEKC(c, p);</span>
<span class="lineNum">    2728 </span>            :             }
<span class="lineNum">    2729 </span><span class="lineCov">      10798 :             ts = tok_alloc(tokcstr.data, tokcstr.size);</span>
<span class="lineNum">    2730 </span>            :         }
<span class="lineNum">    2731 </span><span class="lineCov">    1411424 :         tok = ts-&gt;tok;</span>
<span class="lineNum">    2732 </span><span class="lineCov">    1411424 :         break;</span>
<span class="lineNum">    2733 </span>            :     case 'L':
<span class="lineNum">    2734 </span><span class="lineCov">        700 :         t = p[1];</span>
<span class="lineNum">    2735 </span><span class="lineCov">        700 :         if (t != '\\' &amp;&amp; t != '\'' &amp;&amp; t != '\&quot;') {</span>
<span class="lineNum">    2736 </span>            :             /* fast case */
<span class="lineNum">    2737 </span>            :             goto parse_ident_fast;
<span class="lineNum">    2738 </span>            :         } else {
<span class="lineNum">    2739 </span><span class="lineCov">          1 :             PEEKC(c, p);</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :             if (c == '\'' || c == '\&quot;') {</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :                 is_long = 1;</span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :                 goto str_const;</span>
<span class="lineNum">    2743 </span>            :             } else {
<span class="lineNum">    2744 </span><span class="lineNoCov">          0 :                 cstr_reset(&amp;tokcstr);</span>
<span class="lineNum">    2745 </span><span class="lineNoCov">          0 :                 cstr_ccat(&amp;tokcstr, 'L');</span>
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :                 goto parse_ident_slow;</span>
<span class="lineNum">    2747 </span>            :             }
<span class="lineNum">    2748 </span>            :         }
<span class="lineNum">    2749 </span>            :         break;
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span>            :     case '0': case '1': case '2': case '3':
<span class="lineNum">    2752 </span>            :     case '4': case '5': case '6': case '7':
<span class="lineNum">    2753 </span>            :     case '8': case '9':
<span class="lineNum">    2754 </span><span class="lineCov">     100478 :         t = c;</span>
<span class="lineNum">    2755 </span><span class="lineCov">     100478 :         PEEKC(c, p);</span>
<span class="lineNum">    2756 </span>            :         /* after the first digit, accept digits, alpha, '.' or sign if
<span class="lineNum">    2757 </span>            :            prefixed by 'eEpP' */
<span class="lineNum">    2758 </span>            :     parse_num:
<span class="lineNum">    2759 </span><span class="lineCov">     100479 :         cstr_reset(&amp;tokcstr);</span>
<span class="lineNum">    2760 </span>            :         for(;;) {
<span class="lineNum">    2761 </span><span class="lineCov">     209984 :             cstr_ccat(&amp;tokcstr, t);</span>
<span class="lineNum">    2762 </span><span class="lineCov">     310473 :             if (!((isidnum_table[c - CH_EOF] &amp; (IS_ID|IS_NUM))</span>
<span class="lineNum">    2763 </span><span class="lineCov">     100570 :                   || c == '.'</span>
<span class="lineNum">    2764 </span><span class="lineCov">     100479 :                   || ((c == '+' || c == '-')</span>
<span class="lineNum">    2765 </span><span class="lineCov">         10 :                       &amp;&amp; (((t == 'e' || t == 'E')</span>
<span class="lineNum">    2766 </span><span class="lineCov">         10 :                             &amp;&amp; !(parse_flags &amp; PARSE_FLAG_ASM_FILE</span>
<span class="lineNum">    2767 </span>            :                                 /* 0xe+1 is 3 tokens in asm */
<span class="lineNum">    2768 </span><span class="lineNoCov">          0 :                                 &amp;&amp; ((char*)tokcstr.data)[0] == '0'</span>
<span class="lineNum">    2769 </span><span class="lineNoCov">          0 :                                 &amp;&amp; toup(((char*)tokcstr.data)[1]) == 'X'))</span>
<span class="lineNum">    2770 </span><span class="lineNoCov">          0 :                           || t == 'p' || t == 'P'))))</span>
<span class="lineNum">    2771 </span>            :                 break;
<span class="lineNum">    2772 </span><span class="lineCov">     109505 :             t = c;</span>
<span class="lineNum">    2773 </span><span class="lineCov">     109505 :             PEEKC(c, p);</span>
<span class="lineNum">    2774 </span><span class="lineCov">     109505 :         }</span>
<span class="lineNum">    2775 </span>            :         /* We add a trailing '\0' to ease parsing */
<span class="lineNum">    2776 </span><span class="lineCov">     100479 :         cstr_ccat(&amp;tokcstr, '\0');</span>
<span class="lineNum">    2777 </span><span class="lineCov">     100479 :         tokc.str.size = tokcstr.size;</span>
<span class="lineNum">    2778 </span><span class="lineCov">     100479 :         tokc.str.data = tokcstr.data;</span>
<span class="lineNum">    2779 </span><span class="lineCov">     100479 :         tok = TOK_PPNUM;</span>
<span class="lineNum">    2780 </span><span class="lineCov">     100479 :         break;</span>
<span class="lineNum">    2781 </span>            : 
<span class="lineNum">    2782 </span>            :     case '.':
<span class="lineNum">    2783 </span>            :         /* special dot handling because it can also start a number */
<span class="lineNum">    2784 </span><span class="lineCov">       3695 :         PEEKC(c, p);</span>
<span class="lineNum">    2785 </span><span class="lineCov">       3695 :         if (isnum(c)) {</span>
<span class="lineNum">    2786 </span><span class="lineCov">          1 :             t = '.';</span>
<span class="lineNum">    2787 </span><span class="lineCov">          1 :             goto parse_num;</span>
<span class="lineNum">    2788 </span><span class="lineCov">       3694 :         } else if ((isidnum_table['.' - CH_EOF] &amp; IS_ID)</span>
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :                    &amp;&amp; (isidnum_table[c - CH_EOF] &amp; (IS_ID|IS_NUM))) {</span>
<span class="lineNum">    2790 </span><span class="lineNoCov">          0 :             *--p = c = '.';</span>
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :             goto parse_ident_fast;</span>
<span class="lineNum">    2792 </span><span class="lineCov">       3694 :         } else if (c == '.') {</span>
<span class="lineNum">    2793 </span><span class="lineCov">       3632 :             PEEKC(c, p);</span>
<span class="lineNum">    2794 </span><span class="lineCov">       3632 :             if (c == '.') {</span>
<span class="lineNum">    2795 </span><span class="lineCov">       3632 :                 p++;</span>
<span class="lineNum">    2796 </span><span class="lineCov">       3632 :                 tok = TOK_DOTS;</span>
<span class="lineNum">    2797 </span>            :             } else {
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :                 *--p = '.'; /* may underflow into file-&gt;unget[] */</span>
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :                 tok = '.';</span>
<span class="lineNum">    2800 </span>            :             }
<span class="lineNum">    2801 </span>            :         } else {
<span class="lineNum">    2802 </span><span class="lineCov">         62 :             tok = '.';</span>
<span class="lineNum">    2803 </span>            :         }
<span class="lineNum">    2804 </span><span class="lineCov">       3694 :         break;</span>
<span class="lineNum">    2805 </span>            :     case '\'':
<span class="lineNum">    2806 </span>            :     case '\&quot;':
<span class="lineNum">    2807 </span><span class="lineCov">       3347 :         is_long = 0;</span>
<span class="lineNum">    2808 </span>            :     str_const:
<span class="lineNum">    2809 </span><span class="lineCov">       3347 :         cstr_reset(&amp;tokcstr);</span>
<span class="lineNum">    2810 </span><span class="lineCov">       3347 :         if (is_long)</span>
<span class="lineNum">    2811 </span><span class="lineNoCov">          0 :             cstr_ccat(&amp;tokcstr, 'L');</span>
<span class="lineNum">    2812 </span><span class="lineCov">       3347 :         cstr_ccat(&amp;tokcstr, c);</span>
<span class="lineNum">    2813 </span><span class="lineCov">       3347 :         p = parse_pp_string(p, c, &amp;tokcstr);</span>
<span class="lineNum">    2814 </span><span class="lineCov">       3341 :         cstr_ccat(&amp;tokcstr, c);</span>
<span class="lineNum">    2815 </span><span class="lineCov">       3341 :         cstr_ccat(&amp;tokcstr, '\0');</span>
<span class="lineNum">    2816 </span><span class="lineCov">       3341 :         tokc.str.size = tokcstr.size;</span>
<span class="lineNum">    2817 </span><span class="lineCov">       3341 :         tokc.str.data = tokcstr.data;</span>
<span class="lineNum">    2818 </span><span class="lineCov">       3341 :         tok = TOK_PPSTR;</span>
<span class="lineNum">    2819 </span><span class="lineCov">       3341 :         break;</span>
<span class="lineNum">    2820 </span>            : 
<span class="lineNum">    2821 </span>            :     case '&lt;':
<span class="lineNum">    2822 </span><span class="lineCov">       2394 :         PEEKC(c, p);</span>
<span class="lineNum">    2823 </span><span class="lineCov">       2393 :         if (c == '=') {</span>
<span class="lineNum">    2824 </span><span class="lineCov">        383 :             p++;</span>
<span class="lineNum">    2825 </span><span class="lineCov">        383 :             tok = TOK_LE;</span>
<span class="lineNum">    2826 </span><span class="lineCov">       2010 :         } else if (c == '&lt;') {</span>
<span class="lineNum">    2827 </span><span class="lineCov">        775 :             PEEKC(c, p);</span>
<span class="lineNum">    2828 </span><span class="lineCov">        775 :             if (c == '=') {</span>
<span class="lineNum">    2829 </span><span class="lineNoCov">          0 :                 p++;</span>
<span class="lineNum">    2830 </span><span class="lineNoCov">          0 :                 tok = TOK_A_SHL;</span>
<span class="lineNum">    2831 </span>            :             } else {
<span class="lineNum">    2832 </span><span class="lineCov">        775 :                 tok = TOK_SHL;</span>
<span class="lineNum">    2833 </span>            :             }
<span class="lineNum">    2834 </span>            :         } else {
<span class="lineNum">    2835 </span><span class="lineCov">       1235 :             tok = TOK_LT;</span>
<span class="lineNum">    2836 </span>            :         }
<span class="lineNum">    2837 </span><span class="lineCov">       2393 :         break;</span>
<span class="lineNum">    2838 </span>            :     case '&gt;':
<span class="lineNum">    2839 </span><span class="lineCov">       8239 :         PEEKC(c, p);</span>
<span class="lineNum">    2840 </span><span class="lineCov">       8239 :         if (c == '=') {</span>
<span class="lineNum">    2841 </span><span class="lineCov">       6679 :             p++;</span>
<span class="lineNum">    2842 </span><span class="lineCov">       6679 :             tok = TOK_GE;</span>
<span class="lineNum">    2843 </span><span class="lineCov">       1560 :         } else if (c == '&gt;') {</span>
<span class="lineNum">    2844 </span><span class="lineCov">        110 :             PEEKC(c, p);</span>
<span class="lineNum">    2845 </span><span class="lineCov">        110 :             if (c == '=') {</span>
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :                 p++;</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :                 tok = TOK_A_SAR;</span>
<span class="lineNum">    2848 </span>            :             } else {
<span class="lineNum">    2849 </span><span class="lineCov">        110 :                 tok = TOK_SAR;</span>
<span class="lineNum">    2850 </span>            :             }
<span class="lineNum">    2851 </span>            :         } else {
<span class="lineNum">    2852 </span><span class="lineCov">       1450 :             tok = TOK_GT;</span>
<span class="lineNum">    2853 </span>            :         }
<span class="lineNum">    2854 </span><span class="lineCov">       8239 :         break;</span>
<span class="lineNum">    2855 </span>            :         
<span class="lineNum">    2856 </span>            :     case '&amp;':
<span class="lineNum">    2857 </span><span class="lineCov">      26020 :         PEEKC(c, p);</span>
<span class="lineNum">    2858 </span><span class="lineCov">      26020 :         if (c == '&amp;') {</span>
<span class="lineNum">    2859 </span><span class="lineCov">      23407 :             p++;</span>
<span class="lineNum">    2860 </span><span class="lineCov">      23407 :             tok = TOK_LAND;</span>
<span class="lineNum">    2861 </span><span class="lineCov">       2613 :         } else if (c == '=') {</span>
<span class="lineNum">    2862 </span><span class="lineCov">          8 :             p++;</span>
<span class="lineNum">    2863 </span><span class="lineCov">          8 :             tok = TOK_A_AND;</span>
<span class="lineNum">    2864 </span>            :         } else {
<span class="lineNum">    2865 </span><span class="lineCov">       2605 :             tok = '&amp;';</span>
<span class="lineNum">    2866 </span>            :         }
<span class="lineNum">    2867 </span><span class="lineCov">      26020 :         break;</span>
<span class="lineNum">    2868 </span>            :         
<span class="lineNum">    2869 </span>            :     case '|':
<span class="lineNum">    2870 </span><span class="lineCov">      16650 :         PEEKC(c, p);</span>
<span class="lineNum">    2871 </span><span class="lineCov">      16650 :         if (c == '|') {</span>
<span class="lineNum">    2872 </span><span class="lineCov">      16478 :             p++;</span>
<span class="lineNum">    2873 </span><span class="lineCov">      16478 :             tok = TOK_LOR;</span>
<span class="lineNum">    2874 </span><span class="lineCov">        172 :         } else if (c == '=') {</span>
<span class="lineNum">    2875 </span><span class="lineCov">          8 :             p++;</span>
<span class="lineNum">    2876 </span><span class="lineCov">          8 :             tok = TOK_A_OR;</span>
<span class="lineNum">    2877 </span>            :         } else {
<span class="lineNum">    2878 </span><span class="lineCov">        164 :             tok = '|';</span>
<span class="lineNum">    2879 </span>            :         }
<span class="lineNum">    2880 </span><span class="lineCov">      16650 :         break;</span>
<span class="lineNum">    2881 </span>            : 
<span class="lineNum">    2882 </span>            :     case '+':
<span class="lineNum">    2883 </span><span class="lineCov">       1771 :         PEEKC(c, p);</span>
<span class="lineNum">    2884 </span><span class="lineCov">       1771 :         if (c == '+') {</span>
<span class="lineNum">    2885 </span><span class="lineCov">        933 :             p++;</span>
<span class="lineNum">    2886 </span><span class="lineCov">        933 :             tok = TOK_INC;</span>
<span class="lineNum">    2887 </span><span class="lineCov">        838 :         } else if (c == '=') {</span>
<span class="lineNum">    2888 </span><span class="lineCov">         46 :             p++;</span>
<span class="lineNum">    2889 </span><span class="lineCov">         46 :             tok = TOK_A_ADD;</span>
<span class="lineNum">    2890 </span>            :         } else {
<span class="lineNum">    2891 </span><span class="lineCov">        792 :             tok = '+';</span>
<span class="lineNum">    2892 </span>            :         }
<span class="lineNum">    2893 </span><span class="lineCov">       1771 :         break;</span>
<span class="lineNum">    2894 </span>            :         
<span class="lineNum">    2895 </span>            :     case '-':
<span class="lineNum">    2896 </span><span class="lineCov">       8105 :         PEEKC(c, p);</span>
<span class="lineNum">    2897 </span><span class="lineCov">       8105 :         if (c == '-') {</span>
<span class="lineNum">    2898 </span><span class="lineCov">         40 :             p++;</span>
<span class="lineNum">    2899 </span><span class="lineCov">         40 :             tok = TOK_DEC;</span>
<span class="lineNum">    2900 </span><span class="lineCov">       8065 :         } else if (c == '=') {</span>
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :             p++;</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :             tok = TOK_A_SUB;</span>
<span class="lineNum">    2903 </span><span class="lineCov">       8065 :         } else if (c == '&gt;') {</span>
<span class="lineNum">    2904 </span><span class="lineCov">       4628 :             p++;</span>
<span class="lineNum">    2905 </span><span class="lineCov">       4628 :             tok = TOK_ARROW;</span>
<span class="lineNum">    2906 </span>            :         } else {
<span class="lineNum">    2907 </span><span class="lineCov">       3437 :             tok = '-';</span>
<span class="lineNum">    2908 </span>            :         }
<span class="lineNum">    2909 </span><span class="lineCov">       8105 :         break;</span>
<span class="lineNum">    2910 </span>            : 
<span class="lineNum">    2911 </span><span class="lineCov">      19734 :     PARSE2('!', '!', '=', TOK_NE)</span>
<span class="lineNum">    2912 </span><span class="lineCov">       4335 :     PARSE2('=', '=', '=', TOK_EQ)</span>
<span class="lineNum">    2913 </span><span class="lineCov">      76345 :     PARSE2('*', '*', '=', TOK_A_MUL)</span>
<span class="lineNum">    2914 </span><span class="lineCov">         88 :     PARSE2('%', '%', '=', TOK_A_MOD)</span>
<span class="lineNum">    2915 </span><span class="lineCov">         27 :     PARSE2('^', '^', '=', TOK_A_XOR)</span>
<span class="lineNum">    2916 </span>            :         
<span class="lineNum">    2917 </span>            :         /* comments or operator */
<span class="lineNum">    2918 </span>            :     case '/':
<span class="lineNum">    2919 </span><span class="lineCov">     116011 :         PEEKC(c, p);</span>
<span class="lineNum">    2920 </span><span class="lineCov">     116008 :         if (c == '*') {</span>
<span class="lineNum">    2921 </span><span class="lineCov">     114839 :             p = parse_comment(p);</span>
<span class="lineNum">    2922 </span>            :             /* comments replaced by a blank */
<span class="lineNum">    2923 </span><span class="lineCov">     114103 :             tok = ' ';</span>
<span class="lineNum">    2924 </span><span class="lineCov">     114103 :             goto keep_tok_flags;</span>
<span class="lineNum">    2925 </span><span class="lineCov">       1169 :         } else if (c == '/') {</span>
<span class="lineNum">    2926 </span><span class="lineCov">        992 :             p = parse_line_comment(p);</span>
<span class="lineNum">    2927 </span><span class="lineCov">        992 :             tok = ' ';</span>
<span class="lineNum">    2928 </span><span class="lineCov">        992 :             goto keep_tok_flags;</span>
<span class="lineNum">    2929 </span><span class="lineCov">        177 :         } else if (c == '=') {</span>
<span class="lineNum">    2930 </span><span class="lineCov">         27 :             p++;</span>
<span class="lineNum">    2931 </span><span class="lineCov">         27 :             tok = TOK_A_DIV;</span>
<span class="lineNum">    2932 </span>            :         } else {
<span class="lineNum">    2933 </span><span class="lineCov">        150 :             tok = '/';</span>
<span class="lineNum">    2934 </span>            :         }
<span class="lineNum">    2935 </span><span class="lineCov">        177 :         break;</span>
<span class="lineNum">    2936 </span>            :         
<span class="lineNum">    2937 </span>            :         /* simple tokens */
<span class="lineNum">    2938 </span>            :     case '(':
<span class="lineNum">    2939 </span>            :     case ')':
<span class="lineNum">    2940 </span>            :     case '[':
<span class="lineNum">    2941 </span>            :     case ']':
<span class="lineNum">    2942 </span>            :     case '{':
<span class="lineNum">    2943 </span>            :     case '}':
<span class="lineNum">    2944 </span>            :     case ',':
<span class="lineNum">    2945 </span>            :     case ';':
<span class="lineNum">    2946 </span>            :     case ':':
<span class="lineNum">    2947 </span>            :     case '?':
<span class="lineNum">    2948 </span>            :     case '~':
<span class="lineNum">    2949 </span>            :     case '@': /* only used in assembler */
<span class="lineNum">    2950 </span>            :     parse_simple:
<span class="lineNum">    2951 </span><span class="lineCov">     470538 :         tok = c;</span>
<span class="lineNum">    2952 </span><span class="lineCov">     470538 :         p++;</span>
<span class="lineNum">    2953 </span><span class="lineCov">     470538 :         break;</span>
<span class="lineNum">    2954 </span>            :     default:
<span class="lineNum">    2955 </span><span class="lineCov">         93 :         if (c &gt;= 0x80 &amp;&amp; c &lt;= 0xFF) /* utf8 identifiers */</span>
<span class="lineNum">    2956 </span><span class="lineCov">         16 :             goto parse_ident_fast;</span>
<span class="lineNum">    2957 </span><span class="lineCov">         77 :         if (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">    2958 </span><span class="lineNoCov">          0 :             goto parse_simple;</span>
<span class="lineNum">    2959 </span><span class="lineCov">         77 :         tcc_error(&quot;unrecognized character \\x%02x&quot;, c);</span>
<span class="lineNum">    2960 </span>            :         break;
<span class="lineNum">    2961 </span>            :     }
<span class="lineNum">    2962 </span><span class="lineCov">    2157991 :     tok_flags = 0;</span>
<span class="lineNum">    2963 </span>            : keep_tok_flags:
<span class="lineNum">    2964 </span><span class="lineCov">    2873703 :     file-&gt;buf_ptr = p;</span>
<span class="lineNum">    2965 </span>            : #if defined(PARSE_DEBUG)
<span class="lineNum">    2966 </span>            :     printf(&quot;token = %d %s\n&quot;, tok, get_tok_str(tok, &amp;tokc));
<span class="lineNum">    2967 </span>            : #endif
<span class="lineNum">    2968 </span><span class="lineCov">    2873703 : }</span>
<span class="lineNum">    2969 </span>            : 
<a name="2970"><span class="lineNum">    2970 </span>            : /* return next token without macro substitution. Can read input from</a>
<span class="lineNum">    2971 </span>            :    macro_ptr buffer */
<span class="lineNum">    2972 </span><span class="lineCov">    3473504 : static void next_nomacro_spc(void)</span>
<span class="lineNum">    2973 </span>            : {
<span class="lineNum">    2974 </span><span class="lineCov">    3473504 :     if (macro_ptr) {</span>
<span class="lineNum">    2975 </span>            :     redo:
<span class="lineNum">    2976 </span><span class="lineCov">     684224 :         tok = *macro_ptr;</span>
<span class="lineNum">    2977 </span><span class="lineCov">     684224 :         if (tok) {</span>
<span class="lineNum">    2978 </span><span class="lineCov">     561717 :             TOK_GET(&amp;tok, &amp;macro_ptr, &amp;tokc);</span>
<span class="lineNum">    2979 </span><span class="lineCov">     561717 :             if (tok == TOK_LINENUM) {</span>
<span class="lineNum">    2980 </span><span class="lineCov">      80475 :                 file-&gt;line_num = tokc.i;</span>
<span class="lineNum">    2981 </span><span class="lineCov">      80475 :                 goto redo;</span>
<span class="lineNum">    2982 </span>            :             }
<span class="lineNum">    2983 </span>            :         }
<span class="lineNum">    2984 </span>            :     } else {
<span class="lineNum">    2985 </span><span class="lineCov">    2869755 :         next_nomacro1();</span>
<span class="lineNum">    2986 </span>            :     }
<span class="lineNum">    2987 </span>            :     //printf(&quot;token = %s\n&quot;, get_tok_str(tok, &amp;tokc));
<a name="2988"><span class="lineNum">    2988 </span><span class="lineCov">    3472632 : }</span></a>
<span class="lineNum">    2989 </span>            : 
<span class="lineNum">    2990 </span><span class="lineCov">    2539326 : ST_FUNC void next_nomacro(void)</span>
<span class="lineNum">    2991 </span>            : {
<span class="lineNum">    2992 </span>            :     do {
<span class="lineNum">    2993 </span><span class="lineCov">    2539326 :         next_nomacro_spc();</span>
<span class="lineNum">    2994 </span><span class="lineCov">    2538454 :     } while (tok &lt; 256 &amp;&amp; (isidnum_table[tok - CH_EOF] &amp; IS_SPC));</span>
<span class="lineNum">    2995 </span><span class="lineCov">    2366902 : }</span>
<span class="lineNum">    2996 </span>            :  
<span class="lineNum">    2997 </span>            : 
<span class="lineNum">    2998 </span>            : static void macro_subst(
<span class="lineNum">    2999 </span>            :     TokenString *tok_str,
<span class="lineNum">    3000 </span>            :     Sym **nested_list,
<span class="lineNum">    3001 </span>            :     const int *macro_str
<span class="lineNum">    3002 </span>            :     );
<span class="lineNum">    3003 </span>            : 
<a name="3004"><span class="lineNum">    3004 </span>            : /* substitute arguments in replacement lists in macro_str by the values in</a>
<span class="lineNum">    3005 </span>            :    args (field d) and return allocated string */
<span class="lineNum">    3006 </span><span class="lineCov">      23438 : static int *macro_arg_subst(Sym **nested_list, const int *macro_str, Sym *args)</span>
<span class="lineNum">    3007 </span>            : {
<span class="lineNum">    3008 </span>            :     int t, t0, t1, spc;
<span class="lineNum">    3009 </span>            :     const int *st;
<span class="lineNum">    3010 </span>            :     Sym *s;
<span class="lineNum">    3011 </span>            :     CValue cval;
<span class="lineNum">    3012 </span>            :     TokenString str;
<span class="lineNum">    3013 </span>            :     CString cstr;
<span class="lineNum">    3014 </span>            : 
<span class="lineNum">    3015 </span><span class="lineCov">      23438 :     tok_str_new(&amp;str);</span>
<span class="lineNum">    3016 </span><span class="lineCov">      23438 :     t0 = t1 = 0;</span>
<span class="lineNum">    3017 </span>            :     while(1) {
<span class="lineNum">    3018 </span><span class="lineCov">     149634 :         TOK_GET(&amp;t, &amp;macro_str, &amp;cval);</span>
<span class="lineNum">    3019 </span><span class="lineCov">     149634 :         if (!t)</span>
<span class="lineNum">    3020 </span><span class="lineCov">      23438 :             break;</span>
<span class="lineNum">    3021 </span><span class="lineCov">     126196 :         if (t == '#') {</span>
<span class="lineNum">    3022 </span>            :             /* stringize */
<span class="lineNum">    3023 </span><span class="lineCov">       1988 :             TOK_GET(&amp;t, &amp;macro_str, &amp;cval);</span>
<span class="lineNum">    3024 </span><span class="lineCov">       1988 :             if (!t)</span>
<span class="lineNum">    3025 </span><span class="lineNoCov">          0 :                 goto bad_stringy;</span>
<span class="lineNum">    3026 </span><span class="lineCov">       1988 :             s = sym_find2(args, t);</span>
<span class="lineNum">    3027 </span><span class="lineCov">       1988 :             if (s) {</span>
<span class="lineNum">    3028 </span><span class="lineCov">       1988 :                 cstr_new(&amp;cstr);</span>
<span class="lineNum">    3029 </span><span class="lineCov">       1988 :                 cstr_ccat(&amp;cstr, '\&quot;');</span>
<span class="lineNum">    3030 </span><span class="lineCov">       1988 :                 st = s-&gt;d;</span>
<span class="lineNum">    3031 </span><span class="lineCov">       1988 :                 spc = 0;</span>
<span class="lineNum">    3032 </span><span class="lineCov">       5964 :                 while (*st &gt;= 0) {</span>
<span class="lineNum">    3033 </span><span class="lineCov">       1988 :                     TOK_GET(&amp;t, &amp;st, &amp;cval);</span>
<span class="lineNum">    3034 </span><span class="lineCov">       1988 :                     if (t != TOK_PLCHLDR</span>
<span class="lineNum">    3035 </span><span class="lineCov">       1988 :                      &amp;&amp; t != TOK_NOSUBST</span>
<span class="lineNum">    3036 </span><span class="lineCov">       1988 :                      &amp;&amp; 0 == check_space(t, &amp;spc)) {</span>
<span class="lineNum">    3037 </span><span class="lineCov">       1988 :                         const char *s = get_tok_str(t, &amp;cval);</span>
<span class="lineNum">    3038 </span><span class="lineCov">      34134 :                         while (*s) {</span>
<span class="lineNum">    3039 </span><span class="lineCov">      30158 :                             if (t == TOK_PPSTR &amp;&amp; *s != '\'')</span>
<span class="lineNum">    3040 </span><span class="lineNoCov">          0 :                                 add_char(&amp;cstr, *s);</span>
<span class="lineNum">    3041 </span>            :                             else
<span class="lineNum">    3042 </span><span class="lineCov">      30158 :                                 cstr_ccat(&amp;cstr, *s);</span>
<span class="lineNum">    3043 </span><span class="lineCov">      30158 :                             ++s;</span>
<span class="lineNum">    3044 </span>            :                         }
<span class="lineNum">    3045 </span>            :                     }
<span class="lineNum">    3046 </span>            :                 }
<span class="lineNum">    3047 </span><span class="lineCov">       1988 :                 cstr.size -= spc;</span>
<span class="lineNum">    3048 </span><span class="lineCov">       1988 :                 cstr_ccat(&amp;cstr, '\&quot;');</span>
<span class="lineNum">    3049 </span><span class="lineCov">       1988 :                 cstr_ccat(&amp;cstr, '\0');</span>
<span class="lineNum">    3050 </span>            : #ifdef PP_DEBUG
<span class="lineNum">    3051 </span>            :                 printf(&quot;\nstringize: &lt;%s&gt;\n&quot;, (char *)cstr.data);
<span class="lineNum">    3052 </span>            : #endif
<span class="lineNum">    3053 </span>            :                 /* add string */
<span class="lineNum">    3054 </span><span class="lineCov">       1988 :                 cval.str.size = cstr.size;</span>
<span class="lineNum">    3055 </span><span class="lineCov">       1988 :                 cval.str.data = cstr.data;</span>
<span class="lineNum">    3056 </span><span class="lineCov">       1988 :                 tok_str_add2(&amp;str, TOK_PPSTR, &amp;cval);</span>
<span class="lineNum">    3057 </span><span class="lineCov">       1988 :                 cstr_free(&amp;cstr);</span>
<span class="lineNum">    3058 </span>            :             } else {
<span class="lineNum">    3059 </span>            :         bad_stringy:
<span class="lineNum">    3060 </span><span class="lineNoCov">          0 :                 expect(&quot;macro parameter after '#'&quot;);</span>
<span class="lineNum">    3061 </span>            :             }
<span class="lineNum">    3062 </span><span class="lineCov">     124208 :         } else if (t &gt;= TOK_IDENT) {</span>
<span class="lineNum">    3063 </span><span class="lineCov">      50994 :             s = sym_find2(args, t);</span>
<span class="lineNum">    3064 </span><span class="lineCov">      50994 :             if (s) {</span>
<span class="lineNum">    3065 </span><span class="lineCov">      32900 :                 int l0 = str.len;</span>
<span class="lineNum">    3066 </span><span class="lineCov">      32900 :                 st = s-&gt;d;</span>
<span class="lineNum">    3067 </span>            :                 /* if '##' is present before or after, no arg substitution */
<span class="lineNum">    3068 </span><span class="lineCov">      32900 :                 if (*macro_str == TOK_PPJOIN || t1 == TOK_PPJOIN) {</span>
<span class="lineNum">    3069 </span>            :                     /* special case for var arg macros : ## eats the ','
<span class="lineNum">    3070 </span>            :                        if empty VA_ARGS variable. */
<span class="lineNum">    3071 </span><span class="lineCov">      13320 :                     if (t1 == TOK_PPJOIN &amp;&amp; t0 == ',' &amp;&amp; gnu_ext &amp;&amp; s-&gt;type.t) {</span>
<span class="lineNum">    3072 </span><span class="lineNoCov">          0 :                         if (*st &lt;= 0) {</span>
<span class="lineNum">    3073 </span>            :                             /* suppress ',' '##' */
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 :                             str.len -= 2;</span>
<span class="lineNum">    3075 </span>            :                         } else {
<span class="lineNum">    3076 </span>            :                             /* suppress '##' and add variable */
<span class="lineNum">    3077 </span><span class="lineNoCov">          0 :                             str.len--;</span>
<span class="lineNum">    3078 </span><span class="lineNoCov">          0 :                             goto add_var;</span>
<span class="lineNum">    3079 </span>            :                         }
<span class="lineNum">    3080 </span>            :                     }
<span class="lineNum">    3081 </span>            :                 } else {
<span class="lineNum">    3082 </span>            :             add_var:
<span class="lineNum">    3083 </span><span class="lineCov">      26240 :                     if (!s-&gt;next) {</span>
<span class="lineNum">    3084 </span>            :                         /* Expand arguments tokens and store them.  In most
<span class="lineNum">    3085 </span>            :                            cases we could also re-expand each argument if
<span class="lineNum">    3086 </span>            :                            used multiple times, but not if the argument
<span class="lineNum">    3087 </span>            :                            contains the __COUNTER__ macro.  */
<span class="lineNum">    3088 </span>            :                         TokenString str2;
<span class="lineNum">    3089 </span><span class="lineCov">      21702 :                         sym_push2(&amp;s-&gt;next, s-&gt;v, s-&gt;type.t, 0);</span>
<span class="lineNum">    3090 </span><span class="lineCov">      21702 :                         tok_str_new(&amp;str2);</span>
<span class="lineNum">    3091 </span><span class="lineCov">      21702 :                         macro_subst(&amp;str2, nested_list, st);</span>
<span class="lineNum">    3092 </span><span class="lineCov">      21702 :                         tok_str_add(&amp;str2, 0);</span>
<span class="lineNum">    3093 </span><span class="lineCov">      21702 :                         s-&gt;next-&gt;d = str2.str;</span>
<span class="lineNum">    3094 </span>            :                     }
<span class="lineNum">    3095 </span><span class="lineCov">      26240 :                     st = s-&gt;next-&gt;d;</span>
<span class="lineNum">    3096 </span>            :                 }
<span class="lineNum">    3097 </span>            :                 for(;;) {
<span class="lineNum">    3098 </span>            :                     int t2;
<span class="lineNum">    3099 </span><span class="lineCov">     136493 :                     TOK_GET(&amp;t2, &amp;st, &amp;cval);</span>
<span class="lineNum">    3100 </span><span class="lineCov">     136493 :                     if (t2 &lt;= 0)</span>
<span class="lineNum">    3101 </span><span class="lineCov">      32900 :                         break;</span>
<span class="lineNum">    3102 </span><span class="lineCov">     103593 :                     tok_str_add2(&amp;str, t2, &amp;cval);</span>
<span class="lineNum">    3103 </span><span class="lineCov">     103593 :                 }</span>
<span class="lineNum">    3104 </span><span class="lineCov">      32900 :                 if (str.len == l0) /* expanded to empty string */</span>
<span class="lineNum">    3105 </span><span class="lineCov">       1275 :                     tok_str_add(&amp;str, TOK_PLCHLDR);</span>
<span class="lineNum">    3106 </span>            :             } else {
<span class="lineNum">    3107 </span><span class="lineCov">      18094 :                 tok_str_add(&amp;str, t);</span>
<span class="lineNum">    3108 </span>            :             }
<span class="lineNum">    3109 </span>            :         } else {
<span class="lineNum">    3110 </span><span class="lineCov">      73214 :             tok_str_add2(&amp;str, t, &amp;cval);</span>
<span class="lineNum">    3111 </span>            :         }
<span class="lineNum">    3112 </span><span class="lineCov">     126196 :         t0 = t1, t1 = t;</span>
<span class="lineNum">    3113 </span><span class="lineCov">     126196 :     }</span>
<span class="lineNum">    3114 </span><span class="lineCov">      23438 :     tok_str_add(&amp;str, 0);</span>
<span class="lineNum">    3115 </span><span class="lineCov">      23438 :     return str.str;</span>
<span class="lineNum">    3116 </span>            : }
<span class="lineNum">    3117 </span>            : 
<span class="lineNum">    3118 </span>            : static char const ab_month_name[12][4] =
<span class="lineNum">    3119 </span>            : {
<span class="lineNum">    3120 </span>            :     &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,
<span class="lineNum">    3121 </span>            :     &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;
<a name="3122"><span class="lineNum">    3122 </span>            : };</a>
<span class="lineNum">    3123 </span>            : 
<span class="lineNum">    3124 </span><span class="lineCov">       4820 : static int paste_tokens(int t1, CValue *v1, int t2, CValue *v2)</span>
<span class="lineNum">    3125 </span>            : {
<span class="lineNum">    3126 </span>            :     CString cstr;
<span class="lineNum">    3127 </span><span class="lineCov">       4820 :     int n, ret = 1;</span>
<span class="lineNum">    3128 </span>            : 
<span class="lineNum">    3129 </span><span class="lineCov">       4820 :     cstr_new(&amp;cstr);</span>
<span class="lineNum">    3130 </span><span class="lineCov">       4820 :     if (t1 != TOK_PLCHLDR)</span>
<span class="lineNum">    3131 </span><span class="lineCov">       4820 :         cstr_cat(&amp;cstr, get_tok_str(t1, v1), -1);</span>
<span class="lineNum">    3132 </span><span class="lineCov">       4820 :     n = cstr.size;</span>
<span class="lineNum">    3133 </span><span class="lineCov">       4820 :     if (t2 != TOK_PLCHLDR)</span>
<span class="lineNum">    3134 </span><span class="lineCov">       2615 :         cstr_cat(&amp;cstr, get_tok_str(t2, v2), -1);</span>
<span class="lineNum">    3135 </span><span class="lineCov">       4820 :     cstr_ccat(&amp;cstr, '\0');</span>
<span class="lineNum">    3136 </span>            : 
<span class="lineNum">    3137 </span><span class="lineCov">       4820 :     tcc_open_bf(tcc_state, &quot;:paste:&quot;, cstr.size);</span>
<span class="lineNum">    3138 </span><span class="lineCov">       4820 :     memcpy(file-&gt;buffer, cstr.data, cstr.size);</span>
<span class="lineNum">    3139 </span><span class="lineCov">       4820 :     tok_flags = 0;</span>
<span class="lineNum">    3140 </span>            :     for (;;) {
<span class="lineNum">    3141 </span><span class="lineCov">       4820 :         next_nomacro1();</span>
<span class="lineNum">    3142 </span><span class="lineCov">       4820 :         if (0 == *file-&gt;buf_ptr)</span>
<span class="lineNum">    3143 </span><span class="lineCov">       4820 :             break;</span>
<span class="lineNum">    3144 </span><span class="lineNoCov">          0 :         if (is_space(tok))</span>
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    3146 </span><span class="lineNoCov">          0 :         tcc_warning(&quot;pasting \&quot;%.*s\&quot; and \&quot;%s\&quot; does not give a valid&quot;</span>
<span class="lineNum">    3147 </span><span class="lineNoCov">          0 :             &quot; preprocessing token&quot;, n, cstr.data, (char*)cstr.data + n);</span>
<span class="lineNum">    3148 </span><span class="lineNoCov">          0 :         ret = 0;</span>
<span class="lineNum">    3149 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    3150 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3151 </span><span class="lineCov">       4820 :     tcc_close();</span>
<span class="lineNum">    3152 </span>            :     //printf(&quot;paste &lt;%s&gt;\n&quot;, (char*)cstr.data);
<span class="lineNum">    3153 </span><span class="lineCov">       4820 :     cstr_free(&amp;cstr);</span>
<span class="lineNum">    3154 </span><span class="lineCov">       4820 :     return ret;</span>
<span class="lineNum">    3155 </span>            : }
<span class="lineNum">    3156 </span>            : 
<a name="3157"><span class="lineNum">    3157 </span>            : /* handle the '##' operator. Return NULL if no '##' seen. Otherwise</a>
<span class="lineNum">    3158 </span>            :    return the resulting string (which must be freed). */
<span class="lineNum">    3159 </span><span class="lineCov">     151994 : static inline int *macro_twosharps(const int *ptr0)</span>
<span class="lineNum">    3160 </span>            : {
<span class="lineNum">    3161 </span>            :     int t;
<span class="lineNum">    3162 </span>            :     CValue cval;
<span class="lineNum">    3163 </span>            :     TokenString macro_str1;
<span class="lineNum">    3164 </span><span class="lineCov">     151994 :     int start_of_nosubsts = -1;</span>
<span class="lineNum">    3165 </span>            :     const int *ptr;
<span class="lineNum">    3166 </span>            : 
<span class="lineNum">    3167 </span>            :     /* we search the first '##' */
<span class="lineNum">    3168 </span><span class="lineCov">     151994 :     for (ptr = ptr0;;) {</span>
<span class="lineNum">    3169 </span><span class="lineCov">     435859 :         TOK_GET(&amp;t, &amp;ptr, &amp;cval);</span>
<span class="lineNum">    3170 </span><span class="lineCov">     435859 :         if (t == TOK_PPJOIN)</span>
<span class="lineNum">    3171 </span><span class="lineCov">       3330 :             break;</span>
<span class="lineNum">    3172 </span><span class="lineCov">     432529 :         if (t == 0)</span>
<span class="lineNum">    3173 </span><span class="lineCov">     148664 :             return NULL;</span>
<span class="lineNum">    3174 </span><span class="lineCov">     283865 :     }</span>
<span class="lineNum">    3175 </span>            : 
<span class="lineNum">    3176 </span><span class="lineCov">       3330 :     tok_str_new(&amp;macro_str1);</span>
<span class="lineNum">    3177 </span>            : 
<span class="lineNum">    3178 </span>            :     //tok_print(&quot; $$$&quot;, ptr0);
<span class="lineNum">    3179 </span><span class="lineCov">       3330 :     for (ptr = ptr0;;) {</span>
<span class="lineNum">    3180 </span><span class="lineCov">       6660 :         TOK_GET(&amp;t, &amp;ptr, &amp;cval);</span>
<span class="lineNum">    3181 </span><span class="lineCov">       6660 :         if (t == 0)</span>
<span class="lineNum">    3182 </span><span class="lineCov">       3330 :             break;</span>
<span class="lineNum">    3183 </span><span class="lineCov">       3330 :         if (t == TOK_PPJOIN)</span>
<span class="lineNum">    3184 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    3185 </span><span class="lineCov">      11480 :         while (*ptr == TOK_PPJOIN) {</span>
<span class="lineNum">    3186 </span>            :             int t1; CValue cv1;
<span class="lineNum">    3187 </span>            :             /* given 'a##b', remove nosubsts preceding 'a' */
<span class="lineNum">    3188 </span><span class="lineCov">       4820 :             if (start_of_nosubsts &gt;= 0)</span>
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :                 macro_str1.len = start_of_nosubsts;</span>
<span class="lineNum">    3190 </span>            :             /* given 'a##b', remove nosubsts preceding 'b' */
<span class="lineNum">    3191 </span><span class="lineCov">       4820 :             while ((t1 = *++ptr) == TOK_NOSUBST)</span>
<span class="lineNum">    3192 </span>            :                 ;
<span class="lineNum">    3193 </span><span class="lineCov">       4820 :             if (t1 &amp;&amp; t1 != TOK_PPJOIN) {</span>
<span class="lineNum">    3194 </span><span class="lineCov">       4820 :                 TOK_GET(&amp;t1, &amp;ptr, &amp;cv1);</span>
<span class="lineNum">    3195 </span><span class="lineCov">       4820 :                 if (t != TOK_PLCHLDR || t1 != TOK_PLCHLDR) {</span>
<span class="lineNum">    3196 </span><span class="lineCov">       4820 :                     if (paste_tokens(t, &amp;cval, t1, &amp;cv1)) {</span>
<span class="lineNum">    3197 </span><span class="lineCov">       4820 :                         t = tok, cval = tokc;</span>
<span class="lineNum">    3198 </span>            :                     } else {
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :                         tok_str_add2(&amp;macro_str1, t, &amp;cval);</span>
<span class="lineNum">    3200 </span><span class="lineNoCov">          0 :                         t = t1, cval = cv1;</span>
<span class="lineNum">    3201 </span>            :                     }
<span class="lineNum">    3202 </span>            :                 }
<span class="lineNum">    3203 </span>            :             }
<span class="lineNum">    3204 </span>            :         }
<span class="lineNum">    3205 </span><span class="lineCov">       3330 :         if (t == TOK_NOSUBST) {</span>
<span class="lineNum">    3206 </span><span class="lineNoCov">          0 :             if (start_of_nosubsts &lt; 0)</span>
<span class="lineNum">    3207 </span><span class="lineNoCov">          0 :                 start_of_nosubsts = macro_str1.len;</span>
<span class="lineNum">    3208 </span>            :         } else {
<span class="lineNum">    3209 </span><span class="lineCov">       3330 :             start_of_nosubsts = -1;</span>
<span class="lineNum">    3210 </span>            :         }
<span class="lineNum">    3211 </span><span class="lineCov">       3330 :         tok_str_add2(&amp;macro_str1, t, &amp;cval);</span>
<span class="lineNum">    3212 </span><span class="lineCov">       3330 :     }</span>
<span class="lineNum">    3213 </span><span class="lineCov">       3330 :     tok_str_add(&amp;macro_str1, 0);</span>
<span class="lineNum">    3214 </span>            :     //tok_print(&quot; ###&quot;, macro_str1.str);
<span class="lineNum">    3215 </span><span class="lineCov">       3330 :     return macro_str1.str;</span>
<span class="lineNum">    3216 </span>            : }
<span class="lineNum">    3217 </span>            : 
<a name="3218"><span class="lineNum">    3218 </span>            : /* peek or read [ws_str == NULL] next token from function macro call,</a>
<span class="lineNum">    3219 </span>            :    walking up macro levels up to the file if necessary */
<span class="lineNum">    3220 </span><span class="lineCov">     279556 : static int next_argstream(Sym **nested_list, TokenString *ws_str)</span>
<span class="lineNum">    3221 </span>            : {
<span class="lineNum">    3222 </span>            :     int t;
<span class="lineNum">    3223 </span>            :     const int *p;
<span class="lineNum">    3224 </span>            :     Sym *sa;
<span class="lineNum">    3225 </span>            : 
<span class="lineNum">    3226 </span>            :     for (;;) {
<span class="lineNum">    3227 </span><span class="lineCov">     279556 :         if (macro_ptr) {</span>
<span class="lineNum">    3228 </span><span class="lineCov">      82710 :             p = macro_ptr, t = *p;</span>
<span class="lineNum">    3229 </span><span class="lineCov">      82710 :             if (ws_str) {</span>
<span class="lineNum">    3230 </span><span class="lineCov">      16655 :                 while (is_space(t) || TOK_LINEFEED == t || TOK_PLCHLDR == t)</span>
<span class="lineNum">    3231 </span><span class="lineCov">       1575 :                     tok_str_add(ws_str, t), t = *++p;</span>
<span class="lineNum">    3232 </span>            :             }
<span class="lineNum">    3233 </span><span class="lineCov">      82710 :             if (t == 0) {</span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :                 end_macro();</span>
<span class="lineNum">    3235 </span>            :                 /* also, end of scope for nested defined symbol */
<span class="lineNum">    3236 </span><span class="lineNoCov">          0 :                 sa = *nested_list;</span>
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :                 while (sa &amp;&amp; sa-&gt;v == 0)</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :                     sa = sa-&gt;prev;</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :                 if (sa)</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :                     sa-&gt;v = 0;</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    3242 </span>            :             }
<span class="lineNum">    3243 </span>            :         } else {
<span class="lineNum">    3244 </span><span class="lineCov">     196846 :             ch = handle_eob();</span>
<span class="lineNum">    3245 </span><span class="lineCov">     196846 :             if (ws_str) {</span>
<span class="lineNum">    3246 </span><span class="lineCov">      47294 :                 while (is_space(ch) || ch == '\n' || ch == '/') {</span>
<span class="lineNum">    3247 </span><span class="lineCov">      15498 :                     if (ch == '/') {</span>
<span class="lineNum">    3248 </span>            :                         int c;
<span class="lineNum">    3249 </span><span class="lineNoCov">          0 :                         uint8_t *p = file-&gt;buf_ptr;</span>
<span class="lineNum">    3250 </span><span class="lineNoCov">          0 :                         PEEKC(c, p);</span>
<span class="lineNum">    3251 </span><span class="lineNoCov">          0 :                         if (c == '*') {</span>
<span class="lineNum">    3252 </span><span class="lineNoCov">          0 :                             p = parse_comment(p);</span>
<span class="lineNum">    3253 </span><span class="lineNoCov">          0 :                             file-&gt;buf_ptr = p - 1;</span>
<span class="lineNum">    3254 </span><span class="lineNoCov">          0 :                         } else if (c == '/') {</span>
<span class="lineNum">    3255 </span><span class="lineNoCov">          0 :                             p = parse_line_comment(p);</span>
<span class="lineNum">    3256 </span><span class="lineNoCov">          0 :                             file-&gt;buf_ptr = p - 1;</span>
<span class="lineNum">    3257 </span>            :                         } else
<span class="lineNum">    3258 </span><span class="lineNoCov">          0 :                             break;</span>
<span class="lineNum">    3259 </span><span class="lineNoCov">          0 :                         ch = ' ';</span>
<span class="lineNum">    3260 </span>            :                     }
<span class="lineNum">    3261 </span><span class="lineCov">      15498 :                     if (ch == '\n')</span>
<span class="lineNum">    3262 </span><span class="lineNoCov">          0 :                         file-&gt;line_num++;</span>
<span class="lineNum">    3263 </span><span class="lineCov">      15498 :                     if (!(ch == '\f' || ch == '\v' || ch == '\r'))</span>
<span class="lineNum">    3264 </span><span class="lineCov">      15498 :                         tok_str_add(ws_str, ch);</span>
<span class="lineNum">    3265 </span><span class="lineCov">      15498 :                     cinp();</span>
<span class="lineNum">    3266 </span>            :                 }
<span class="lineNum">    3267 </span>            :             }
<span class="lineNum">    3268 </span><span class="lineCov">     196846 :             t = ch;</span>
<span class="lineNum">    3269 </span>            :         }
<span class="lineNum">    3270 </span>            : 
<span class="lineNum">    3271 </span><span class="lineCov">     279556 :         if (ws_str)</span>
<span class="lineNum">    3272 </span><span class="lineCov">      23438 :             return t;</span>
<span class="lineNum">    3273 </span><span class="lineCov">     256118 :         next_nomacro_spc();</span>
<span class="lineNum">    3274 </span><span class="lineCov">     256118 :         return tok;</span>
<span class="lineNum">    3275 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3276 </span>            : }
<span class="lineNum">    3277 </span>            : 
<span class="lineNum">    3278 </span>            : /* do macro substitution of current token with macro 's' and add
<span class="lineNum">    3279 </span>            :    result to (tok_str,tok_len). 'nested_list' is the list of all
<a name="3280"><span class="lineNum">    3280 </span>            :    macros we got inside to avoid recursing. Return non zero if no</a>
<span class="lineNum">    3281 </span>            :    substitution needs to be done */
<span class="lineNum">    3282 </span><span class="lineCov">     152009 : static int macro_subst_tok(</span>
<span class="lineNum">    3283 </span>            :     TokenString *tok_str,
<span class="lineNum">    3284 </span>            :     Sym **nested_list,
<span class="lineNum">    3285 </span>            :     Sym *s)
<span class="lineNum">    3286 </span>            : {
<span class="lineNum">    3287 </span>            :     Sym *args, *sa, *sa1;
<span class="lineNum">    3288 </span>            :     int parlevel, t, t1, spc;
<span class="lineNum">    3289 </span>            :     TokenString str;
<span class="lineNum">    3290 </span>            :     char *cstrval;
<span class="lineNum">    3291 </span>            :     CValue cval;
<span class="lineNum">    3292 </span>            :     CString cstr;
<span class="lineNum">    3293 </span>            :     char buf[32];
<span class="lineNum">    3294 </span>            : 
<span class="lineNum">    3295 </span>            :     /* if symbol is a macro, prepare substitution */
<span class="lineNum">    3296 </span>            :     /* special macros */
<span class="lineNum">    3297 </span><span class="lineCov">     152009 :     if (tok == TOK___LINE__ || tok == TOK___COUNTER__) {</span>
<span class="lineNum">    3298 </span><span class="lineCov">          3 :         t = tok == TOK___LINE__ ? file-&gt;line_num : pp_counter++;</span>
<span class="lineNum">    3299 </span><span class="lineCov">          3 :         snprintf(buf, sizeof(buf), &quot;%d&quot;, t);</span>
<span class="lineNum">    3300 </span><span class="lineCov">          3 :         cstrval = buf;</span>
<span class="lineNum">    3301 </span><span class="lineCov">          3 :         t1 = TOK_PPNUM;</span>
<span class="lineNum">    3302 </span><span class="lineCov">          3 :         goto add_cstr1;</span>
<span class="lineNum">    3303 </span><span class="lineCov">     152006 :     } else if (tok == TOK___FILE__) {</span>
<span class="lineNum">    3304 </span><span class="lineCov">          6 :         cstrval = file-&gt;filename;</span>
<span class="lineNum">    3305 </span><span class="lineCov">          6 :         goto add_cstr;</span>
<span class="lineNum">    3306 </span><span class="lineCov">     152015 :     } else if (tok == TOK___DATE__ || tok == TOK___TIME__) {</span>
<span class="lineNum">    3307 </span>            :         time_t ti;
<span class="lineNum">    3308 </span>            :         struct tm *tm;
<span class="lineNum">    3309 </span>            : 
<span class="lineNum">    3310 </span><span class="lineCov">          6 :         time(&amp;ti);</span>
<span class="lineNum">    3311 </span><span class="lineCov">          6 :         tm = localtime(&amp;ti);</span>
<span class="lineNum">    3312 </span><span class="lineCov">          6 :         if (tok == TOK___DATE__) {</span>
<span class="lineNum">    3313 </span><span class="lineCov">          6 :             snprintf(buf, sizeof(buf), &quot;%s %2d %d&quot;, </span>
<span class="lineNum">    3314 </span><span class="lineCov">          6 :                      ab_month_name[tm-&gt;tm_mon], tm-&gt;tm_mday, tm-&gt;tm_year + 1900);</span>
<span class="lineNum">    3315 </span>            :         } else {
<span class="lineNum">    3316 </span><span class="lineCov">          3 :             snprintf(buf, sizeof(buf), &quot;%02d:%02d:%02d&quot;, </span>
<span class="lineNum">    3317 </span>            :                      tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec);
<span class="lineNum">    3318 </span>            :         }
<span class="lineNum">    3319 </span><span class="lineCov">          6 :         cstrval = buf;</span>
<span class="lineNum">    3320 </span>            :     add_cstr:
<span class="lineNum">    3321 </span><span class="lineCov">         12 :         t1 = TOK_STR;</span>
<span class="lineNum">    3322 </span>            :     add_cstr1:
<span class="lineNum">    3323 </span><span class="lineCov">         15 :         cstr_new(&amp;cstr);</span>
<span class="lineNum">    3324 </span><span class="lineCov">         15 :         cstr_cat(&amp;cstr, cstrval, 0);</span>
<span class="lineNum">    3325 </span><span class="lineCov">         15 :         cval.str.size = cstr.size;</span>
<span class="lineNum">    3326 </span><span class="lineCov">         15 :         cval.str.data = cstr.data;</span>
<span class="lineNum">    3327 </span><span class="lineCov">         15 :         tok_str_add2(tok_str, t1, &amp;cval);</span>
<span class="lineNum">    3328 </span><span class="lineCov">         15 :         cstr_free(&amp;cstr);</span>
<span class="lineNum">    3329 </span><span class="lineCov">     151994 :     } else if (s-&gt;d) {</span>
<span class="lineNum">    3330 </span><span class="lineCov">     151994 :         int saved_parse_flags = parse_flags;</span>
<span class="lineNum">    3331 </span><span class="lineCov">     151994 :         int *joined_str = NULL;</span>
<span class="lineNum">    3332 </span><span class="lineCov">     151994 :         int *mstr = s-&gt;d;</span>
<span class="lineNum">    3333 </span>            : 
<span class="lineNum">    3334 </span><span class="lineCov">     151994 :         if (s-&gt;type.t == MACRO_FUNC) {</span>
<span class="lineNum">    3335 </span>            :             /* whitespace between macro name and argument list */
<span class="lineNum">    3336 </span>            :             TokenString ws_str;
<span class="lineNum">    3337 </span><span class="lineCov">      23438 :             tok_str_new(&amp;ws_str);</span>
<span class="lineNum">    3338 </span>            : 
<span class="lineNum">    3339 </span><span class="lineCov">      23438 :             spc = 0;</span>
<span class="lineNum">    3340 </span><span class="lineCov">      23438 :             parse_flags |= PARSE_FLAG_SPACES | PARSE_FLAG_LINEFEED</span>
<span class="lineNum">    3341 </span>            :                 | PARSE_FLAG_ACCEPT_STRAYS;
<span class="lineNum">    3342 </span>            : 
<span class="lineNum">    3343 </span>            :             /* get next token from argument stream */
<span class="lineNum">    3344 </span><span class="lineCov">      23438 :             t = next_argstream(nested_list, &amp;ws_str);</span>
<span class="lineNum">    3345 </span><span class="lineCov">      23438 :             if (t != '(') {</span>
<span class="lineNum">    3346 </span>            :                 /* not a macro substitution after all, restore the
<span class="lineNum">    3347 </span>            :                  * macro token plus all whitespace we've read.
<span class="lineNum">    3348 </span>            :                  * whitespace is intentionally not merged to preserve
<span class="lineNum">    3349 </span>            :                  * newlines. */
<span class="lineNum">    3350 </span><span class="lineNoCov">          0 :                 parse_flags = saved_parse_flags;</span>
<span class="lineNum">    3351 </span><span class="lineNoCov">          0 :                 tok_str_add(tok_str, tok);</span>
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :                 if (parse_flags &amp; PARSE_FLAG_SPACES) {</span>
<span class="lineNum">    3353 </span>            :                     int i;
<span class="lineNum">    3354 </span><span class="lineNoCov">          0 :                     for (i = 0; i &lt; ws_str.len; i++)</span>
<span class="lineNum">    3355 </span><span class="lineNoCov">          0 :                         tok_str_add(tok_str, ws_str.str[i]);</span>
<span class="lineNum">    3356 </span>            :                 }
<span class="lineNum">    3357 </span><span class="lineNoCov">          0 :                 tok_str_free_str(ws_str.str);</span>
<span class="lineNum">    3358 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    3359 </span>            :             } else {
<span class="lineNum">    3360 </span><span class="lineCov">      23438 :                 tok_str_free_str(ws_str.str);</span>
<span class="lineNum">    3361 </span>            :             }
<span class="lineNum">    3362 </span>            :             do {
<span class="lineNum">    3363 </span><span class="lineCov">      23438 :                 next_nomacro(); /* eat '(' */</span>
<span class="lineNum">    3364 </span><span class="lineCov">      23438 :             } while (tok == TOK_PLCHLDR);</span>
<span class="lineNum">    3365 </span>            : 
<span class="lineNum">    3366 </span>            :             /* argument macro */
<span class="lineNum">    3367 </span><span class="lineCov">      23438 :             args = NULL;</span>
<span class="lineNum">    3368 </span><span class="lineCov">      23438 :             sa = s-&gt;next;</span>
<span class="lineNum">    3369 </span>            :             /* NOTE: empty args are allowed, except if no args */
<span class="lineNum">    3370 </span>            :             for(;;) {
<span class="lineNum">    3371 </span>            :                 do {
<span class="lineNum">    3372 </span><span class="lineCov">      79523 :                     next_argstream(nested_list, NULL);</span>
<span class="lineNum">    3373 </span><span class="lineCov">      79523 :                 } while (is_space(tok) || TOK_LINEFEED == tok);</span>
<span class="lineNum">    3374 </span>            :     empty_arg:
<span class="lineNum">    3375 </span>            :                 /* handle '()' case */
<span class="lineNum">    3376 </span><span class="lineCov">      51434 :                 if (!args &amp;&amp; !sa &amp;&amp; tok == ')')</span>
<span class="lineNum">    3377 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    3378 </span><span class="lineCov">      51434 :                 if (!sa)</span>
<span class="lineNum">    3379 </span><span class="lineNoCov">          0 :                     tcc_error(&quot;macro '%s' used with too many args&quot;,</span>
<span class="lineNum">    3380 </span>            :                           get_tok_str(s-&gt;v, 0));
<span class="lineNum">    3381 </span><span class="lineCov">      51434 :                 tok_str_new(&amp;str);</span>
<span class="lineNum">    3382 </span><span class="lineCov">      51434 :                 parlevel = spc = 0;</span>
<span class="lineNum">    3383 </span>            :                 /* NOTE: non zero sa-&gt;t indicates VA_ARGS */
<span class="lineNum">    3384 </span><span class="lineCov">     384176 :                 while ((parlevel &gt; 0 || </span>
<span class="lineNum">    3385 </span><span class="lineCov">     185988 :                         (tok != ')' &amp;&amp; </span>
<span class="lineNum">    3386 </span><span class="lineCov">     109271 :                          (tok != ',' || sa-&gt;type.t)))) {</span>
<span class="lineNum">    3387 </span><span class="lineCov">     176595 :                     if (tok == TOK_EOF || tok == 0)</span>
<span class="lineNum">    3388 </span>            :                         break;
<span class="lineNum">    3389 </span><span class="lineCov">     176595 :                     if (tok == '(')</span>
<span class="lineNum">    3390 </span><span class="lineCov">      15587 :                         parlevel++;</span>
<span class="lineNum">    3391 </span><span class="lineCov">     161008 :                     else if (tok == ')')</span>
<span class="lineNum">    3392 </span><span class="lineCov">      15587 :                         parlevel--;</span>
<span class="lineNum">    3393 </span><span class="lineCov">     176595 :                     if (tok == TOK_LINEFEED)</span>
<span class="lineNum">    3394 </span><span class="lineCov">       1980 :                         tok = ' ';</span>
<span class="lineNum">    3395 </span><span class="lineCov">     176595 :                     if (!check_space(tok, &amp;spc))</span>
<span class="lineNum">    3396 </span><span class="lineCov">     165705 :                         tok_str_add2(&amp;str, tok, &amp;tokc);</span>
<span class="lineNum">    3397 </span><span class="lineCov">     176595 :                     next_argstream(nested_list, NULL);</span>
<span class="lineNum">    3398 </span>            :                 }
<span class="lineNum">    3399 </span><span class="lineCov">      51434 :                 if (parlevel)</span>
<span class="lineNum">    3400 </span><span class="lineNoCov">          0 :                     expect(&quot;)&quot;);</span>
<span class="lineNum">    3401 </span><span class="lineCov">      51434 :                 str.len -= spc;</span>
<span class="lineNum">    3402 </span><span class="lineCov">      51434 :                 tok_str_add(&amp;str, -1);</span>
<span class="lineNum">    3403 </span><span class="lineCov">      51434 :                 tok_str_add(&amp;str, 0);</span>
<span class="lineNum">    3404 </span><span class="lineCov">      51434 :                 sa1 = sym_push2(&amp;args, sa-&gt;v &amp; ~SYM_FIELD, sa-&gt;type.t, 0);</span>
<span class="lineNum">    3405 </span><span class="lineCov">      51434 :                 sa1-&gt;d = str.str;</span>
<span class="lineNum">    3406 </span><span class="lineCov">      51434 :                 sa = sa-&gt;next;</span>
<span class="lineNum">    3407 </span><span class="lineCov">      51434 :                 if (tok == ')') {</span>
<span class="lineNum">    3408 </span>            :                     /* special case for gcc var args: add an empty
<span class="lineNum">    3409 </span>            :                        var arg argument if it is omitted */
<span class="lineNum">    3410 </span><span class="lineCov">      23438 :                     if (sa &amp;&amp; sa-&gt;type.t &amp;&amp; gnu_ext)</span>
<span class="lineNum">    3411 </span><span class="lineNoCov">          0 :                         goto empty_arg;</span>
<span class="lineNum">    3412 </span><span class="lineCov">      23438 :                     break;</span>
<span class="lineNum">    3413 </span>            :                 }
<span class="lineNum">    3414 </span><span class="lineCov">      27996 :                 if (tok != ',')</span>
<span class="lineNum">    3415 </span><span class="lineNoCov">          0 :                     expect(&quot;,&quot;);</span>
<span class="lineNum">    3416 </span><span class="lineCov">      27996 :             }</span>
<span class="lineNum">    3417 </span><span class="lineCov">      23438 :             if (sa) {</span>
<span class="lineNum">    3418 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;macro '%s' used with too few args&quot;,</span>
<span class="lineNum">    3419 </span>            :                       get_tok_str(s-&gt;v, 0));
<span class="lineNum">    3420 </span>            :             }
<span class="lineNum">    3421 </span>            : 
<span class="lineNum">    3422 </span><span class="lineCov">      23438 :             parse_flags = saved_parse_flags;</span>
<span class="lineNum">    3423 </span>            : 
<span class="lineNum">    3424 </span>            :             /* now subst each arg */
<span class="lineNum">    3425 </span><span class="lineCov">      23438 :             mstr = macro_arg_subst(nested_list, mstr, args);</span>
<span class="lineNum">    3426 </span>            :             /* free memory */
<span class="lineNum">    3427 </span><span class="lineCov">      23438 :             sa = args;</span>
<span class="lineNum">    3428 </span><span class="lineCov">      98310 :             while (sa) {</span>
<span class="lineNum">    3429 </span><span class="lineCov">      51434 :                 sa1 = sa-&gt;prev;</span>
<span class="lineNum">    3430 </span><span class="lineCov">      51434 :                 tok_str_free_str(sa-&gt;d);</span>
<span class="lineNum">    3431 </span><span class="lineCov">      51434 :                 if (sa-&gt;next) {</span>
<span class="lineNum">    3432 </span><span class="lineCov">      21702 :                     tok_str_free_str(sa-&gt;next-&gt;d);</span>
<span class="lineNum">    3433 </span><span class="lineCov">      21702 :                     sym_free(sa-&gt;next);</span>
<span class="lineNum">    3434 </span>            :                 }
<span class="lineNum">    3435 </span><span class="lineCov">      51434 :                 sym_free(sa);</span>
<span class="lineNum">    3436 </span><span class="lineCov">      51434 :                 sa = sa1;</span>
<span class="lineNum">    3437 </span>            :             }
<span class="lineNum">    3438 </span>            :         }
<span class="lineNum">    3439 </span>            : 
<span class="lineNum">    3440 </span><span class="lineCov">     151994 :         sym_push2(nested_list, s-&gt;v, 0, 0);</span>
<span class="lineNum">    3441 </span><span class="lineCov">     151994 :         parse_flags = saved_parse_flags;</span>
<span class="lineNum">    3442 </span><span class="lineCov">     151994 :         joined_str = macro_twosharps(mstr);</span>
<span class="lineNum">    3443 </span><span class="lineCov">     151994 :         macro_subst(tok_str, nested_list, joined_str ? joined_str : mstr);</span>
<span class="lineNum">    3444 </span>            : 
<span class="lineNum">    3445 </span>            :         /* pop nested defined symbol */
<span class="lineNum">    3446 </span><span class="lineCov">     151994 :         sa1 = *nested_list;</span>
<span class="lineNum">    3447 </span><span class="lineCov">     151994 :         *nested_list = sa1-&gt;prev;</span>
<span class="lineNum">    3448 </span><span class="lineCov">     151994 :         sym_free(sa1);</span>
<span class="lineNum">    3449 </span><span class="lineCov">     151994 :         if (joined_str)</span>
<span class="lineNum">    3450 </span><span class="lineCov">       3330 :             tok_str_free_str(joined_str);</span>
<span class="lineNum">    3451 </span><span class="lineCov">     151994 :         if (mstr != s-&gt;d)</span>
<span class="lineNum">    3452 </span><span class="lineCov">      23438 :             tok_str_free_str(mstr);</span>
<span class="lineNum">    3453 </span>            :     }
<span class="lineNum">    3454 </span><span class="lineCov">     152009 :     return 0;</span>
<span class="lineNum">    3455 </span>            : }
<span class="lineNum">    3456 </span>            : 
<span class="lineNum">    3457 </span>            : /* do macro substitution of macro_str and add result to
<a name="3458"><span class="lineNum">    3458 </span>            :    (tok_str,tok_len). 'nested_list' is the list of all macros we got</a>
<span class="lineNum">    3459 </span>            :    inside to avoid recursing. */
<span class="lineNum">    3460 </span><span class="lineCov">     173696 : static void macro_subst(</span>
<span class="lineNum">    3461 </span>            :     TokenString *tok_str,
<span class="lineNum">    3462 </span>            :     Sym **nested_list,
<span class="lineNum">    3463 </span>            :     const int *macro_str
<span class="lineNum">    3464 </span>            :     )
<span class="lineNum">    3465 </span>            : {
<span class="lineNum">    3466 </span>            :     Sym *s;
<span class="lineNum">    3467 </span>            :     int t, spc, nosubst;
<span class="lineNum">    3468 </span>            :     CValue cval;
<span class="lineNum">    3469 </span>            :     
<span class="lineNum">    3470 </span><span class="lineCov">     173696 :     spc = nosubst = 0;</span>
<span class="lineNum">    3471 </span>            : 
<span class="lineNum">    3472 </span>            :     while (1) {
<span class="lineNum">    3473 </span><span class="lineCov">     465533 :         TOK_GET(&amp;t, &amp;macro_str, &amp;cval);</span>
<span class="lineNum">    3474 </span><span class="lineCov">     465533 :         if (t &lt;= 0)</span>
<span class="lineNum">    3475 </span><span class="lineCov">     173696 :             break;</span>
<span class="lineNum">    3476 </span>            : 
<span class="lineNum">    3477 </span><span class="lineCov">     291837 :         if (t &gt;= TOK_IDENT &amp;&amp; 0 == nosubst) {</span>
<span class="lineNum">    3478 </span><span class="lineCov">     146651 :             s = define_find(t);</span>
<span class="lineNum">    3479 </span><span class="lineCov">     146651 :             if (s == NULL)</span>
<span class="lineNum">    3480 </span><span class="lineCov">     113004 :                 goto no_subst;</span>
<span class="lineNum">    3481 </span>            : 
<span class="lineNum">    3482 </span>            :             /* if nested substitution, do nothing */
<span class="lineNum">    3483 </span><span class="lineCov">      33647 :             if (sym_find2(*nested_list, t)) {</span>
<span class="lineNum">    3484 </span>            :                 /* and mark it as TOK_NOSUBST, so it doesn't get subst'd again */
<span class="lineNum">    3485 </span><span class="lineCov">          3 :                 tok_str_add2(tok_str, TOK_NOSUBST, NULL);</span>
<span class="lineNum">    3486 </span><span class="lineCov">          3 :                 goto no_subst;</span>
<span class="lineNum">    3487 </span>            :             }
<span class="lineNum">    3488 </span>            : 
<span class="lineNum">    3489 </span>            :             {
<span class="lineNum">    3490 </span>            :                 TokenString str;
<span class="lineNum">    3491 </span><span class="lineCov">      33644 :                 str.str = (int*)macro_str;</span>
<span class="lineNum">    3492 </span><span class="lineCov">      33644 :                 begin_macro(&amp;str, 2);</span>
<span class="lineNum">    3493 </span>            : 
<span class="lineNum">    3494 </span><span class="lineCov">      33644 :                 tok = t;</span>
<span class="lineNum">    3495 </span><span class="lineCov">      33644 :                 macro_subst_tok(tok_str, nested_list, s);</span>
<span class="lineNum">    3496 </span>            : 
<span class="lineNum">    3497 </span><span class="lineCov">      33644 :                 if (str.alloc == 3) {</span>
<span class="lineNum">    3498 </span>            :                     /* already finished by reading function macro arguments */
<span class="lineNum">    3499 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    3500 </span>            :                 }
<span class="lineNum">    3501 </span>            : 
<span class="lineNum">    3502 </span><span class="lineCov">      33644 :                 macro_str = macro_ptr;</span>
<span class="lineNum">    3503 </span><span class="lineCov">      33644 :                 end_macro ();</span>
<span class="lineNum">    3504 </span>            :             }
<span class="lineNum">    3505 </span><span class="lineCov">      67288 :             if (tok_str-&gt;len)</span>
<span class="lineNum">    3506 </span><span class="lineCov">      33299 :                 spc = is_space(t = tok_str-&gt;str[tok_str-&gt;lastlen]);</span>
<span class="lineNum">    3507 </span>            :         } else {
<span class="lineNum">    3508 </span><span class="lineCov">     145186 :             if (t == '\\' &amp;&amp; !(parse_flags &amp; PARSE_FLAG_ACCEPT_STRAYS))</span>
<span class="lineNum">    3509 </span><span class="lineNoCov">          0 :                 tcc_error(&quot;stray '\\' in program&quot;);</span>
<span class="lineNum">    3510 </span>            : no_subst:
<span class="lineNum">    3511 </span><span class="lineCov">     258193 :             if (!check_space(t, &amp;spc))</span>
<span class="lineNum">    3512 </span><span class="lineCov">     257863 :                 tok_str_add2(tok_str, t, &amp;cval);</span>
<span class="lineNum">    3513 </span>            : 
<span class="lineNum">    3514 </span><span class="lineCov">     258193 :             if (nosubst) {</span>
<span class="lineNum">    3515 </span><span class="lineCov">          3 :                 if (nosubst &gt; 1 &amp;&amp; (spc || (++nosubst == 3 &amp;&amp; t == '(')))</span>
<span class="lineNum">    3516 </span><span class="lineNoCov">          0 :                     continue;</span>
<span class="lineNum">    3517 </span><span class="lineCov">          3 :                 nosubst = 0;</span>
<span class="lineNum">    3518 </span>            :             }
<span class="lineNum">    3519 </span><span class="lineCov">     258193 :             if (t == TOK_NOSUBST)</span>
<span class="lineNum">    3520 </span><span class="lineCov">          3 :                 nosubst = 1;</span>
<span class="lineNum">    3521 </span>            :         }
<span class="lineNum">    3522 </span>            :         /* GCC supports 'defined' as result of a macro substitution */
<span class="lineNum">    3523 </span><span class="lineCov">     291837 :         if (t == TOK_DEFINED &amp;&amp; pp_expr)</span>
<span class="lineNum">    3524 </span><span class="lineNoCov">          0 :             nosubst = 2;</span>
<span class="lineNum">    3525 </span><span class="lineCov">     291837 :     }</span>
<span class="lineNum">    3526 </span><span class="lineCov">     173696 : }</span>
<a name="3527"><span class="lineNum">    3527 </span>            : </a>
<span class="lineNum">    3528 </span>            : /* return next token with macro substitution */
<span class="lineNum">    3529 </span><span class="lineCov">    1475732 : ST_FUNC void next(void)</span>
<span class="lineNum">    3530 </span>            : {
<span class="lineNum">    3531 </span>            :  redo:
<span class="lineNum">    3532 </span><span class="lineCov">    1475732 :     if (parse_flags &amp; PARSE_FLAG_SPACES)</span>
<span class="lineNum">    3533 </span><span class="lineNoCov">          0 :         next_nomacro_spc();</span>
<span class="lineNum">    3534 </span>            :     else
<span class="lineNum">    3535 </span><span class="lineCov">    1475732 :         next_nomacro();</span>
<span class="lineNum">    3536 </span>            : 
<span class="lineNum">    3537 </span><span class="lineCov">    1474863 :     if (macro_ptr) {</span>
<span class="lineNum">    3538 </span><span class="lineCov">     467324 :         if (tok == TOK_NOSUBST || tok == TOK_PLCHLDR) {</span>
<span class="lineNum">    3539 </span>            :         /* discard preprocessor markers */
<span class="lineNum">    3540 </span>            :             goto redo;
<span class="lineNum">    3541 </span><span class="lineCov">     467321 :         } else if (tok == 0) {</span>
<span class="lineNum">    3542 </span>            :             /* end of macro or unget token string */
<span class="lineNum">    3543 </span><span class="lineCov">     122507 :             end_macro();</span>
<span class="lineNum">    3544 </span><span class="lineCov">     122507 :             goto redo;</span>
<span class="lineNum">    3545 </span>            :         }
<span class="lineNum">    3546 </span><span class="lineCov">    1007539 :     } else if (tok &gt;= TOK_IDENT &amp;&amp; (parse_flags &amp; PARSE_FLAG_PREPROCESS)) {</span>
<span class="lineNum">    3547 </span>            :         Sym *s;
<span class="lineNum">    3548 </span>            :         /* if reading from file, try to substitute macros */
<span class="lineNum">    3549 </span><span class="lineCov">     562141 :         s = define_find(tok);</span>
<span class="lineNum">    3550 </span><span class="lineCov">     562141 :         if (s) {</span>
<span class="lineNum">    3551 </span><span class="lineCov">     118365 :             Sym *nested_list = NULL;</span>
<span class="lineNum">    3552 </span><span class="lineCov">     118365 :             tokstr_buf.len = 0;</span>
<span class="lineNum">    3553 </span><span class="lineCov">     118365 :             macro_subst_tok(&amp;tokstr_buf, &amp;nested_list, s);</span>
<span class="lineNum">    3554 </span><span class="lineCov">     118365 :             tok_str_add(&amp;tokstr_buf, 0);</span>
<span class="lineNum">    3555 </span><span class="lineCov">     118365 :             begin_macro(&amp;tokstr_buf, 2);</span>
<span class="lineNum">    3556 </span><span class="lineCov">     118365 :             goto redo;</span>
<span class="lineNum">    3557 </span>            :         }
<span class="lineNum">    3558 </span>            :     }
<span class="lineNum">    3559 </span>            :     /* convert preprocessor tokens into C tokens */
<span class="lineNum">    3560 </span><span class="lineCov">    1233988 :     if (tok == TOK_PPNUM) {</span>
<span class="lineNum">    3561 </span><span class="lineCov">      31300 :         if  (parse_flags &amp; PARSE_FLAG_TOK_NUM)</span>
<span class="lineNum">    3562 </span><span class="lineCov">      31300 :             parse_number((char *)tokc.str.data);</span>
<span class="lineNum">    3563 </span><span class="lineCov">    1202688 :     } else if (tok == TOK_PPSTR) {</span>
<span class="lineNum">    3564 </span><span class="lineCov">       3327 :         if (parse_flags &amp; PARSE_FLAG_TOK_STR)</span>
<span class="lineNum">    3565 </span><span class="lineCov">       3327 :             parse_string((char *)tokc.str.data, tokc.str.size - 1);</span>
<span class="lineNum">    3566 </span>            :     }
<span class="lineNum">    3567 </span><span class="lineCov">    1233988 : }</span>
<span class="lineNum">    3568 </span>            : 
<a name="3569"><span class="lineNum">    3569 </span>            : /* push back current token and set current token to 'last_tok'. Only</a>
<span class="lineNum">    3570 </span>            :    identifier case handled for labels. */
<span class="lineNum">    3571 </span><span class="lineCov">       4147 : ST_INLN void unget_tok(int last_tok)</span>
<span class="lineNum">    3572 </span>            : {
<span class="lineNum">    3573 </span>            : 
<span class="lineNum">    3574 </span><span class="lineCov">       4147 :     TokenString *str = tok_str_alloc();</span>
<span class="lineNum">    3575 </span><span class="lineCov">       4147 :     tok_str_add2(str, tok, &amp;tokc);</span>
<span class="lineNum">    3576 </span><span class="lineCov">       4147 :     tok_str_add(str, 0);</span>
<span class="lineNum">    3577 </span><span class="lineCov">       4147 :     begin_macro(str, 1);</span>
<span class="lineNum">    3578 </span><span class="lineCov">       4147 :     tok = last_tok;</span>
<a name="3579"><span class="lineNum">    3579 </span><span class="lineCov">       4147 : }</span></a>
<span class="lineNum">    3580 </span>            : 
<span class="lineNum">    3581 </span><span class="lineCov">       1672 : ST_FUNC void preprocess_start(TCCState *s1, int is_asm)</span>
<span class="lineNum">    3582 </span>            : {
<span class="lineNum">    3583 </span>            :     CString cstr;
<span class="lineNum">    3584 </span>            :     int i;
<span class="lineNum">    3585 </span>            : 
<span class="lineNum">    3586 </span><span class="lineCov">       1672 :     s1-&gt;include_stack_ptr = s1-&gt;include_stack;</span>
<span class="lineNum">    3587 </span><span class="lineCov">       1672 :     s1-&gt;ifdef_stack_ptr = s1-&gt;ifdef_stack;</span>
<span class="lineNum">    3588 </span><span class="lineCov">       1672 :     file-&gt;ifdef_stack_ptr = s1-&gt;ifdef_stack_ptr;</span>
<span class="lineNum">    3589 </span><span class="lineCov">       1672 :     pp_expr = 0;</span>
<span class="lineNum">    3590 </span><span class="lineCov">       1672 :     pp_counter = 0;</span>
<span class="lineNum">    3591 </span><span class="lineCov">       1672 :     pp_debug_tok = pp_debug_symv = 0;</span>
<span class="lineNum">    3592 </span><span class="lineCov">       1672 :     pp_once++;</span>
<span class="lineNum">    3593 </span><span class="lineCov">       1672 :     pvtop = vtop = vstack - 1;</span>
<span class="lineNum">    3594 </span><span class="lineCov">       1672 :     s1-&gt;pack_stack[0] = 0;</span>
<span class="lineNum">    3595 </span><span class="lineCov">       1672 :     s1-&gt;pack_stack_ptr = s1-&gt;pack_stack;</span>
<span class="lineNum">    3596 </span>            : 
<span class="lineNum">    3597 </span><span class="lineCov">       1672 :     set_idnum('$', s1-&gt;dollars_in_identifiers ? IS_ID : 0);</span>
<span class="lineNum">    3598 </span><span class="lineCov">       1672 :     set_idnum('.', is_asm ? IS_ID : 0);</span>
<span class="lineNum">    3599 </span>            : 
<span class="lineNum">    3600 </span><span class="lineCov">       1672 :     cstr_new(&amp;cstr);</span>
<span class="lineNum">    3601 </span><span class="lineCov">       1672 :     cstr_cat(&amp;cstr, &quot;\&quot;&quot;, -1);</span>
<span class="lineNum">    3602 </span><span class="lineCov">       1672 :     cstr_cat(&amp;cstr, file-&gt;filename, -1);</span>
<span class="lineNum">    3603 </span><span class="lineCov">       1672 :     cstr_cat(&amp;cstr, &quot;\&quot;&quot;, 0);</span>
<span class="lineNum">    3604 </span><span class="lineCov">       1672 :     tcc_define_symbol(s1, &quot;__BASE_FILE__&quot;, cstr.data);</span>
<span class="lineNum">    3605 </span>            : 
<span class="lineNum">    3606 </span><span class="lineCov">       1672 :     cstr_reset(&amp;cstr);</span>
<span class="lineNum">    3607 </span><span class="lineCov">       1672 :     for (i = 0; i &lt; s1-&gt;nb_cmd_include_files; i++) {</span>
<span class="lineNum">    3608 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr, &quot;#include \&quot;&quot;, -1);</span>
<span class="lineNum">    3609 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr, s1-&gt;cmd_include_files[i], -1);</span>
<span class="lineNum">    3610 </span><span class="lineNoCov">          0 :         cstr_cat(&amp;cstr, &quot;\&quot;\n&quot;, -1);</span>
<span class="lineNum">    3611 </span>            :     }
<span class="lineNum">    3612 </span><span class="lineCov">       1672 :     if (cstr.size) {</span>
<span class="lineNum">    3613 </span><span class="lineNoCov">          0 :         *s1-&gt;include_stack_ptr++ = file;</span>
<span class="lineNum">    3614 </span><span class="lineNoCov">          0 :         tcc_open_bf(s1, &quot;&lt;command line&gt;&quot;, cstr.size);</span>
<span class="lineNum">    3615 </span><span class="lineNoCov">          0 :         memcpy(file-&gt;buffer, cstr.data, cstr.size);</span>
<span class="lineNum">    3616 </span>            :     }
<span class="lineNum">    3617 </span><span class="lineCov">       1672 :     cstr_free(&amp;cstr);</span>
<span class="lineNum">    3618 </span>            : 
<span class="lineNum">    3619 </span><span class="lineCov">       1672 :     if (is_asm)</span>
<span class="lineNum">    3620 </span><span class="lineNoCov">          0 :         tcc_define_symbol(s1, &quot;__ASSEMBLER__&quot;, NULL);</span>
<span class="lineNum">    3621 </span>            : 
<span class="lineNum">    3622 </span><span class="lineCov">       1672 :     parse_flags = is_asm ? PARSE_FLAG_ASM_FILE : 0;</span>
<span class="lineNum">    3623 </span><span class="lineCov">       1672 :     tok_flags = TOK_FLAG_BOL | TOK_FLAG_BOF;</span>
<span class="lineNum">    3624 </span><span class="lineCov">       1672 : }</span>
<a name="3625"><span class="lineNum">    3625 </span>            : </a>
<span class="lineNum">    3626 </span>            : /* cleanup from error/setjmp */
<span class="lineNum">    3627 </span><span class="lineCov">       1672 : ST_FUNC void preprocess_end(TCCState *s1)</span>
<span class="lineNum">    3628 </span>            : {
<span class="lineNum">    3629 </span><span class="lineCov">       3349 :     while (macro_stack)</span>
<span class="lineNum">    3630 </span><span class="lineCov">          5 :         end_macro();</span>
<span class="lineNum">    3631 </span><span class="lineCov">       1672 :     macro_ptr = NULL;</span>
<a name="3632"><span class="lineNum">    3632 </span><span class="lineCov">       1672 : }</span></a>
<span class="lineNum">    3633 </span>            : 
<span class="lineNum">    3634 </span><span class="lineCov">       1672 : ST_FUNC void tccpp_new(TCCState *s)</span>
<span class="lineNum">    3635 </span>            : {
<span class="lineNum">    3636 </span>            :     int i, c;
<span class="lineNum">    3637 </span>            :     const char *p, *r;
<span class="lineNum">    3638 </span>            : 
<span class="lineNum">    3639 </span>            :     /* might be used in error() before preprocess_start() */
<span class="lineNum">    3640 </span><span class="lineCov">       1672 :     s-&gt;include_stack_ptr = s-&gt;include_stack;</span>
<span class="lineNum">    3641 </span><span class="lineCov">       1672 :     s-&gt;ppfp = stdout;</span>
<span class="lineNum">    3642 </span>            : 
<span class="lineNum">    3643 </span>            :     /* init isid table */
<span class="lineNum">    3644 </span><span class="lineCov">     217360 :     for(i = CH_EOF; i&lt;128; i++)</span>
<span class="lineNum">    3645 </span><span class="lineCov">     423016 :         set_idnum(i,</span>
<span class="lineNum">    3646 </span><span class="lineCov">     215688 :             is_space(i) ? IS_SPC</span>
<span class="lineNum">    3647 </span><span class="lineCov">     207328 :             : isid(i) ? IS_ID</span>
<span class="lineNum">    3648 </span><span class="lineCov">     326040 :             : isnum(i) ? IS_NUM</span>
<span class="lineNum">    3649 </span><span class="lineCov">     118712 :             : 0);</span>
<span class="lineNum">    3650 </span>            : 
<span class="lineNum">    3651 </span><span class="lineCov">     215688 :     for(i = 128; i&lt;256; i++)</span>
<span class="lineNum">    3652 </span><span class="lineCov">     214016 :         set_idnum(i, IS_ID);</span>
<span class="lineNum">    3653 </span>            : 
<span class="lineNum">    3654 </span>            :     /* init allocators */
<span class="lineNum">    3655 </span><span class="lineCov">       1672 :     tal_new(&amp;toksym_alloc, TOKSYM_TAL_LIMIT, TOKSYM_TAL_SIZE);</span>
<span class="lineNum">    3656 </span><span class="lineCov">       1672 :     tal_new(&amp;tokstr_alloc, TOKSTR_TAL_LIMIT, TOKSTR_TAL_SIZE);</span>
<span class="lineNum">    3657 </span><span class="lineCov">       1672 :     tal_new(&amp;cstr_alloc, CSTR_TAL_LIMIT, CSTR_TAL_SIZE);</span>
<span class="lineNum">    3658 </span>            : 
<span class="lineNum">    3659 </span><span class="lineCov">       1672 :     memset(hash_ident, 0, TOK_HASH_SIZE * sizeof(TokenSym *));</span>
<span class="lineNum">    3660 </span><span class="lineCov">       1672 :     cstr_new(&amp;cstr_buf);</span>
<span class="lineNum">    3661 </span><span class="lineCov">       1672 :     cstr_realloc(&amp;cstr_buf, STRING_MAX_SIZE);</span>
<span class="lineNum">    3662 </span><span class="lineCov">       1672 :     tok_str_new(&amp;tokstr_buf);</span>
<span class="lineNum">    3663 </span><span class="lineCov">       1672 :     tok_str_realloc(&amp;tokstr_buf, TOKSTR_MAX_SIZE);</span>
<span class="lineNum">    3664 </span>            :     
<span class="lineNum">    3665 </span><span class="lineCov">       1672 :     tok_ident = TOK_IDENT;</span>
<span class="lineNum">    3666 </span><span class="lineCov">       1672 :     p = tcc_keywords;</span>
<span class="lineNum">    3667 </span><span class="lineCov">    1658624 :     while (*p) {</span>
<span class="lineNum">    3668 </span><span class="lineCov">    1655280 :         r = p;</span>
<span class="lineNum">    3669 </span>            :         for(;;) {
<span class="lineNum">    3670 </span><span class="lineCov">   10465048 :             c = *r++;</span>
<span class="lineNum">    3671 </span><span class="lineCov">   10465048 :             if (c == '\0')</span>
<span class="lineNum">    3672 </span><span class="lineCov">    1655280 :                 break;</span>
<span class="lineNum">    3673 </span><span class="lineCov">    8809768 :         }</span>
<span class="lineNum">    3674 </span><span class="lineCov">    1655280 :         tok_alloc(p, r - p - 1);</span>
<span class="lineNum">    3675 </span><span class="lineCov">    1655280 :         p = r;</span>
<span class="lineNum">    3676 </span>            :     }
<a name="3677"><span class="lineNum">    3677 </span><span class="lineCov">       1672 : }</span></a>
<span class="lineNum">    3678 </span>            : 
<span class="lineNum">    3679 </span><span class="lineCov">       1672 : ST_FUNC void tccpp_delete(TCCState *s)</span>
<span class="lineNum">    3680 </span>            : {
<span class="lineNum">    3681 </span>            :     int i, n;
<span class="lineNum">    3682 </span>            : 
<span class="lineNum">    3683 </span>            :     /* free -D and compiler defines */
<span class="lineNum">    3684 </span><span class="lineCov">       1672 :     free_defines(NULL);</span>
<span class="lineNum">    3685 </span>            : 
<span class="lineNum">    3686 </span>            :     /* free tokens */
<span class="lineNum">    3687 </span><span class="lineCov">       1672 :     n = tok_ident - TOK_IDENT;</span>
<span class="lineNum">    3688 </span><span class="lineCov">    1919184 :     for(i = 0; i &lt; n; i++)</span>
<span class="lineNum">    3689 </span><span class="lineCov">    1917512 :         tal_free(toksym_alloc, table_ident[i]);</span>
<span class="lineNum">    3690 </span><span class="lineCov">       1672 :     tcc_free(table_ident);</span>
<span class="lineNum">    3691 </span><span class="lineCov">       1672 :     table_ident = NULL;</span>
<span class="lineNum">    3692 </span>            : 
<span class="lineNum">    3693 </span>            :     /* free static buffers */
<span class="lineNum">    3694 </span><span class="lineCov">       1672 :     cstr_free(&amp;tokcstr);</span>
<span class="lineNum">    3695 </span><span class="lineCov">       1672 :     cstr_free(&amp;cstr_buf);</span>
<span class="lineNum">    3696 </span><span class="lineCov">       1672 :     cstr_free(&amp;macro_equal_buf);</span>
<span class="lineNum">    3697 </span><span class="lineCov">       1672 :     tok_str_free_str(tokstr_buf.str);</span>
<span class="lineNum">    3698 </span>            : 
<span class="lineNum">    3699 </span>            :     /* free allocators */
<span class="lineNum">    3700 </span><span class="lineCov">       1672 :     tal_delete(toksym_alloc);</span>
<span class="lineNum">    3701 </span><span class="lineCov">       1672 :     toksym_alloc = NULL;</span>
<span class="lineNum">    3702 </span><span class="lineCov">       1672 :     tal_delete(tokstr_alloc);</span>
<span class="lineNum">    3703 </span><span class="lineCov">       1672 :     tokstr_alloc = NULL;</span>
<span class="lineNum">    3704 </span><span class="lineCov">       1672 :     tal_delete(cstr_alloc);</span>
<span class="lineNum">    3705 </span><span class="lineCov">       1672 :     cstr_alloc = NULL;</span>
<span class="lineNum">    3706 </span><span class="lineCov">       1672 : }</span>
<span class="lineNum">    3707 </span>            : 
<span class="lineNum">    3708 </span>            : /* ------------------------------------------------------------------------- */
<a name="3709"><span class="lineNum">    3709 </span>            : /* tcc -E [-P[1]] [-dD} support */</a>
<span class="lineNum">    3710 </span>            : 
<span class="lineNum">    3711 </span><span class="lineNoCov">          0 : static void tok_print(const char *msg, const int *str)</span>
<span class="lineNum">    3712 </span>            : {
<span class="lineNum">    3713 </span>            :     FILE *fp;
<span class="lineNum">    3714 </span><span class="lineNoCov">          0 :     int t, s = 0;</span>
<span class="lineNum">    3715 </span>            :     CValue cval;
<span class="lineNum">    3716 </span>            : 
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 :     fp = tcc_state-&gt;ppfp;</span>
<span class="lineNum">    3718 </span><span class="lineNoCov">          0 :     fprintf(fp, &quot;%s&quot;, msg);</span>
<span class="lineNum">    3719 </span><span class="lineNoCov">          0 :     while (str) {</span>
<span class="lineNum">    3720 </span><span class="lineNoCov">          0 :         TOK_GET(&amp;t, &amp;str, &amp;cval);</span>
<span class="lineNum">    3721 </span><span class="lineNoCov">          0 :         if (!t)</span>
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    3723 </span><span class="lineNoCov">          0 :         fprintf(fp, &quot; %s&quot; + s, get_tok_str(t, &amp;cval)), s = 1;</span>
<span class="lineNum">    3724 </span>            :     }
<span class="lineNum">    3725 </span><span class="lineNoCov">          0 :     fprintf(fp, &quot;\n&quot;);</span>
<a name="3726"><span class="lineNum">    3726 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    3727 </span>            : 
<span class="lineNum">    3728 </span><span class="lineNoCov">          0 : static void pp_line(TCCState *s1, BufferedFile *f, int level)</span>
<span class="lineNum">    3729 </span>            : {
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :     int d = f-&gt;line_num - f-&gt;line_ref;</span>
<span class="lineNum">    3731 </span>            : 
<span class="lineNum">    3732 </span><span class="lineNoCov">          0 :     if (s1-&gt;dflag &amp; 4)</span>
<span class="lineNum">    3733 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3734 </span>            : 
<span class="lineNum">    3735 </span><span class="lineNoCov">          0 :     if (s1-&gt;Pflag == LINE_MACRO_OUTPUT_FORMAT_NONE) {</span>
<span class="lineNum">    3736 </span>            :         ;
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :     } else if (level == 0 &amp;&amp; f-&gt;line_ref &amp;&amp; d &lt; 8) {</span>
<span class="lineNum">    3738 </span><span class="lineNoCov">          0 :         while (d &gt; 0)</span>
<span class="lineNum">    3739 </span><span class="lineNoCov">          0 :             fputs(&quot;\n&quot;, s1-&gt;ppfp), --d;</span>
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :     } else if (s1-&gt;Pflag == LINE_MACRO_OUTPUT_FORMAT_STD) {</span>
<span class="lineNum">    3741 </span><span class="lineNoCov">          0 :         fprintf(s1-&gt;ppfp, &quot;#line %d \&quot;%s\&quot;\n&quot;, f-&gt;line_num, f-&gt;filename);</span>
<span class="lineNum">    3742 </span>            :     } else {
<span class="lineNum">    3743 </span><span class="lineNoCov">          0 :         fprintf(s1-&gt;ppfp, &quot;# %d \&quot;%s\&quot;%s\n&quot;, f-&gt;line_num, f-&gt;filename,</span>
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 :             level &gt; 0 ? &quot; 1&quot; : level &lt; 0 ? &quot; 2&quot; : &quot;&quot;);</span>
<span class="lineNum">    3745 </span>            :     }
<span class="lineNum">    3746 </span><span class="lineNoCov">          0 :     f-&gt;line_ref = f-&gt;line_num;</span>
<a name="3747"><span class="lineNum">    3747 </span>            : }</a>
<span class="lineNum">    3748 </span>            : 
<span class="lineNum">    3749 </span><span class="lineNoCov">          0 : static void define_print(TCCState *s1, int v)</span>
<span class="lineNum">    3750 </span>            : {
<span class="lineNum">    3751 </span>            :     FILE *fp;
<span class="lineNum">    3752 </span>            :     Sym *s;
<span class="lineNum">    3753 </span>            : 
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 :     s = define_find(v);</span>
<span class="lineNum">    3755 </span><span class="lineNoCov">          0 :     if (NULL == s || NULL == s-&gt;d)</span>
<span class="lineNum">    3756 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3757 </span>            : 
<span class="lineNum">    3758 </span><span class="lineNoCov">          0 :     fp = s1-&gt;ppfp;</span>
<span class="lineNum">    3759 </span><span class="lineNoCov">          0 :     fprintf(fp, &quot;#define %s&quot;, get_tok_str(v, NULL));</span>
<span class="lineNum">    3760 </span><span class="lineNoCov">          0 :     if (s-&gt;type.t == MACRO_FUNC) {</span>
<span class="lineNum">    3761 </span><span class="lineNoCov">          0 :         Sym *a = s-&gt;next;</span>
<span class="lineNum">    3762 </span><span class="lineNoCov">          0 :         fprintf(fp,&quot;(&quot;);</span>
<span class="lineNum">    3763 </span><span class="lineNoCov">          0 :         if (a)</span>
<span class="lineNum">    3764 </span>            :             for (;;) {
<span class="lineNum">    3765 </span><span class="lineNoCov">          0 :                 fprintf(fp,&quot;%s&quot;, get_tok_str(a-&gt;v &amp; ~SYM_FIELD, NULL));</span>
<span class="lineNum">    3766 </span><span class="lineNoCov">          0 :                 if (!(a = a-&gt;next))</span>
<span class="lineNum">    3767 </span><span class="lineNoCov">          0 :                     break;</span>
<span class="lineNum">    3768 </span><span class="lineNoCov">          0 :                 fprintf(fp,&quot;,&quot;);</span>
<span class="lineNum">    3769 </span><span class="lineNoCov">          0 :             }</span>
<span class="lineNum">    3770 </span><span class="lineNoCov">          0 :         fprintf(fp,&quot;)&quot;);</span>
<span class="lineNum">    3771 </span>            :     }
<span class="lineNum">    3772 </span><span class="lineNoCov">          0 :     tok_print(&quot;&quot;, s-&gt;d);</span>
<a name="3773"><span class="lineNum">    3773 </span>            : }</a>
<span class="lineNum">    3774 </span>            : 
<span class="lineNum">    3775 </span><span class="lineNoCov">          0 : static void pp_debug_defines(TCCState *s1)</span>
<span class="lineNum">    3776 </span>            : {
<span class="lineNum">    3777 </span>            :     int v, t;
<span class="lineNum">    3778 </span>            :     const char *vs;
<span class="lineNum">    3779 </span>            :     FILE *fp;
<span class="lineNum">    3780 </span>            : 
<span class="lineNum">    3781 </span><span class="lineNoCov">          0 :     t = pp_debug_tok;</span>
<span class="lineNum">    3782 </span><span class="lineNoCov">          0 :     if (t == 0)</span>
<span class="lineNum">    3783 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    3784 </span>            : 
<span class="lineNum">    3785 </span><span class="lineNoCov">          0 :     file-&gt;line_num--;</span>
<span class="lineNum">    3786 </span><span class="lineNoCov">          0 :     pp_line(s1, file, 0);</span>
<span class="lineNum">    3787 </span><span class="lineNoCov">          0 :     file-&gt;line_ref = ++file-&gt;line_num;</span>
<span class="lineNum">    3788 </span>            : 
<span class="lineNum">    3789 </span><span class="lineNoCov">          0 :     fp = s1-&gt;ppfp;</span>
<span class="lineNum">    3790 </span><span class="lineNoCov">          0 :     v = pp_debug_symv;</span>
<span class="lineNum">    3791 </span><span class="lineNoCov">          0 :     vs = get_tok_str(v, NULL);</span>
<span class="lineNum">    3792 </span><span class="lineNoCov">          0 :     if (t == TOK_DEFINE) {</span>
<span class="lineNum">    3793 </span><span class="lineNoCov">          0 :         define_print(s1, v);</span>
<span class="lineNum">    3794 </span><span class="lineNoCov">          0 :     } else if (t == TOK_UNDEF) {</span>
<span class="lineNum">    3795 </span><span class="lineNoCov">          0 :         fprintf(fp, &quot;#undef %s\n&quot;, vs);</span>
<span class="lineNum">    3796 </span><span class="lineNoCov">          0 :     } else if (t == TOK_push_macro) {</span>
<span class="lineNum">    3797 </span><span class="lineNoCov">          0 :         fprintf(fp, &quot;#pragma push_macro(\&quot;%s\&quot;)\n&quot;, vs);</span>
<span class="lineNum">    3798 </span><span class="lineNoCov">          0 :     } else if (t == TOK_pop_macro) {</span>
<span class="lineNum">    3799 </span><span class="lineNoCov">          0 :         fprintf(fp, &quot;#pragma pop_macro(\&quot;%s\&quot;)\n&quot;, vs);</span>
<span class="lineNum">    3800 </span>            :     }
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 :     pp_debug_tok = 0;</span>
<a name="3802"><span class="lineNum">    3802 </span>            : }</a>
<span class="lineNum">    3803 </span>            : 
<span class="lineNum">    3804 </span><span class="lineNoCov">          0 : static void pp_debug_builtins(TCCState *s1)</span>
<span class="lineNum">    3805 </span>            : {
<span class="lineNum">    3806 </span>            :     int v;
<span class="lineNum">    3807 </span><span class="lineNoCov">          0 :     for (v = TOK_IDENT; v &lt; tok_ident; ++v)</span>
<span class="lineNum">    3808 </span><span class="lineNoCov">          0 :         define_print(s1, v);</span>
<span class="lineNum">    3809 </span><span class="lineNoCov">          0 : }</span>
<a name="3810"><span class="lineNum">    3810 </span>            : </a>
<span class="lineNum">    3811 </span>            : /* Add a space between tokens a and b to avoid unwanted textual pasting */
<span class="lineNum">    3812 </span><span class="lineNoCov">          0 : static int pp_need_space(int a, int b)</span>
<span class="lineNum">    3813 </span>            : {
<span class="lineNum">    3814 </span><span class="lineNoCov">          0 :     return 'E' == a ? '+' == b || '-' == b</span>
<span class="lineNum">    3815 </span><span class="lineNoCov">          0 :         : '+' == a ? TOK_INC == b || '+' == b</span>
<span class="lineNum">    3816 </span><span class="lineNoCov">          0 :         : '-' == a ? TOK_DEC == b || '-' == b</span>
<span class="lineNum">    3817 </span><span class="lineNoCov">          0 :         : a &gt;= TOK_IDENT ? b &gt;= TOK_IDENT</span>
<span class="lineNum">    3818 </span><span class="lineNoCov">          0 :         : a == TOK_PPNUM ? b &gt;= TOK_IDENT</span>
<span class="lineNum">    3819 </span><span class="lineNoCov">          0 :         : 0;</span>
<span class="lineNum">    3820 </span>            : }
<a name="3821"><span class="lineNum">    3821 </span>            : </a>
<span class="lineNum">    3822 </span>            : /* maybe hex like 0x1e */
<span class="lineNum">    3823 </span><span class="lineNoCov">          0 : static int pp_check_he0xE(int t, const char *p)</span>
<span class="lineNum">    3824 </span>            : {
<span class="lineNum">    3825 </span><span class="lineNoCov">          0 :     if (t == TOK_PPNUM &amp;&amp; toup(strchr(p, 0)[-1]) == 'E')</span>
<span class="lineNum">    3826 </span><span class="lineNoCov">          0 :         return 'E';</span>
<span class="lineNum">    3827 </span><span class="lineNoCov">          0 :     return t;</span>
<span class="lineNum">    3828 </span>            : }
<a name="3829"><span class="lineNum">    3829 </span>            : </a>
<span class="lineNum">    3830 </span>            : /* Preprocess the current file */
<span class="lineNum">    3831 </span><span class="lineNoCov">          0 : ST_FUNC int tcc_preprocess(TCCState *s1)</span>
<span class="lineNum">    3832 </span>            : {
<span class="lineNum">    3833 </span>            :     BufferedFile **iptr;
<span class="lineNum">    3834 </span>            :     int token_seen, spcs, level;
<span class="lineNum">    3835 </span>            :     const char *p;
<span class="lineNum">    3836 </span>            :     char white[400];
<span class="lineNum">    3837 </span>            : 
<span class="lineNum">    3838 </span><span class="lineNoCov">          0 :     parse_flags = PARSE_FLAG_PREPROCESS</span>
<span class="lineNum">    3839 </span><span class="lineNoCov">          0 :                 | (parse_flags &amp; PARSE_FLAG_ASM_FILE)</span>
<span class="lineNum">    3840 </span>            :                 | PARSE_FLAG_LINEFEED
<span class="lineNum">    3841 </span>            :                 | PARSE_FLAG_SPACES
<span class="lineNum">    3842 </span><span class="lineNoCov">          0 :                 | PARSE_FLAG_ACCEPT_STRAYS</span>
<span class="lineNum">    3843 </span>            :                 ;
<span class="lineNum">    3844 </span>            :     /* Credits to Fabrice Bellard's initial revision to demonstrate its
<span class="lineNum">    3845 </span>            :        capability to compile and run itself, provided all numbers are
<span class="lineNum">    3846 </span>            :        given as decimals. tcc -E -P10 will do. */
<span class="lineNum">    3847 </span><span class="lineNoCov">          0 :     if (s1-&gt;Pflag == LINE_MACRO_OUTPUT_FORMAT_P10)</span>
<span class="lineNum">    3848 </span><span class="lineNoCov">          0 :         parse_flags |= PARSE_FLAG_TOK_NUM, s1-&gt;Pflag = 1;</span>
<span class="lineNum">    3849 </span>            : 
<span class="lineNum">    3850 </span>            : #ifdef PP_BENCH
<span class="lineNum">    3851 </span>            :     /* for PP benchmarks */
<span class="lineNum">    3852 </span>            :     do next(); while (tok != TOK_EOF);
<span class="lineNum">    3853 </span>            :     return 0;
<span class="lineNum">    3854 </span>            : #endif
<span class="lineNum">    3855 </span>            : 
<span class="lineNum">    3856 </span><span class="lineNoCov">          0 :     if (s1-&gt;dflag &amp; 1) {</span>
<span class="lineNum">    3857 </span><span class="lineNoCov">          0 :         pp_debug_builtins(s1);</span>
<span class="lineNum">    3858 </span><span class="lineNoCov">          0 :         s1-&gt;dflag &amp;= ~1;</span>
<span class="lineNum">    3859 </span>            :     }
<span class="lineNum">    3860 </span>            : 
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :     token_seen = TOK_LINEFEED, spcs = 0;</span>
<span class="lineNum">    3862 </span><span class="lineNoCov">          0 :     pp_line(s1, file, 0);</span>
<span class="lineNum">    3863 </span>            :     for (;;) {
<span class="lineNum">    3864 </span><span class="lineNoCov">          0 :         iptr = s1-&gt;include_stack_ptr;</span>
<span class="lineNum">    3865 </span><span class="lineNoCov">          0 :         next();</span>
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :         if (tok == TOK_EOF)</span>
<span class="lineNum">    3867 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    3868 </span>            : 
<span class="lineNum">    3869 </span><span class="lineNoCov">          0 :         level = s1-&gt;include_stack_ptr - iptr;</span>
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 :         if (level) {</span>
<span class="lineNum">    3871 </span><span class="lineNoCov">          0 :             if (level &gt; 0)</span>
<span class="lineNum">    3872 </span><span class="lineNoCov">          0 :                 pp_line(s1, *iptr, 0);</span>
<span class="lineNum">    3873 </span><span class="lineNoCov">          0 :             pp_line(s1, file, level);</span>
<span class="lineNum">    3874 </span>            :         }
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :         if (s1-&gt;dflag &amp; 7) {</span>
<span class="lineNum">    3876 </span><span class="lineNoCov">          0 :             pp_debug_defines(s1);</span>
<span class="lineNum">    3877 </span><span class="lineNoCov">          0 :             if (s1-&gt;dflag &amp; 4)</span>
<span class="lineNum">    3878 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    3879 </span>            :         }
<span class="lineNum">    3880 </span>            : 
<span class="lineNum">    3881 </span><span class="lineNoCov">          0 :         if (is_space(tok)) {</span>
<span class="lineNum">    3882 </span><span class="lineNoCov">          0 :             if (spcs &lt; sizeof white - 1)</span>
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :                 white[spcs++] = tok;</span>
<span class="lineNum">    3884 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    3885 </span><span class="lineNoCov">          0 :         } else if (tok == TOK_LINEFEED) {</span>
<span class="lineNum">    3886 </span><span class="lineNoCov">          0 :             spcs = 0;</span>
<span class="lineNum">    3887 </span><span class="lineNoCov">          0 :             if (token_seen == TOK_LINEFEED)</span>
<span class="lineNum">    3888 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    3889 </span><span class="lineNoCov">          0 :             ++file-&gt;line_ref;</span>
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 :         } else if (token_seen == TOK_LINEFEED) {</span>
<span class="lineNum">    3891 </span><span class="lineNoCov">          0 :             pp_line(s1, file, 0);</span>
<span class="lineNum">    3892 </span><span class="lineNoCov">          0 :         } else if (spcs == 0 &amp;&amp; pp_need_space(token_seen, tok)) {</span>
<span class="lineNum">    3893 </span><span class="lineNoCov">          0 :             white[spcs++] = ' ';</span>
<span class="lineNum">    3894 </span>            :         }
<span class="lineNum">    3895 </span>            : 
<span class="lineNum">    3896 </span><span class="lineNoCov">          0 :         white[spcs] = 0, fputs(white, s1-&gt;ppfp), spcs = 0;</span>
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 :         fputs(p = get_tok_str(tok, &amp;tokc), s1-&gt;ppfp);</span>
<span class="lineNum">    3898 </span><span class="lineNoCov">          0 :         token_seen = pp_check_he0xE(tok, p);</span>
<span class="lineNum">    3899 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    3901 </span>            : }
<span class="lineNum">    3902 </span>            : 
<span class="lineNum">    3903 </span>            : /* ------------------------------------------------------------------------- */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
